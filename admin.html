<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß ÁÆ°ÁêÜËÄÖÁîªÈù¢ - Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        /* Ë™çË®ºÁîªÈù¢ */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .auth-title {
            font-size: 2rem;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #f9f9f9;
            transition: all 0.3s ease;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        .auth-input:focus {
            outline: none;
            border-color: #e74c3c;
            background: white;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }

        .auth-error {
            background: #ffe6e6;
            color: #d63031;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        /* „É°„Ç§„É≥ÁîªÈù¢ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .admin-title {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .logout-btn {
            background: linear-gradient(45deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .usage-display {
            font-size: 2rem;
            font-weight: 700;
            margin: 15px 0;
        }

        .usage-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .usage-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .usage-fill.safe { background: linear-gradient(45deg, #28a745, #20c997); }
        .usage-fill.warning { background: linear-gradient(45deg, #ffc107, #fd7e14); }
        .usage-fill.danger { background: linear-gradient(45deg, #dc3545, #e74c3c); }

        .form-group {
            margin: 20px 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
        }

        .btn.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn.warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .alert-item {
            padding: 12px;
            border-left: 4px solid #007bff;
            background: white;
            border-radius: 0 8px 8px 0;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .alert-item.first { border-left-color: #17a2b8; }
        .alert-item.middle { border-left-color: #ffc107; }
        .alert-item.final { border-left-color: #dc3545; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .admin-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- ÁÆ°ÁêÜËÄÖË™çË®ºÁîªÈù¢ -->
    <div class="auth-screen" id="admin-auth-screen">
        <div class="auth-card">
            <h1 class="auth-title">üîß ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥</h1>
            <div style="margin-bottom: 30px; color: #666;">
                „Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®ÁîªÈù¢„Åß„Åô<br>
                ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </div>
            <form id="admin-auth-form">
                <input 
                    type="password" 
                    id="admin-password" 
                    class="auth-input"
                    placeholder="ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ"
                    required
                />
                <button type="submit" class="auth-btn">
                    üîê ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥
                </button>
            </form>
            <div class="auth-error" id="auth-error">
                ‚ùå „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì
            </div>
            <div style="margin-top: 30px;">
                <a href="pages/marugo.html" style="color: #e74c3c; text-decoration: none;">
                    ‚Üê „É°„Ç§„É≥„Ç∑„Çπ„ÉÜ„É†„Å´Êàª„Çã
                </a>
            </div>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜËÄÖ„É°„Ç§„É≥ÁîªÈù¢ -->
    <div class="container" id="admin-main" style="display: none;">
        <div class="header">
            <h1 class="admin-title">üîß „Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜÁîªÈù¢</h1>
            <button class="logout-btn" onclick="adminLogout()">
                üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà
            </button>
        </div>

        <div class="dashboard-grid">
            <!-- API‰ΩøÁî®ÈáèÁõ£Ë¶ñ -->
            <div class="dashboard-card">
                <h3 class="card-title">üìä API‰ΩøÁî®ÈáèÁõ£Ë¶ñ</h3>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">üìÖ ‰ªäÊó•„ÅÆ‰ΩøÁî®Èáè</div>
                    <div class="usage-display" id="daily-usage">0/300</div>
                    <div class="usage-bar">
                        <div class="usage-fill safe" id="daily-usage-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">üìÜ ‰ªäÊúà„ÅÆ‰ΩøÁî®Èáè</div>
                    <div class="usage-display" id="monthly-usage">0/3,000</div>
                    <div class="usage-bar">
                        <div class="usage-fill safe" id="monthly-usage-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn secondary" onclick="refreshUsageData()">
                        üîÑ ‰ΩøÁî®ÈáèÊõ¥Êñ∞
                    </button>
                    <button class="btn warning" onclick="resetUsageStats()">
                        üóëÔ∏è Áµ±Ë®à„É™„Çª„ÉÉ„Éà
                    </button>
                </div>
            </div>

            <!-- „Éë„Çπ„ÉØ„Éº„ÉâÁÆ°ÁêÜ -->
            <div class="dashboard-card">
                <h3 class="card-title">üîê „Éë„Çπ„ÉØ„Éº„ÉâÁÆ°ÁêÜ</h3>
                
                <div style="margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">üè† „Ç∑„Çπ„ÉÜ„É†„Ç¢„ÇØ„Çª„Çπ„Éë„Çπ„ÉØ„Éº„Éâ</h4>
                    <p style="font-size: 14px; color: #6c757d; margin: 0 0 15px 0;">ÂÖ®„É¶„Éº„Ç∂„Éº„Åå„Ç∑„Çπ„ÉÜ„É†„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„ÇãÈöõ„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ</p>
                    
                    <div class="form-group">
                        <label class="form-label">ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="current-system-password" class="form-input" placeholder="ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="new-system-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•ÂäõÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
                        <input type="password" id="confirm-system-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ">
                    </div>
                    
                    <button onclick="changeSystemPassword()" class="btn">üîÑ „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</button>
                    <button onclick="checkCurrentSystemPassword()" class="btn secondary" style="margin-left: 10px;">üîç ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</button>
                </div>
                
                <div style="margin-bottom: 30px; padding: 15px; background: #fff5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">üîß ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</h4>
                    <p style="font-size: 14px; color: #6c757d; margin: 0 0 15px 0;">„Åì„ÅÆÁÆ°ÁêÜÁîªÈù¢„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„ÇãÈöõ„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ</p>
                    
                    <div class="form-group">
                        <label class="form-label">ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="current-admin-password" class="form-input" placeholder="ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="new-admin-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•ÂäõÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
                        <input type="password" id="confirm-admin-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ">
                    </div>
                    
                    <button onclick="changeAdminPassword()" class="btn" style="background: linear-gradient(45deg, #dc3545, #c82333);">üîß ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</button>
                    <button onclick="checkCurrentAdminPassword()" class="btn secondary" style="margin-left: 10px;">üîç ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</button>
                </div>
                
                <div id="password-change-status" style="margin-top: 15px;"></div>
            </div>

            <!-- „Ç¢„É©„Éº„ÉàË®≠ÂÆö -->
            <div class="dashboard-card">
                <h3 class="card-title">üö® „Ç¢„É©„Éº„ÉàË®≠ÂÆö</h3>
                
                <div class="form-group">
                    <label class="form-label">üìä ÂàùÂõûË≠¶Âëä (‰ª∂Êï∞):</label>
                    <input type="number" id="first-warning-threshold" class="form-input" value="1000" min="1" max="3000">
                </div>

                <div class="form-group">
                    <label class="form-label">‚ö†Ô∏è ‰∏≠ÈñìË≠¶Âëä (‰ª∂Êï∞):</label>
                    <input type="number" id="middle-warning-threshold" class="form-input" value="2000" min="1" max="3000">
                </div>

                <div class="form-group">
                    <label class="form-label">üö® ÊúÄÁµÇË≠¶Âëä (‰ª∂Êï∞):</label>
                    <input type="number" id="final-warning-threshold" class="form-input" value="2800" min="1" max="3000">
                </div>

                <button class="btn" onclick="saveAlertSettings()">
                    üíæ „Ç¢„É©„Éº„ÉàË®≠ÂÆö‰øùÂ≠ò
                </button>

                <div id="alert-settings-status"></div>
            </div>

            <!-- Ë≠¶Âëä„Ç∑„Çπ„ÉÜ„É†Ë™¨Êòé„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü -->

            <!-- „Ç∑„É≥„Éó„É´„Å™API‰ΩøÁî®ÈáèË°®Á§∫ -->
            <div class="dashboard-card">
                <h3 class="card-title">üìä ‰ΩøÁî®Áä∂Ê≥Å</h3>
                
                <div id="simple-usage-display" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 20px;
                    margin-top: 20px;
                ">
                    <div style="color: #6c757d;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>

            <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã -->
            <div class="dashboard-card">
                <h3 class="card-title">‚öôÔ∏è „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</h3>
                
                <div id="system-status-display">
                    <div style="color: #6c757d;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn secondary" onclick="checkSystemStatus()">
                        üîç Áä∂ÊÖãÁ¢∫Ë™ç
                    </button>
                    <button class="btn success" onclick="runSystemOptimization()">
                        ‚ö° ÊúÄÈÅ©ÂåñÂÆüË°å
                    </button>
                </div>
            </div>

            <!-- „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„Å®„ÉÜ„Çπ„ÉàÊ©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü -->
        </div>

        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
            <a href="pages/marugo.html" style="
                color: #e74c3c;
                text-decoration: none;
                font-weight: 600;
                padding: 12px 24px;
                border: 2px solid #e74c3c;
                border-radius: 8px;
                transition: all 0.3s ease;
            ">üìä „É°„Ç§„É≥„Ç∑„Çπ„ÉÜ„É†„Å´Êàª„Çã</a>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/quota-alert-system.js"></script>
    <script src="js/simple-optimization.js"></script>
    
    <script>
        // ÁÆ°ÁêÜËÄÖË™çË®º„Ç∑„Çπ„ÉÜ„É†
        class AdminAuth {
            constructor() {
                this.SESSION_KEY = 'adminSession';
                this.SESSION_DURATION = 2 * 60 * 60 * 1000; // 2ÊôÇÈñì
                
                this.init();
            }

            init() {
                if (this.isAuthenticated()) {
                    this.showAdminPanel();
                } else {
                    this.showAuthScreen();
                }

                this.setupEventListeners();
            }

            setupEventListeners() {
                const authForm = document.getElementById('admin-auth-form');
                if (authForm) {
                    authForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        console.log('üîç ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†ÈÄÅ‰ø°');
                        this.handleAuth();
                    });
                }

                const passwordInput = document.getElementById('admin-password');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            console.log('üîç ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥ Enter„Ç≠„Éº');
                            this.handleAuth();
                        }
                    });
                }
                
                // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÅÆÁõ¥Êé•„ÇØ„É™„ÉÉ„ÇØ„ÇÇÂØæÂøú
                const loginBtn = document.querySelector('.auth-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', (e) => {
                        if (e.target.type !== 'submit') {
                            e.preventDefault();
                            console.log('üîç ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ');
                            this.handleAuth();
                        }
                    });
                }
                
                console.log('üîç ÁÆ°ÁêÜËÄÖË™çË®º„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');
            }

            async handleAuth() {
                const password = document.getElementById('admin-password').value;
                const errorDiv = document.getElementById('auth-error');
                const loginBtn = document.querySelector('.auth-btn');

                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'üîÑ Ë™çË®º‰∏≠...';
                }

                try {
                    // Supabase„ÅßÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®º
                    const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            action: 'verify',
                            passwordType: 'admin',
                            currentPassword: password
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.isValid) {
                        this.setAuthenticated();
                        errorDiv.style.display = 'none';
                        this.showAdminPanel();
                        console.log('‚úÖ ÁÆ°ÁêÜËÄÖË™çË®ºÊàêÂäüÔºàSupabaseÔºâ');
                    } else {
                        errorDiv.style.display = 'block';
                        errorDiv.style.animation = 'shake 0.5s';
                        document.getElementById('admin-password').value = '';
                        
                        setTimeout(() => {
                            errorDiv.style.animation = '';
                        }, 500);
                    }
                } catch (error) {
                    console.error('ÁÆ°ÁêÜËÄÖË™çË®º„Ç®„É©„Éº:', error);
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = '‚ùå Ë™çË®ºÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                }

                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'üîê ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥';
                }
            }

            isAuthenticated() {
                const session = localStorage.getItem(this.SESSION_KEY);
                if (!session) return false;

                try {
                    const data = JSON.parse(session);
                    const now = Date.now();
                    return (now - data.timestamp) < this.SESSION_DURATION;
                } catch {
                    return false;
                }
            }

            setAuthenticated() {
                const sessionData = {
                    timestamp: Date.now(),
                    authenticated: true
                };
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
            }

            showAuthScreen() {
                document.getElementById('admin-auth-screen').style.display = 'flex';
                document.getElementById('admin-main').style.display = 'none';
                
                setTimeout(() => {
                    document.getElementById('admin-password').focus();
                }, 300);
            }

            showAdminPanel() {
                document.getElementById('admin-auth-screen').style.display = 'none';
                document.getElementById('admin-main').style.display = 'block';
                
                // ÁÆ°ÁêÜÁîªÈù¢„ÅÆÂàùÊúüÂåñ
                setTimeout(() => {
                    initializeAdminPanel();
                }, 100);
            }

            logout() {
                localStorage.removeItem(this.SESSION_KEY);
                this.showAuthScreen();
            }
        }

        // ÁÆ°ÁêÜÁîªÈù¢„ÅÆÂàùÊúüÂåñ
        function initializeAdminPanel() {
            loadCurrentSettings();
            checkSystemStatus();
            
            // quota-alert-system„ÅÆÂàùÊúüÂåñ„ÇíÂæÖ„Å£„Å¶„Åã„Çâ‰ΩøÁî®ÈáèË°®Á§∫
            setTimeout(() => {
                loadSimpleUsageDisplay();
                
                // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞Ôºà30Áßí„Åî„Å®Ôºâ
                setInterval(() => {
                    loadSimpleUsageDisplay();
                }, 30000);
            }, 2000); // 2ÁßíÂæÖÊ©ü„Åó„Å¶„Åã„Çâ„Çπ„Çø„Éº„Éà
        }

        // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        function loadCurrentSettings() {
            // „É°„Éº„É´Ê©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü

            // ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Ç¢„É©„Éº„ÉàÈñæÂÄ§„ÇíË™≠„ÅøËæº„Åø
            const savedThresholds = localStorage.getItem('alertThresholds');
            if (savedThresholds) {
                const thresholds = JSON.parse(savedThresholds);
                document.getElementById('first-warning-threshold').value = thresholds.first || 1000;
                document.getElementById('middle-warning-threshold').value = thresholds.middle || 2000;
                document.getElementById('final-warning-threshold').value = thresholds.final || 2800;
            }
        }

        // ‰ΩøÁî®Èáè„Éá„Éº„Çø„ÅÆÊõ¥Êñ∞
        function refreshUsageData() {
            if (typeof window.getQuotaUsage === 'function') {
                const usage = window.getQuotaUsage();
                updateUsageDisplay(usage);
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÁõ¥Êé•ÂèñÂæó
                const today = new Date().toDateString();
                const currentMonth = new Date().toISOString().slice(0, 7);
                
                const dailyStats = JSON.parse(localStorage.getItem('dailyAPIStats') || '{}');
                const monthlyStats = JSON.parse(localStorage.getItem('monthlyAPIStats') || '{}');
                
                const usage = {
                    daily: dailyStats[today] || 0,
                    monthly: monthlyStats[currentMonth] || 0,
                    dailyPercentage: Math.round((dailyStats[today] || 0) / 300 * 100),
                    monthlyPercentage: Math.round((monthlyStats[currentMonth] || 0) / 3000 * 100)
                };
                
                updateUsageDisplay(usage);
            }
        }

        // ‰ΩøÁî®ÈáèË°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateUsageDisplay(usage) {
            // Êó•Ê¨°‰ΩøÁî®Èáè
            document.getElementById('daily-usage').textContent = `${usage.daily}/300`;
            const dailyBar = document.getElementById('daily-usage-bar');
            dailyBar.style.width = `${Math.min(usage.dailyPercentage, 100)}%`;
            dailyBar.className = `usage-fill ${usage.dailyPercentage >= 85 ? 'danger' : usage.dailyPercentage >= 70 ? 'warning' : 'safe'}`;

            // ÊúàÊ¨°‰ΩøÁî®Èáè
            document.getElementById('monthly-usage').textContent = `${usage.monthly}/3,000`;
            const monthlyBar = document.getElementById('monthly-usage-bar');
            monthlyBar.style.width = `${Math.min(usage.monthlyPercentage, 100)}%`;
            monthlyBar.className = `usage-fill ${usage.monthlyPercentage >= 85 ? 'danger' : usage.monthlyPercentage >= 70 ? 'warning' : 'safe'}`;
        }

        // ÁÆ°ÁêÜËÄÖ„É°„Éº„É´„ÅÆ‰øùÂ≠ò
        function saveAdminEmail() {
            const email = document.getElementById('admin-email-input').value;
            const statusDiv = document.getElementById('email-settings-status');

            if (!email) {
                statusDiv.innerHTML = '<div class="status-error">‚ùå „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            if (!email.includes('@') || !email.includes('.')) {
                statusDiv.innerHTML = '<div class="status-error">‚ùå ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò
            localStorage.setItem('adminEmail', email);
            
            // „Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†„Å´„ÇÇË®≠ÂÆö
            if (typeof window.setAdminEmail === 'function') {
                window.setAdminEmail(email);
            }

            statusDiv.innerHTML = '<div class="status-success">‚úÖ ÁÆ°ÁêÜËÄÖ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>';
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Ê©üËÉΩÔºàSupabase„Éô„Éº„ÇπÔºâ
        async function changeSystemPassword() {
            const currentPassword = document.getElementById('current-system-password').value;
            const newPassword = document.getElementById('new-system-password').value;
            const confirmPassword = document.getElementById('confirm-system-password').value;
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordStatus('‚ùå „Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            showPasswordStatus('üîÑ „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥‰∏≠...', 'info');
            
            try {
                // „Åæ„ÅöÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊ§úË®º
                const verifyResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'verify',
                        passwordType: 'system',
                        currentPassword: currentPassword
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('üîç „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®ºÁµêÊûú:', verifyResult);
                console.log('üîç Ê§úË®ºË©≥Á¥∞:', {
                    ÂÖ•Âäõ„Åó„Åü„Éë„Çπ„ÉØ„Éº„Éâ: currentPassword,
                    ÂÖ•ÂäõÂÄ§Èï∑: currentPassword.length,
                    Ê§úË®ºÊàêÂäü: verifyResult.success,
                    „Éë„Çπ„ÉØ„Éº„Éâ‰∏ÄËá¥: verifyResult.isValid,
                    „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±: verifyResult.debug
                });
                
                if (!verifyResult.success || !verifyResult.isValid) {
                    showPasswordStatus(`‚ùå ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì<br>
                        üí° ÂÖ•ÂäõÂÄ§: "${currentPassword}" (Èï∑„Åï: ${currentPassword.length})<br>
                        üí° ÊúüÂæÖÂÄ§: "marugo2024" (Èï∑„Åï: 10)<br>
                        üîç Ê§úË®ºÁµêÊûú: ${JSON.stringify(verifyResult.debug)}`, 'error');
                    return;
                }
                
                // üöÄ Ëá™Âãï„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥
                showPasswordStatus('üîÑ Êñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö‰∏≠...', 'info');
                
                const changeResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'change',
                        passwordType: 'system',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const changeResult = await changeResponse.json();
                console.log('üîÑ „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÁµêÊûú:', changeResult);
                
                if (changeResult.success) {
                    showPasswordStatus('‚úÖ „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÅåËá™Âãï„ÅßÂ§âÊõ¥„Åï„Çå„Åæ„Åó„ÅüÔºÅ', 'success');
                } else {
                    showPasswordStatus(`‚ùå „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Â§±Êïó: ${changeResult.error}`, 'error');
                }
                
                console.log('üîê „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÊåáÁ§∫:', `supabase secrets set SYSTEM_ACCESS_PASSWORD="${newPassword}"`);
                
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('current-system-password').value = '';
                document.getElementById('new-system-password').value = '';
                document.getElementById('confirm-system-password').value = '';
                
            } catch (error) {
                showPasswordStatus('‚ùå „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                console.error('System password change error:', error);
            }
        }
        
        // ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Ê©üËÉΩÔºàSupabase„Éô„Éº„ÇπÔºâ
        async function changeAdminPassword() {
            const currentPassword = document.getElementById('current-admin-password').value;
            const newPassword = document.getElementById('new-admin-password').value;
            const confirmPassword = document.getElementById('confirm-admin-password').value;
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordStatus('‚ùå „Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            showPasswordStatus('üîÑ ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥‰∏≠...', 'info');
            
            try {
                // „Åæ„ÅöÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊ§úË®º
                const verifyResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'verify',
                        passwordType: 'admin',
                        currentPassword: currentPassword
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('üîç ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®ºÁµêÊûú:', verifyResult);
                console.log('üîç Ê§úË®ºË©≥Á¥∞:', {
                    ÂÖ•Âäõ„Åó„Åü„Éë„Çπ„ÉØ„Éº„Éâ: currentPassword,
                    ÂÖ•ÂäõÂÄ§Èï∑: currentPassword.length,
                    Ê§úË®ºÊàêÂäü: verifyResult.success,
                    „Éë„Çπ„ÉØ„Éº„Éâ‰∏ÄËá¥: verifyResult.isValid,
                    „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±: verifyResult.debug
                });
                
                if (!verifyResult.success || !verifyResult.isValid) {
                    showPasswordStatus(`‚ùå ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì<br>
                        üí° ÂÖ•ÂäõÂÄ§: "${currentPassword}" (Èï∑„Åï: ${currentPassword.length})<br>
                        üí° ÊúüÂæÖÂÄ§: "yoshito4411" (Èï∑„Åï: 11)<br>
                        üîç Ê§úË®ºÁµêÊûú: ${JSON.stringify(verifyResult.debug)}`, 'error');
                    return;
                }
                
                // üöÄ Ëá™Âãï„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥
                showPasswordStatus('üîÑ Êñ∞„Åó„ÅÑÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö‰∏≠...', 'info');
                
                const changeResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'change',
                        passwordType: 'admin',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const changeResult = await changeResponse.json();
                console.log('üîÑ ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÁµêÊûú:', changeResult);
                
                if (changeResult.success) {
                    showPasswordStatus('‚úÖ ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåËá™Âãï„ÅßÂ§âÊõ¥„Åï„Çå„Åæ„Åó„ÅüÔºÅ', 'success');
                } else {
                    showPasswordStatus(`‚ùå ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Â§±Êïó: ${changeResult.error}`, 'error');
                }
                
                console.log('üîß ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÊåáÁ§∫:', `supabase secrets set ADMIN_PASSWORD="${newPassword}"`);
                
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('current-admin-password').value = '';
                document.getElementById('new-admin-password').value = '';
                document.getElementById('confirm-admin-password').value = '';
                
            } catch (error) {
                showPasswordStatus('‚ùå ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                console.error('Admin password change error:', error);
            }
        }
        
        // ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
        async function checkCurrentSystemPassword() {
            showPasswordStatus('üîç ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç‰∏≠...', 'info');
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get',
                        passwordType: 'system'
                    })
                });
                
                const result = await response.json();
                console.log('üîç „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å:', result);
                
                showPasswordStatus(`üìã „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å: ${result.passwords?.system || 'Á¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü'}<br>
                    üí° ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ: <strong>marugo2024</strong>ÔºàÂàùÊúüË®≠ÂÆöÂÄ§Ôºâ`, 'info');
                
            } catch (error) {
                console.error('„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                showPasswordStatus('‚ùå „Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
        async function checkCurrentAdminPassword() {
            showPasswordStatus('üîç ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç‰∏≠...', 'info');
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get',
                        passwordType: 'admin'
                    })
                });
                
                const result = await response.json();
                console.log('üîç ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å:', result);
                
                showPasswordStatus(`üìã ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å: ${result.passwords?.admin || 'Á¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü'}<br>
                    üí° ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ: <strong>yoshito4411</strong>ÔºàÂàùÊúüË®≠ÂÆöÂÄ§Ôºâ`, 'info');
                
            } catch (error) {
                console.error('ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                showPasswordStatus('‚ùå ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        function showPasswordStatus(message, type) {
            const statusDiv = document.getElementById('password-change-status');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ3ÁßíÂæå„Å´Ê∂àÂéª
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        // „Ç¢„É©„Éº„ÉàË®≠ÂÆö„ÅÆ‰øùÂ≠ò
        function saveAlertSettings() {
            const settings = {
                first: parseInt(document.getElementById('first-warning-threshold').value),
                middle: parseInt(document.getElementById('middle-warning-threshold').value),
                final: parseInt(document.getElementById('final-warning-threshold').value)
            };

            // Ë®≠ÂÆöÂÄ§„ÅÆÊ§úË®º
            if (settings.first >= settings.middle || settings.middle >= settings.final) {
                document.getElementById('alert-settings-status').innerHTML = 
                    '<div class="status-error">‚ùå Ë≠¶Âëä„É¨„Éô„É´„ÅØÂàùÂõû < ‰∏≠Èñì < ÊúÄÁµÇ „ÅÆÈ†ÜÂ∫è„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            if (settings.final > 3000) {
                document.getElementById('alert-settings-status').innerHTML = 
                    '<div class="status-error">‚ùå ÊúÄÁµÇË≠¶Âëä„ÅØ3000‰ª∂‰ª•‰∏ã„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            // Ë®≠ÂÆö„Çí‰øùÂ≠ò
            localStorage.setItem('alertThresholds', JSON.stringify(settings));
            
            // „Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†„Å´ÂèçÊò†
            if (window.quotaAlertSystem) {
                window.quotaAlertSystem.WARNING_THRESHOLDS.monthly = settings;
            }

            document.getElementById('alert-settings-status').innerHTML = 
                '<div class="status-success">‚úÖ „Ç¢„É©„Éº„ÉàË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>';
            
            setTimeout(() => {
                document.getElementById('alert-settings-status').innerHTML = '';
            }, 3000);
        }

        // „Ç¢„É©„Éº„Éà„ÉÜ„Çπ„Éà
        async function testAlert(level) {
            if (typeof window.testQuotaAlert === 'function') {
                try {
                    await window.testQuotaAlert(level);
                    const levelNames = {
                        'first': 'ÂàùÂõûË≠¶Âëä (1000‰ª∂)',
                        'middle': '‰∏≠ÈñìË≠¶Âëä (2000‰ª∂)',
                        'final': 'ÊúÄÁµÇË≠¶Âëä (2800‰ª∂)'
                    };
                    document.getElementById('alert-test-status').innerHTML = 
                        `<div class="status-success">‚úÖ ${levelNames[level]} „ÅÆ„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü<br>üìä „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠¶Âëä„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü</div>`;
                    
                    setTimeout(() => {
                        document.getElementById('alert-test-status').innerHTML = '';
                    }, 5000);
                } catch (error) {
                    document.getElementById('alert-test-status').innerHTML = 
                        `<div class="status-error">‚ùå „ÉÜ„Çπ„Éà„Ç®„É©„Éº: ${error.message}</div>`;
                }
            } else {
                alert('„Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        }

        // „É°„Éº„É´ÈÄöÁü•„ÉÜ„Çπ„Éà
        async function testEmailNotification() {
            const email = document.getElementById('admin-email-input').value;
            if (!email) {
                document.getElementById('email-settings-status').innerHTML = 
                    '<div class="status-error">‚ùå „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            try {
                // „ÉÜ„Çπ„ÉàÁî®„ÅÆ„É°„Éº„É´„Éá„Éº„Çø
                const testEmailData = {
                    to: email,
                    subject: 'üß™ „ÉÜ„Çπ„ÉàÈÄÅ‰ø° - Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† „Ç¢„É©„Éº„ÉàÊ©üËÉΩ',
                    body: `
Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† „Ç¢„É©„Éº„ÉàÊ©üËÉΩ „ÉÜ„Çπ„ÉàÈÄÅ‰ø°

„ÄêÈÄÅ‰ø°ÊôÇÂàª„Äë: ${new Date().toLocaleString('ja-JP')}
„ÄêÈÄÅ‰ø°ÂÖÉ„Äë: ÁÆ°ÁêÜËÄÖÁîªÈù¢„ÉÜ„Çπ„ÉàÊ©üËÉΩ

„Åì„ÅÆ„É°„Éº„É´„ÅØ„ÄÅ„Ç¢„É©„Éº„ÉàÊ©üËÉΩ„ÅÆÂãï‰ΩúÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅ„Å´ÈÄÅ‰ø°„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

ÂÆüÈöõ„ÅÆ„Ç¢„É©„Éº„ÉàÁô∫ÁîüÊôÇ„Å´„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Åæ„Åô:
- API‰ΩøÁî®Èáè„ÅÆË©≥Á¥∞
- „Ç¢„É©„Éº„Éà„É¨„Éô„É´
- Êé®Â•®ÂØæÂøú
- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† ÁÆ°ÁêÜËÄÖÁîªÈù¢
„ÉÜ„Çπ„ÉàÈÄÅ‰ø°Ê©üËÉΩ„Çà„Çä
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    `,
                    priority: 'normal'
                };

                // Supabase FunctionÁµåÁî±„Åß„É°„Éº„É´ÈÄÅ‰ø°
                const response = await fetch(`${SUPABASE_CONFIG.url}/functions/v1/send-alert-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify(testEmailData)
                });

                if (response.ok) {
                    document.getElementById('email-settings-status').innerHTML = 
                        '<div class="status-success">‚úÖ „ÉÜ„Çπ„Éà„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü</div>';
                } else {
                    throw new Error(`„É°„Éº„É´ÈÄÅ‰ø°„Ç®„É©„Éº: ${response.status}`);
                }
            } catch (error) {
                console.error('„ÉÜ„Çπ„Éà„É°„Éº„É´ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                document.getElementById('email-settings-status').innerHTML = 
                    '<div class="status-warning">‚ö†Ô∏è „ÉÜ„Çπ„Éà„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàÈñãÁô∫Áí∞Â¢É„Åß„ÅØ„É≠„Ç∞Âá∫Âäõ„ÅÆ„ÅøÔºâ</div>';
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÁ¢∫Ë™ç
        function checkSystemStatus() {
            const status = {
                'ConfigË™≠„ÅøËæº„Åø': typeof window.SUPABASE_CONFIG !== 'undefined',
                'APIÈñ¢Êï∞': typeof window.callSheetsAPI === 'function',
                'ÊúÄÈÅ©Âåñ„Ç∑„Çπ„ÉÜ„É†': typeof window.simpleOptimization !== 'undefined',
                '„Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†': typeof window.quotaAlertSystem !== 'undefined'
            };

            let html = '<div style="display: grid; gap: 10px;">';
            let allOK = true;

            Object.entries(status).forEach(([name, ok]) => {
                const statusText = ok ? '‚úÖ Ê≠£Â∏∏' : '‚ùå „Ç®„É©„Éº';
                const statusClass = ok ? 'status-success' : 'status-error';
                html += `<div class="${statusClass}" style="padding: 8px; font-size: 14px;">${name}: ${statusText}</div>`;
                
                if (!ok) allOK = false;
            });

            if (allOK) {
                html += '<div class="status-success" style="padding: 8px; font-weight: 600;">üéâ „Åô„Åπ„Å¶„ÅÆ„Ç∑„Çπ„ÉÜ„É†„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô</div>';
            }

            html += '</div>';
            document.getElementById('system-status-display').innerHTML = html;
        }

        // „Ç∑„Çπ„ÉÜ„É†ÊúÄÈÅ©Âåñ„ÅÆÂÆüË°å
        async function runSystemOptimization() {
            try {
                if (typeof window.testSimpleOptimization === 'function') {
                    await window.testSimpleOptimization();
                }
                
                document.getElementById('system-status-display').innerHTML += 
                    '<div class="status-success" style="margin-top: 10px;">‚ö° „Ç∑„Çπ„ÉÜ„É†ÊúÄÈÅ©Âåñ„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü</div>';
            } catch (error) {
                document.getElementById('system-status-display').innerHTML += 
                    '<div class="status-error" style="margin-top: 10px;">‚ùå ÊúÄÈÅ©ÂåñÂÆüË°å„Ç®„É©„Éº: ' + error.message + '</div>';
            }
        }

        // ‰ΩøÁî®ÈáèÁµ±Ë®à„ÅÆ„É™„Çª„ÉÉ„Éà
        function resetUsageStats() {
            if (confirm('‰ΩøÁî®ÈáèÁµ±Ë®à„Çí„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÇÇÂê´„ÇÅ„Å¶„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„ÅôÔºâ')) {
                localStorage.removeItem('dailyAPIStats');
                localStorage.removeItem('monthlyAPIStats');
                localStorage.removeItem('alertHistory');
                localStorage.removeItem('simpleOptimizationStats');
                
                alert('üóëÔ∏è ‰ΩøÁî®ÈáèÁµ±Ë®à„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
                refreshUsageData();
            }
        }

        // „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø
        function loadAlertHistory() {
            const history = JSON.parse(localStorage.getItem('alertHistory') || '[]');
            const historyDiv = document.getElementById('alert-history-display');

            if (history.length === 0) {
                historyDiv.innerHTML = '<div style="color: #6c757d; text-align: center;">üì≠ „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            let html = '';
            history.slice(0, 20).forEach(alert => {
                const date = new Date(alert.timestamp).toLocaleString('ja-JP');
                const levelClass = alert.level.includes('first') ? 'first' : 
                                 alert.level.includes('middle') ? 'middle' : 'final';
                const icon = levelClass === 'first' ? 'üìä' : 
                           levelClass === 'middle' ? '‚ö†Ô∏è' : 'üö®';
                
                html += `
                    <div class="alert-item ${levelClass}">
                        <div style="font-weight: 600;">${icon} ${alert.level.replace('_', ' ').toUpperCase()}</div>
                        <div style="font-size: 14px; color: #6c757d;">${date}</div>
                        <div style="margin-top: 5px;">
                            ÊúàÈñì‰ΩøÁî®Èáè: ${alert.usage.monthly}‰ª∂ (${alert.usage.monthlyPercentage}%)
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = html;
        }

        // „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅÆ„ÇØ„É™„Ç¢
        function clearAlertHistory() {
            if (confirm('„Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem('alertHistory');
                document.getElementById('alert-history-display').innerHTML = 
                    '<div style="color: #6c757d; text-align: center;">üì≠ „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                alert('üóëÔ∏è „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            }
        }

        // ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç¢„Ç¶„Éà
        function adminLogout() {
            if (confirm('ÁÆ°ÁêÜËÄÖÁîªÈù¢„Åã„Çâ„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                window.adminAuth.logout();
            }
        }

        // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleDebugMode() {
            const currentMode = window._debugMode || false;
            window._debugMode = !currentMode;
            
            const status = window._debugMode ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ';
            const color = window._debugMode ? '#28a745' : '#6c757d';
            
            alert(`üîß „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ${status}\n\nË©≥Á¥∞„Å™APIÂëº„Å≥Âá∫„Åó„É≠„Ç∞„Åå${status}„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ`);
            
            // „Éú„Çø„É≥„ÅÆËâ≤„ÇíÂ§âÊõ¥
            const debugBtn = event.target;
            debugBtn.style.background = color;
            debugBtn.textContent = `üîß „Éá„Éê„ÉÉ„Ç∞${window._debugMode ? 'ON' : 'OFF'}`;
            
            console.log(`üîß „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ${status}`);
        }

        // ‰ΩøÁî®Èáè„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÈñ¢Êï∞„ÅØÁ∞°Á¥†Âåñ„Åï„Çå„Åæ„Åó„Åü

        // „Ç∑„É≥„Éó„É´„Å™API‰ΩøÁî®ÈáèË°®Á§∫Ôºàquota-alert-system„Å®ÂêåÊúüÔºâ
        function loadSimpleUsageDisplay() {
            try {
                let usage;
                
                // quota-alert-system„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅØ‰ΩøÁî®
                if (window.quotaAlertSystem) {
                    usage = window.quotaAlertSystem.getCurrentUsage();
                    console.log('üìä quota-alert-system„Åã„Çâ‰ΩøÁî®Èáè„ÇíÂèñÂæó:', usage);
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Áõ¥Êé•localStorageË™≠„ÅøËæº„Åø
                    const today = new Date().toDateString();
                    const currentMonth = new Date().toISOString().slice(0, 7);

                    const dailyStats = JSON.parse(localStorage.getItem('dailyAPIStats') || '{}');
                    const monthlyStats = JSON.parse(localStorage.getItem('monthlyAPIStats') || '{}');
                    const totalStats = JSON.parse(localStorage.getItem('totalAPIStats') || '{"total": 0}');

                    usage = {
                        daily: dailyStats[today] || 0,
                        monthly: monthlyStats[currentMonth] || 0,
                        total: totalStats.total || 0
                    };
                    console.log('üìä „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Åß‰ΩøÁî®Èáè„ÇíÂèñÂæó:', usage);
                }

                const display = document.getElementById('simple-usage-display');
                display.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${usage.daily}</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">Êú¨Êó•Á¥ØË®à / 300</div>
                    </div>

                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${usage.monthly}</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">‰ªäÊúàÁ¥ØË®à / 3,000</div>
                    </div>

                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${(usage.total || 0).toLocaleString()}</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">Á∑èÁ¥ØË®à</div>
                    </div>
                `;
            } catch (error) {
                console.error('‰ΩøÁî®ÈáèË°®Á§∫„Ç®„É©„Éº:', error);
                const display = document.getElementById('simple-usage-display');
                display.innerHTML = '<div style="color: #dc3545;">‚ùå ‰ΩøÁî®Èáè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // CSS „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            window.adminAuth = new AdminAuth();
        });
    </script>
</body>
</html>
