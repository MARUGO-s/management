<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß ÁÆ°ÁêÜËÄÖÁîªÈù¢ - Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            background: radial-gradient(circle at 30% 20%, rgba(60, 90, 160, 0.3) 0%, rgba(22, 26, 38, 0.92) 70%);
            min-height: 100vh;
            padding: clamp(24px, 5vw, 48px);
            color: #1e293b;
        }

        .app-shell {
            display: grid;
            grid-template-columns: minmax(240px, 280px) 1fr;
            gap: 32px;
            align-items: start;
            transition: grid-template-columns 0.25s ease;
        }

        .app-shell.nav-collapsed {
            grid-template-columns: 0px 1fr;
        }

        .app-shell.nav-collapsed .sidebar {
            transform: translateX(-120%);
            opacity: 0;
            pointer-events: none;
        }

        .sidebar {
            transform: translateX(0);
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .sidebar {
            background: rgba(238, 241, 249, 0.94);
            border-radius: 24px;
            border: 1px solid rgba(28, 36, 52, 0.14);
            padding: 28px 24px;
            box-shadow: 0 28px 50px rgba(14, 20, 36, 0.22);
            position: sticky;
            top: clamp(24px, 5vw, 48px);
            height: fit-content;
            display: grid;
            gap: 28px;
        }

        .sidebar h2 {
            font-size: 1.1rem;
            letter-spacing: 0.12em;
            color: #1f2a3d;
        }

        .sidebar p {
            font-size: 13px;
            color: rgba(31, 42, 61, 0.62);
            line-height: 1.5;
        }

        .nav-section {
            display: grid;
            gap: 12px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid transparent;
            color: rgba(31, 42, 61, 0.75);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            border-color: rgba(60, 110, 232, 0.3);
            background: rgba(60, 110, 232, 0.12);
            color: #3c6ee8;
        }

        .nav-link.subtle {
            font-weight: 500;
            color: rgba(31, 42, 61, 0.55);
        }

        .main-view {
            background: rgba(244, 247, 254, 0.94);
            border-radius: 28px;
            border: 1px solid rgba(28, 36, 52, 0.14);
            box-shadow: 0 32px 60px rgba(14, 20, 36, 0.22);
            padding: clamp(28px, 4vw, 40px);
            display: grid;
            gap: 32px;
        }

        /* Ë™çË®ºÁîªÈù¢ */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: radial-gradient(circle at 30% 20%, rgba(60, 90, 160, 0.35) 0%, rgba(22, 26, 38, 0.94) 70%);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
            padding: 24px;
        }

        .auth-card {
            background: rgba(244, 247, 254, 0.95);
            border-radius: 24px;
            padding: clamp(32px, 4vw, 44px);
            box-shadow: 0 30px 60px rgba(14, 20, 36, 0.3);
            max-width: 420px;
            width: min(420px, 100%);
            backdrop-filter: blur(24px);
            text-align: center;
            border: 1px solid rgba(30, 45, 78, 0.14);
        }

        .auth-title {
            font-size: 2rem;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .auth-input {
            width: 100%;
            padding: 14px;
            border: 2px solid rgba(60, 90, 160, 0.2);
            border-radius: 14px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        .auth-input:focus {
            outline: none;
            border-color: rgba(60, 90, 160, 0.55);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(76, 130, 255, 0.18);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 16px 24px rgba(60, 110, 232, 0.25);
        }

        .auth-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 32px rgba(60, 110, 232, 0.3);
        }

        .auth-error {
            background: rgba(214, 69, 65, 0.18);
            color: #d64541;
            padding: 12px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        /* „É°„Ç§„É≥ÁîªÈù¢ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(30, 45, 78, 0.14);
        }

        .admin-title {
            font-size: 2.5rem;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .main-subtitle {
            margin-top: 6px;
            color: rgba(31, 42, 61, 0.62);
            font-size: 14px;
        }

        .main-subtitle {
            margin-top: 6px;
            color: rgba(31, 42, 61, 0.62);
            font-size: 14px;
        }

        .logout-btn {
            background: linear-gradient(120deg, #64748b, #475569);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(71, 85, 105, 0.25);
        }

        .nav-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(60, 90, 160, 0.16);
            color: #3c6ee8;
            border: 1px solid rgba(60, 110, 232, 0.25);
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-toggle:hover {
            background: rgba(60, 90, 160, 0.22);
            box-shadow: 0 12px 20px rgba(60, 110, 232, 0.18);
        }

        .nav-toggle.active {
            background: rgba(60, 110, 232, 0.24);
            color: #fff;
        }

        .dashboard-section {
            display: grid;
            gap: 24px;
        }

        .section-heading {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2a3d;
        }

        .section-description {
            font-size: 14px;
            color: rgba(31, 42, 61, 0.62);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        .dashboard-card {
            background: rgba(235, 239, 247, 0.95);
            border-radius: 18px;
            padding: clamp(22px, 3vw, 28px);
            box-shadow: 0 18px 32px rgba(14, 20, 36, 0.18);
            border: 1px solid rgba(28, 36, 52, 0.12);
            transition: all 0.3s ease;
            scroll-margin-top: 120px;
        }

        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 26px 40px rgba(14, 20, 36, 0.22);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .usage-display {
            font-size: 2rem;
            font-weight: 700;
            margin: 15px 0;
        }

        .usage-bar {
            width: 100%;
            height: 18px;
            background: rgba(60, 90, 160, 0.12);
            border-radius: 999px;
            overflow: hidden;
            margin: 15px 0;
        }

        .usage-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 999px;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
        }

        .usage-fill.safe { background: linear-gradient(120deg, #2bb67a, #22c1a5); }
        .usage-fill.warning { background: linear-gradient(120deg, #f6b93b, #f08a24); }
        .usage-fill.danger { background: linear-gradient(120deg, #d64541, #ef5f5f); }

        .form-group {
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1f2a3d;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(60, 90, 160, 0.2);
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.92);
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(60, 90, 160, 0.6);
            box-shadow: 0 0 0 3px rgba(60, 110, 232, 0.18);
        }

        .btn {
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 12px 24px rgba(60, 110, 232, 0.25);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(60, 110, 232, 0.28);
        }

        .btn.secondary {
            background: linear-gradient(120deg, #94a3b8, #64748b);
            box-shadow: 0 12px 24px rgba(100, 116, 139, 0.2);
        }

        .btn.success {
            background: linear-gradient(120deg, #2bb67a, #22c1a5);
            box-shadow: 0 12px 24px rgba(34, 193, 165, 0.24);
        }

        .btn.warning {
            background: linear-gradient(120deg, #f6b93b, #f08a24);
            box-shadow: 0 12px 24px rgba(240, 138, 36, 0.22);
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: rgba(43, 182, 122, 0.15);
            color: #1f513b;
            border: 1px solid rgba(43, 182, 122, 0.3);
        }

        .status-error {
            background: rgba(214, 69, 65, 0.15);
            color: #7c1f1c;
            border: 1px solid rgba(214, 69, 65, 0.28);
        }

        .status-warning {
            background: rgba(246, 185, 59, 0.16);
            color: #7a5200;
            border: 1px solid rgba(246, 185, 59, 0.28);
        }

        .status-info {
            background: rgba(68, 104, 185, 0.14);
            color: #1f2f5c;
            border: 1px solid rgba(68, 104, 185, 0.28);
        }

        .alert-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(28, 36, 52, 0.14);
            border-radius: 12px;
            padding: 18px;
            background: rgba(244, 247, 254, 0.9);
            box-shadow: inset 0 12px 24px rgba(14, 20, 36, 0.06);
        }

        .alert-item {
            padding: 14px 18px;
            border-left: 4px solid #3c6ee8;
            background: rgba(255, 255, 255, 0.94);
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 10px 22px rgba(14, 20, 36, 0.14);
        }

        .alert-item.first { border-left-color: #44bbaa; }
        .alert-item.middle { border-left-color: #f6b93b; }
        .alert-item.final { border-left-color: #d64541; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 1080px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .admin-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- ÁÆ°ÁêÜËÄÖË™çË®ºÁîªÈù¢ -->
    <div class="auth-screen" id="admin-auth-screen">
        <div class="auth-card">
            <h1 class="auth-title">üîß ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥</h1>
            <div style="margin-bottom: 30px; color: rgba(30, 41, 59, 0.65);">
                „Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®ÁîªÈù¢„Åß„Åô<br>
                ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </div>
            <form id="admin-auth-form">
                <input 
                    type="password" 
                    id="admin-password" 
                    class="auth-input"
                    placeholder="ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ"
                    required
                />
                <button type="submit" class="auth-btn">
                    üîê ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥
                </button>
            </form>
            <div class="auth-error" id="auth-error">
                ‚ùå „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì
            </div>
            <div style="margin-top: 30px;">
                <a href="pages/marugo.html" style="color: #3c6ee8; text-decoration: none;">
                    ‚Üê „É°„Ç§„É≥„Ç∑„Çπ„ÉÜ„É†„Å´Êàª„Çã
                </a>
            </div>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜËÄÖ„É°„Ç§„É≥ÁîªÈù¢ -->
    <div class="app-shell" id="admin-main" style="display: none;">
        <aside class="sidebar">
            <div>
                <h2>MARUGO ÁÆ°ÁêÜ</h2>
                <p>ÈÅãÁî®Áä∂Ê≥Å„Å®Ë®≠ÂÆö„Çí„Åæ„Å®„ÇÅ„Å¶ÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ</p>
            </div>
            <nav class="nav-section">
                <a class="nav-link" href="#card-usage">üìä ‰ΩøÁî®Èáè„Çµ„Éû„É™</a>
                <a class="nav-link" href="#card-limit">‚öôÔ∏è ‰∏äÈôêË®≠ÂÆö</a>
                <a class="nav-link" href="#card-indicator">üé® „Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº</a>
                <a class="nav-link" href="#card-alerts">üö® „Ç¢„É©„Éº„ÉàË®≠ÂÆö</a>
                <a class="nav-link" href="#card-password">üîê „Éë„Çπ„ÉØ„Éº„ÉâÁÆ°ÁêÜ</a>
                <a class="nav-link" href="#card-chart">üìà ÊúàÊ¨°„Ç∞„É©„Éï</a>
                <a class="nav-link" href="#card-system">üß≠ „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</a>
            </nav>
            <div class="nav-section">
                <a class="nav-link subtle" href="pages/marugo.html">‚Üê „É°„Ç§„É≥„Å´Êàª„Çã</a>
            </div>
        </aside>
        <div class="main-view">
        <div class="header">
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="nav-toggle" id="nav-toggle" type="button" aria-label="„Çµ„Ç§„Éâ„Éê„ÉºÂàáÊõø" aria-expanded="true">‚ò∞</button>
                <div>
                    <h1 class="admin-title">üîß „Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜÁîªÈù¢</h1>
                    <p class="main-subtitle">API ‰ΩøÁî®Èáè„Å®„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö„Çí‰∏ÄÂÖÉÁÆ°ÁêÜ</p>
                </div>
            </div>
            <button class="logout-btn" onclick="adminLogout()">
                üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà
            </button>
        </div>

        <section class="dashboard-section" id="section-overview">
            <h2 class="section-heading">üìä ‰ΩøÁî®Èáè„Çµ„Éû„É™</h2>
            <p class="section-description">Êó•Ê¨°„ÉªÊúàÊ¨°„ÅÆÂà©Áî®Áä∂Ê≥Å„Å®Á´ØÊú´Âà•„ÅÆÊ¶ÇË¶Å„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="dashboard-grid">
            <!-- API‰ΩøÁî®ÈáèÁõ£Ë¶ñ -->
            <div class="dashboard-card" id="card-usage">
                <h3 class="card-title">üìä API‰ΩøÁî®ÈáèÁõ£Ë¶ñ</h3>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">üìÖ ‰ªäÊó•„ÅÆ‰ΩøÁî®Èáè</div>
                    <div class="usage-display" id="daily-usage">0/300</div>
                    <div class="usage-bar">
                        <div class="usage-fill safe" id="daily-usage-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">üìÜ ‰ªäÊúà„ÅÆ‰ΩøÁî®Èáè</div>
                    <div class="usage-display" id="monthly-usage">0/3,000</div>
                    <div class="usage-bar">
                        <div class="usage-fill safe" id="monthly-usage-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn secondary" onclick="refreshUsageData()">
                        üîÑ ‰ΩøÁî®ÈáèÊõ¥Êñ∞
                    </button>
                    <button class="btn warning" onclick="resetUsageStats()">
                        üóëÔ∏è Áµ±Ë®à„É™„Çª„ÉÉ„Éà
                    </button>
                </div>
            </div>

            <!-- „Ç∑„É≥„Éó„É´„Å™API‰ΩøÁî®ÈáèË°®Á§∫ -->
            <div class="dashboard-card" id="card-simple">
                <h3 class="card-title">üìä ‰ΩøÁî®Áä∂Ê≥Å</h3>
                
                <div id="simple-usage-display" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 20px;
                    margin-top: 20px;
                ">
                    <div style="color: rgba(31, 42, 61, 0.55);">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>

            </div>
        </section>

        <section class="dashboard-section" id="section-settings">
            <h2 class="section-heading">‚öôÔ∏è ‰∏äÈôê„Å®„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº</h2>
            <p class="section-description">API ‰ΩøÁî®Èáè„ÅÆÈñæÂÄ§„ÇÑ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫„ÇíË™øÊï¥„Åó„Åæ„Åô„ÄÇ</p>
            <div class="dashboard-grid">
            <!-- API‰ΩøÁî®Èáè‰∏äÈôêË®≠ÂÆö -->
            <div class="dashboard-card" id="card-limit">
                <h3 class="card-title">üö´ API‰ΩøÁî®Èáè‰∏äÈôêË®≠ÂÆö</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(246, 185, 59, 0.2); border-radius: 8px; border-left: 4px solid #f6b93b;">
                    <p style="font-size: 14px; color: #856404; margin: 0 0 15px 0;">
                        ÊúàÈñìAPI‰ΩøÁî®Èáè„ÅÆ‰∏äÈôêÂÄ§„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÂÄ§„ÇíË∂Ö„Åà„Çã„Å®API„Ç¢„ÇØ„Çª„Çπ„ÅåËá™ÂãïÁöÑ„Å´ÈÅÆÊñ≠„Åï„Çå„Åæ„Åô„ÄÇ
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">üìä ÊúàÈñìAPI‰ΩøÁî®Èáè‰∏äÈôêÔºàÂõûÊï∞Ôºâ</label>
                        <input type="number" id="api-limit" class="form-input" placeholder="2500" min="100" max="10000" step="100">
                        <small style="color: rgba(31, 42, 61, 0.55);">Êé®Â•®ÂÄ§: 2,500Âõû (Google Sheets APIÁÑ°ÊñôÊû†„ÅÆÁ¥Ñ83%)</small>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="saveAPILimitSettings()" class="btn">üíæ ‰∏äÈôêÂÄ§„Çí‰øùÂ≠ò</button>
                        <button onclick="loadAPILimitSettings()" class="btn secondary">üîÑ Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø</button>
                        <button onclick="resetAPILimitSettings()" class="btn secondary">üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
                    </div>
                </div>
                
                <div style="background: rgba(214, 69, 65, 0.15); padding: 15px; border-radius: 10px; border-left: 4px solid #d64541;">
                    <h4 style="margin: 0 0 10px 0; color: #721c24;">‚ö†Ô∏è ÈáçË¶Å„Å™Ê≥®ÊÑè‰∫ãÈ†Ö</h4>
                    <ul style="margin: 0; color: #721c24; font-size: 14px;">
                        <li>‰∏äÈôêÂÄ§„Çí‰∏ã„Åí„Çã„Å®„ÄÅÁèæÂú®„ÅÆ‰ΩøÁî®Èáè„Åå‰∏äÈôê„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´ÈÅÆÊñ≠„Åï„Çå„Åæ„Åô</li>
                        <li>Google Sheets APIÁÑ°ÊñôÊû†„ÅØÊúàÈñì3,000Âõû„Åß„Åô</li>
                        <li>ÂÆâÂÖ®„Éû„Éº„Ç∏„É≥„ÇíËÄÉÊÖÆ„Åó„Å¶2,500ÂõûÁ®ãÂ∫¶„Å´Ë®≠ÂÆö„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô</li>
                    </ul>
                </div>
                
                <div id="limit-status" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0;">üìä ÁèæÂú®„ÅÆË®≠ÂÆöÁä∂Ê≥Å</h4>
                    <div id="limit-status-content">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>

            <!-- ‰ΩøÁî®Èáè„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË®≠ÂÆö -->
            <div class="dashboard-card" id="card-indicator">
                <h3 class="card-title">üé® ‰ΩøÁî®Èáè„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºËâ≤Ë®≠ÂÆö</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(244, 247, 254, 0.9); border-radius: 8px;">
                    <p style="font-size: 14px; color: rgba(31, 42, 61, 0.55); margin: 0 0 15px 0;">
                        ÂÖ®„Éö„Éº„Ç∏„Å´Ë°®Á§∫„Åï„Çå„Çã‰ΩøÁî®Èáè„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆËâ≤Â§âÂåñ„ÅÆÈñæÂÄ§„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">üü¢ Á∑ëËâ≤„ÅÆÈñæÂÄ§ÔºàÂõûÊï∞Ôºâ</label>
                        <input type="number" id="orange-threshold" class="form-input" placeholder="900" min="1" max="3000">
                        <small style="color: rgba(31, 42, 61, 0.55);">„Åì„ÅÆÂõûÊï∞‰ª•‰∏ä„ÅßÁ∑ëËâ≤„Å´Â§âÂåñ</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üü° ÈªÑËâ≤„ÅÆÈñæÂÄ§ÔºàÂõûÊï∞Ôºâ</label>
                        <input type="number" id="yellow-threshold" class="form-input" placeholder="1500" min="1" max="3000">
                        <small style="color: rgba(31, 42, 61, 0.55);">„Åì„ÅÆÂõûÊï∞‰ª•‰∏ä„ÅßÈªÑËâ≤„Å´Â§âÂåñ</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üî¥ Ëµ§Ëâ≤„ÅÆÈñæÂÄ§ÔºàÂõûÊï∞Ôºâ</label>
                        <input type="number" id="red-threshold" class="form-input" placeholder="2400" min="1" max="3000">
                        <small style="color: rgba(31, 42, 61, 0.55);">„Åì„ÅÆÂõûÊï∞‰ª•‰∏ä„ÅßËµ§Ëâ≤„Å´Â§âÂåñ</small>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="saveIndicatorSettings()" class="btn">üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                        <button onclick="loadIndicatorSettings()" class="btn secondary">üîÑ Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø</button>
                        <button onclick="resetIndicatorSettings()" class="btn secondary">üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0;">üìä ÁèæÂú®„ÅÆË®≠ÂÆö„Éó„É¨„Éì„É•„Éº</h4>
                    <div id="indicator-preview" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <!-- „Éó„É¨„Éì„É•„Éº„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>

            </div>
        </section>

        <section class="dashboard-section" id="section-alerts">
            <h2 class="section-heading">üö® „Ç¢„É©„Éº„ÉàË®≠ÂÆö</h2>
            <p class="section-description">ÈÄöÁü•„ÇÑÈñæÂÄ§„ÇíË™øÊï¥„Åó„ÄÅ‰∏äÈôêÂà∞ÈÅîÊôÇ„ÅÆÂØæÂøú„ÇíÂÆöÁæ©„Åó„Åæ„Åô„ÄÇ</p>
            <div class="dashboard-grid">
            <!-- „Ç¢„É©„Éº„ÉàË®≠ÂÆö -->
            <div class="dashboard-card" id="card-alerts">
                <h3 class="card-title">üö® „Ç¢„É©„Éº„ÉàË®≠ÂÆö</h3>
                
                <div class="form-group">
                    <label class="form-label">üìä ÂàùÂõûË≠¶Âëä (‰ª∂Êï∞):</label>
                    <input type="number" id="first-warning-threshold" class="form-input" value="1000" min="1" max="3000">
                </div>

                <div class="form-group">
                    <label class="form-label">‚ö†Ô∏è ‰∏≠ÈñìË≠¶Âëä (‰ª∂Êï∞):</label>
                    <input type="number" id="middle-warning-threshold" class="form-input" value="2000" min="1" max="3000">
                </div>

                <div class="form-group">
                    <label class="form-label">üö® ÊúÄÁµÇË≠¶Âëä (‰ª∂Êï∞):</label>
                    <input type="number" id="final-warning-threshold" class="form-input" value="2800" min="1" max="3000">
                </div>

                <button class="btn" onclick="saveAlertSettings()">
                    üíæ „Ç¢„É©„Éº„ÉàË®≠ÂÆö‰øùÂ≠ò
                </button>

                <div id="alert-settings-status"></div>
            </div>

            <!-- Ë≠¶Âëä„Ç∑„Çπ„ÉÜ„É†Ë™¨Êòé„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü -->

            </div>
        </section>

        <section class="dashboard-section" id="section-security">
            <h2 class="section-heading">üîê „Éë„Çπ„ÉØ„Éº„ÉâÁÆ°ÁêÜ</h2>
            <p class="section-description">„Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„Å®ÁÆ°ÁêÜÁîªÈù¢„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÆâÂÖ®„Å´Êõ¥Êñ∞„Åó„Åæ„Åô„ÄÇ</p>
            <div class="dashboard-grid">
            <!-- „Éë„Çπ„ÉØ„Éº„ÉâÁÆ°ÁêÜ -->
            <div class="dashboard-card" id="card-password">
                <h3 class="card-title">üîê „Éë„Çπ„ÉØ„Éº„ÉâÁÆ°ÁêÜ</h3>
                
                <div style="margin-bottom: 30px; padding: 15px; background: rgba(244, 247, 254, 0.9); border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">üè† „Ç∑„Çπ„ÉÜ„É†„Ç¢„ÇØ„Çª„Çπ„Éë„Çπ„ÉØ„Éº„Éâ</h4>
                    <p style="font-size: 14px; color: rgba(31, 42, 61, 0.55); margin: 0 0 15px 0;">ÂÖ®„É¶„Éº„Ç∂„Éº„Åå„Ç∑„Çπ„ÉÜ„É†„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„ÇãÈöõ„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ</p>
                    
                    <div class="form-group">
                        <label class="form-label">ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="current-system-password" class="form-input" placeholder="ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="new-system-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•ÂäõÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
                        <input type="password" id="confirm-system-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ">
                    </div>
                    
                    <button onclick="changeSystemPassword()" class="btn">üîÑ „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</button>
                    <button onclick="checkCurrentSystemPassword()" class="btn secondary" style="margin-left: 10px;">üîç ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</button>
                </div>
                
                <div style="margin-bottom: 30px; padding: 15px; background: #fff5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">üîß ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</h4>
                    <p style="font-size: 14px; color: rgba(31, 42, 61, 0.55); margin: 0 0 15px 0;">„Åì„ÅÆÁÆ°ÁêÜÁîªÈù¢„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„ÇãÈöõ„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ</p>
                    
                    <div class="form-group">
                        <label class="form-label">ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="current-admin-password" class="form-input" placeholder="ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="new-admin-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•ÂäõÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êñ∞„Åó„ÅÑÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
                        <input type="password" id="confirm-admin-password" class="form-input" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ">
                    </div>
                    
                    <button onclick="changeAdminPassword()" class="btn" style="background: linear-gradient(45deg, #d64541, #c82333);">üîß ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</button>
                    <button onclick="checkCurrentAdminPassword()" class="btn secondary" style="margin-left: 10px;">üîç ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</button>
                </div>
                
                <div id="password-change-status" style="margin-top: 15px;"></div>
            </div>

            </div>
        </section>

        <section class="dashboard-section" id="section-analytics">
            <h2 class="section-heading">üìà „É≠„Ç∞„Å®„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</h2>
            <p class="section-description">ÊúàÊ¨°„ÅÆ‰ΩøÁî®ÈáèÊé®Áßª„Å®„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆÁ®ºÂÉçÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ</p>
            <div class="dashboard-grid">
            <!-- ÊúàÊ¨°‰ΩøÁî®Èáè„Ç∞„É©„Éï -->
            <div class="dashboard-card" id="card-chart">
                <h3 class="card-title">üìà ÊúàÊ¨°‰ΩøÁî®Èáè„Ç∞„É©„Éï</h3>
                
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <label for="month-selector" style="font-weight: 600;">Ë°®Á§∫Êúà:</label>
                    <select id="month-selector" class="form-input" style="width: auto; min-width: 150px;" onchange="loadMonthlyChart()">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </select>
                    <button class="btn secondary" onclick="loadMonthlyChart()">
                        üîÑ Êõ¥Êñ∞
                    </button>
                </div>

                <div id="chart-container" style="position: relative;">
                    <canvas id="monthly-chart" width="800" height="400" style="max-width: 100%; border: 1px solid rgba(28, 36, 52, 0.16); border-radius: 12px; background: rgba(244, 247, 254, 0.95);"></canvas>
                </div>

                <div id="chart-summary" style="
                    margin-top: 20px;
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                    gap: 15px;
                    padding: 15px;
                    background: rgba(60, 90, 160, 0.12);
                    border-radius: 14px;
                ">
                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
            </div>

            <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã -->
            <div class="dashboard-card" id="card-system">
                <h3 class="card-title">‚öôÔ∏è „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</h3>
                
                <div id="system-status-display">
                    <div style="color: rgba(31, 42, 61, 0.55);">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn secondary" onclick="checkSystemStatus()">
                        üîç Áä∂ÊÖãÁ¢∫Ë™ç
                    </button>
                    <button class="btn success" onclick="runSystemOptimization()">
                        ‚ö° ÊúÄÈÅ©ÂåñÂÆüË°å
                    </button>
                </div>
            </div>

            </div>
        </section>
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(28, 36, 52, 0.16);">
            <a href="pages/marugo.html" style="
                color: #3c6ee8;
                text-decoration: none;
                font-weight: 600;
                padding: 12px 24px;
                border: 2px solid rgba(60, 110, 232, 0.4);
                border-radius: 10px;
                transition: all 0.3s ease;
                display: inline-flex;
                gap: 8px;
                align-items: center;
            " onmouseover="this.style.boxShadow='0 16px 28px rgba(60,110,232,0.24)';" onmouseout="this.style.boxShadow='none';">üìä „É°„Ç§„É≥„Ç∑„Çπ„ÉÜ„É†„Å´Êàª„Çã</a>
        </div>
    </div>
</div>

    <script src="config.js"></script>
    <script src="js/quota-alert-system.js"></script>
    <script src="js/simple-optimization.js"></script>
    
    <script>
        // ÁÆ°ÁêÜËÄÖË™çË®º„Ç∑„Çπ„ÉÜ„É†
        class AdminAuth {
            constructor() {
                this.SESSION_KEY = 'adminSession';
                this.SESSION_DURATION = 2 * 60 * 60 * 1000; // 2ÊôÇÈñì
                
                this.init();
            }

            init() {
                if (this.isAuthenticated()) {
                    this.showAdminPanel();
                } else {
                    this.showAuthScreen();
                }

                this.setupEventListeners();
            }

            setupEventListeners() {
                const authForm = document.getElementById('admin-auth-form');
                if (authForm) {
                    authForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        console.log('üîç ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†ÈÄÅ‰ø°');
                        this.handleAuth();
                    });
                }

                const passwordInput = document.getElementById('admin-password');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            console.log('üîç ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥ Enter„Ç≠„Éº');
                            this.handleAuth();
                        }
                    });
                }
                
                // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÅÆÁõ¥Êé•„ÇØ„É™„ÉÉ„ÇØ„ÇÇÂØæÂøú
                const loginBtn = document.querySelector('.auth-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', (e) => {
                        if (e.target.type !== 'submit') {
                            e.preventDefault();
                            console.log('üîç ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ');
                            this.handleAuth();
                        }
                    });
                }
                
                console.log('üîç ÁÆ°ÁêÜËÄÖË™çË®º„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');
            }

            async handleAuth() {
                const password = document.getElementById('admin-password').value;
                const errorDiv = document.getElementById('auth-error');
                const loginBtn = document.querySelector('.auth-btn');

                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'üîÑ Ë™çË®º‰∏≠...';
                }

                try {
                    // Supabase„ÅßÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®º
                    const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            action: 'verify',
                            passwordType: 'admin',
                            currentPassword: password
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.isValid) {
                        this.setAuthenticated();
                        errorDiv.style.display = 'none';
                        this.showAdminPanel();
                        console.log('‚úÖ ÁÆ°ÁêÜËÄÖË™çË®ºÊàêÂäüÔºàSupabaseÔºâ');
                    } else {
                        errorDiv.style.display = 'block';
                        errorDiv.style.animation = 'shake 0.5s';
                        document.getElementById('admin-password').value = '';
                        
                        setTimeout(() => {
                            errorDiv.style.animation = '';
                        }, 500);
                    }
                } catch (error) {
                    console.error('ÁÆ°ÁêÜËÄÖË™çË®º„Ç®„É©„Éº:', error);
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = '‚ùå Ë™çË®ºÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                }

                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'üîê ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥';
                }
            }

            isAuthenticated() {
                const session = localStorage.getItem(this.SESSION_KEY);
                if (!session) return false;

                try {
                    const data = JSON.parse(session);
                    const now = Date.now();
                    return (now - data.timestamp) < this.SESSION_DURATION;
                } catch {
                    return false;
                }
            }

            setAuthenticated() {
                const sessionData = {
                    timestamp: Date.now(),
                    authenticated: true
                };
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
            }

            showAuthScreen() {
                document.getElementById('admin-auth-screen').style.display = 'flex';
                document.getElementById('admin-main').style.display = 'none';
                
                setTimeout(() => {
                    document.getElementById('admin-password').focus();
                }, 300);
            }

            showAdminPanel() {
                document.getElementById('admin-auth-screen').style.display = 'none';
                document.getElementById('admin-main').style.display = 'grid';
                
                // ÁÆ°ÁêÜÁîªÈù¢„ÅÆÂàùÊúüÂåñ
                setTimeout(() => {
                    initializeAdminPanel();
                }, 100);
            }

            logout() {
                localStorage.removeItem(this.SESSION_KEY);
                this.showAuthScreen();
            }
        }

        // ÁÆ°ÁêÜÁîªÈù¢„ÅÆÂàùÊúüÂåñ
        // ÊúàÊ¨°„Ç∞„É©„ÉïÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        
        // ÊúàÈÅ∏Êäû„Éó„É´„ÉÄ„Ç¶„É≥„ÇíÂàùÊúüÂåñ
        function initializeMonthSelector() {
            const selector = document.getElementById('month-selector');
            const currentDate = new Date();
            
            // ÈÅéÂéª12„É∂ÊúàÂàÜ„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàê
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                
                // ÊôÇÈñìÂ∏Ø„Å´‰æùÂ≠ò„Åó„Å™„ÅÑÊúà„Ç≠„ÉºÁîüÊàê
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // 0„Éô„Éº„Çπ‚Üí1„Éô„Éº„ÇπÂ§âÊèõ
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
                
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName;
                
                if (i === 0) option.selected = true; // ‰ªäÊúà„ÇíÈÅ∏Êäû
                
                selector.appendChild(option);
            }
        }
        
        // ÊúàÊ¨°„ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
        async function getMonthlyChartData(targetMonth) {
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get_monthly_chart',
                        targetMonth: targetMonth
                    })
                });

                if (response.ok) {
                    const chartData = await response.json();
                    return chartData;
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('ÊúàÊ¨°„ÉÅ„É£„Éº„Éà„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                throw error;
            }
        }
        
        // „Ç∞„É©„Éï„ÇíÊèèÁîª
        function drawMonthlyChart(chartData) {
            const canvas = document.getElementById('monthly-chart');
            const ctx = canvas.getContext('2d');
            
            if (!canvas || !ctx) {
                console.error('‚ùå „Ç≠„É£„É≥„Éê„ÇπË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ÊèèÁîªË®≠ÂÆö
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const maxValue = Math.max(chartData.summary.maxDailyUsage, 10); // ÊúÄÂ∞è10„Å´Ë®≠ÂÆö
            
            // ËÉåÊôØ„Ç∞„É™„ÉÉ„Éâ
            ctx.strokeStyle = 'rgba(30, 45, 78, 0.14)';
            ctx.lineWidth = 1;
            
            // Ê®™Á∑öÔºà‰ΩøÁî®ÈáèÔºâ
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
                
                // YËª∏„É©„Éô„É´
                ctx.fillStyle = 'rgba(31, 42, 61, 0.55)';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(maxValue - (maxValue / 5) * i), padding - 10, y + 4);
            }
            
            // Á∏¶Á∑öÔºàÊó•‰ªòÔºâ
            const dayStep = Math.ceil(chartData.daysInMonth / 10); // ÊúÄÂ§ß10Êú¨„ÅÆÁ∏¶Á∑ö
            for (let day = 1; day <= chartData.daysInMonth; day += dayStep) {
                const x = padding + (chartWidth / chartData.daysInMonth) * (day - 1);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + chartHeight);
                ctx.stroke();
                
                // XËª∏„É©„Éô„É´
                ctx.fillStyle = 'rgba(31, 42, 61, 0.55)';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${day}Êó•`, x, padding + chartHeight + 20);
            }
            
            // „Éá„Éº„ÇøÁ∑ö„ÇíÊèèÁîª
            if (chartData.dailyData.length > 0) {
                
                // APIÂëº„Å≥Âá∫„ÅóÔºàÈùíÔºâ
                ctx.strokeStyle = '#3c6ee8';
                ctx.fillStyle = 'rgba(0, 123, 255, 0.1)';
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                chartData.dailyData.forEach((day, index) => {
                    const x = padding + (chartWidth / chartData.daysInMonth) * index;
                    const y = padding + chartHeight - (day.api_calls / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // „Éá„Éº„ÇøÈÄÅ‰ø°ÔºàÁ∑ëÔºâ
                ctx.strokeStyle = '#2bb67a';
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                chartData.dailyData.forEach((day, index) => {
                    const x = padding + (chartWidth / chartData.daysInMonth) * index;
                    const y = padding + chartHeight - (day.data_submissions / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // ÂêàË®àÔºàËµ§„ÄÅÂ§™Á∑öÔºâ
                ctx.strokeStyle = '#d64541';
                ctx.lineWidth = 3;
                
                ctx.beginPath();
                chartData.dailyData.forEach((day, index) => {
                    const x = padding + (chartWidth / chartData.daysInMonth) * index;
                    const y = padding + chartHeight - (day.total / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // „Éá„Éº„Çø„Éù„Ç§„É≥„Éà„ÇíÊèèÁîª
                    if (day.total > 0) {
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, 2 * Math.PI);
                        ctx.fillStyle = '#d64541';
                        ctx.fill();
                    }
                });
                ctx.stroke();
            }
            
            // Âá°‰æã
            const legendY = 30;
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            
            // APIÂëº„Å≥Âá∫„Åó
            ctx.strokeStyle = '#3c6ee8';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding, legendY);
            ctx.lineTo(padding + 20, legendY);
            ctx.stroke();
            ctx.fillStyle = '#3c6ee8';
            ctx.fillText('APIÂëº„Å≥Âá∫„Åó', padding + 30, legendY + 5);
            
            // „Éá„Éº„ÇøÈÄÅ‰ø°
            ctx.strokeStyle = '#2bb67a';
            ctx.beginPath();
            ctx.moveTo(padding + 120, legendY);
            ctx.lineTo(padding + 140, legendY);
            ctx.stroke();
            ctx.fillStyle = '#2bb67a';
            ctx.fillText('„Éá„Éº„ÇøÈÄÅ‰ø°', padding + 150, legendY + 5);
            
            // ÂêàË®à
            ctx.strokeStyle = '#d64541';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding + 240, legendY);
            ctx.lineTo(padding + 260, legendY);
            ctx.stroke();
            ctx.fillStyle = '#d64541';
            ctx.fillText('ÂêàË®à', padding + 270, legendY + 5);
        }
        
        // „Çµ„Éû„É™„Éº„ÇíË°®Á§∫
        function displayChartSummary(chartData) {
            const summaryContainer = document.getElementById('chart-summary');
            
            summaryContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #d64541;">${chartData.summary.monthlyTotal}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">ÊúàÈñìÂêàË®à</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 20px; font-weight: bold; color: #3c6ee8;">${chartData.summary.maxDailyUsage}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">ÊúÄÂ§ßÊó•‰ΩøÁî®Èáè</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #2bb67a;">${chartData.summary.avgDailyUsage}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">Âπ≥ÂùáÊó•‰ΩøÁî®Èáè</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #6f42c1;">${chartData.summary.activeDays}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊó•Êï∞</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 16px; font-weight: bold; color: #44bbaa;">${chartData.daysInMonth}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">Á∑èÊó•Êï∞</div>
                </div>
            `;
        }
        
        // ÊúàÊ¨°„ÉÅ„É£„Éº„Éà„ÇíË™≠„ÅøËæº„Åø
        async function loadMonthlyChart() {
            const selector = document.getElementById('month-selector');
            const selectedMonth = selector.value;
            
            try {
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                const chartContainer = document.getElementById('chart-container');
                const summaryContainer = document.getElementById('chart-summary');
                
                chartContainer.style.opacity = '0.5';
                summaryContainer.innerHTML = '<div style="color: rgba(31, 42, 61, 0.55); text-align: center;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
                
                // „Éá„Éº„ÇøÂèñÂæó
                const chartData = await getMonthlyChartData(selectedMonth);
                
                // „Ç∞„É©„ÉïÊèèÁîª
                drawMonthlyChart(chartData);
                displayChartSummary(chartData);
                
                chartContainer.style.opacity = '1';
                
            } catch (error) {
                console.error('ÊúàÊ¨°„ÉÅ„É£„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                
                const summaryContainer = document.getElementById('chart-summary');
                summaryContainer.innerHTML = `
                    <div style="color: #d64541; text-align: center;">
                        ‚ùå „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü<br>
                        <small>${error.message}</small>
                    </div>
                `;
                
                document.getElementById('chart-container').style.opacity = '1';
            }
        }

        function initializeAdminPanel() {
            const layoutShell = document.getElementById('admin-main');
            const navToggle = document.getElementById('nav-toggle');
            if (!layoutShell) return;
            const updateNavState = () => {
                if (!navToggle) return;
                const collapsed = layoutShell.classList.contains('nav-collapsed');
                navToggle.classList.toggle('active', collapsed);
                navToggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
            };
            if (navToggle && layoutShell && !navToggle.dataset.bound) {
                navToggle.addEventListener('click', () => {
                    layoutShell.classList.toggle('nav-collapsed');
                    updateNavState();
                });
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 1080) {
                        layoutShell.classList.remove('nav-collapsed');
                        updateNavState();
                    }
                });
                navToggle.dataset.bound = 'true';
            }
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 1080) {
                        layoutShell.classList.add('nav-collapsed');
                        updateNavState();
                    }
                });
            });
            if (window.innerWidth <= 1080) {
                layoutShell.classList.add('nav-collapsed');
                updateNavState();
            } else {
                layoutShell.classList.remove('nav-collapsed');
                updateNavState();
            }

            loadCurrentSettings();
            checkSystemStatus();
            
            // ÊúàÈÅ∏Êäû„Éó„É´„ÉÄ„Ç¶„É≥„ÇíÂàùÊúüÂåñ
            initializeMonthSelector();
            
            // quota-alert-system„ÅÆÂàùÊúüÂåñ„ÇíÂæÖ„Å£„Å¶„Åã„Çâ‰ΩøÁî®ÈáèË°®Á§∫
            setTimeout(() => {
                loadSimpleUsageDisplay();
                refreshUsageData(); // API‰ΩøÁî®ÈáèÁõ£Ë¶ñ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÊõ¥Êñ∞
                loadMonthlyChart(); // ÊúàÊ¨°„Ç∞„É©„Éï„ÇÇÂàùÊúüË™≠„ÅøËæº„Åø
                loadIndicatorSettings(); // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË®≠ÂÆöË™≠„ÅøËæº„Åø
                loadAPILimitSettings(); // API‰∏äÈôêÂÄ§Ë®≠ÂÆöË™≠„ÅøËæº„Åø
                
                // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞Ôºà30Áßí„Åî„Å®Ôºâ
                setInterval(() => {
                    loadSimpleUsageDisplay();
                    refreshUsageData(); // API‰ΩøÁî®ÈáèÁõ£Ë¶ñ„ÇÇÂÆöÊúüÊõ¥Êñ∞
                }, 30000);
            }, 2000); // 2ÁßíÂæÖÊ©ü„Åó„Å¶„Åã„Çâ„Çπ„Çø„Éº„Éà
        }

        // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        function loadCurrentSettings() {
            // „É°„Éº„É´Ê©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü

            // ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Ç¢„É©„Éº„ÉàÈñæÂÄ§„ÇíË™≠„ÅøËæº„Åø
            const savedThresholds = localStorage.getItem('alertThresholds');
            if (savedThresholds) {
                const thresholds = JSON.parse(savedThresholds);
                document.getElementById('first-warning-threshold').value = thresholds.first || 1000;
                document.getElementById('middle-warning-threshold').value = thresholds.middle || 2000;
                document.getElementById('final-warning-threshold').value = thresholds.final || 2800;
            }
        }

        // ‰ΩøÁî®Èáè„Éá„Éº„Çø„ÅÆÊõ¥Êñ∞ÔºàSupabase„Éô„Éº„ÇπÔºâ
        async function refreshUsageData() {
            try {
                console.log('üîÑ API‰ΩøÁî®ÈáèÁõ£Ë¶ñ„Çª„ÇØ„Ç∑„Éß„É≥Êõ¥Êñ∞ÈñãÂßã...');
                
                let usage;
                
                // quota-alert-system„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅØ‰ΩøÁî®
                if (window.quotaAlertSystem && typeof window.quotaAlertSystem.getCurrentUsage === 'function') {
                    usage = await window.quotaAlertSystem.getCurrentUsage();
                } else {
                    
                    // Áõ¥Êé•Supabase„Åã„ÇâÂèñÂæó
                    const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            action: 'get'
                        })
                    });

                    if (response.ok) {
                        const usageData = await response.json();
                        usage = {
                            daily: usageData.daily.total,
                            monthly: usageData.monthly.total,
                            total: usageData.total.total,
                            dailyPercentage: Math.round((usageData.daily.total / 300) * 100),
                            monthlyPercentage: Math.round((usageData.monthly.total / 3000) * 100)
                        };
                    } else {
                        throw new Error(`SupabaseÂèñÂæó„Ç®„É©„Éº: ${response.status}`);
                    }
                }
                
                // ÁîªÈù¢Êõ¥Êñ∞
                if (usage && typeof usage.daily !== 'undefined' && typeof usage.monthly !== 'undefined') {
                    updateUsageDisplay(usage);
                } else {
                    throw new Error('‰ΩøÁî®Èáè„Éá„Éº„Çø„Åå‰∏çÊ≠£„Åß„Åô');
                }
                
            } catch (error) {
                console.error('‚ùå API‰ΩøÁî®ÈáèÁõ£Ë¶ñÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                
                // „Ç®„É©„ÉºË°®Á§∫
                document.getElementById('daily-usage').textContent = '„Ç®„É©„Éº/300';
                document.getElementById('monthly-usage').textContent = '„Ç®„É©„Éº/3,000';
            }
        }

        // ‰ΩøÁî®ÈáèË°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateUsageDisplay(usage) {
            // Êó•Ê¨°‰ΩøÁî®Èáè
            document.getElementById('daily-usage').textContent = `${usage.daily}/300`;
            const dailyBar = document.getElementById('daily-usage-bar');
            dailyBar.style.width = `${Math.min(usage.dailyPercentage, 100)}%`;
            dailyBar.className = `usage-fill ${usage.dailyPercentage >= 85 ? 'danger' : usage.dailyPercentage >= 70 ? 'warning' : 'safe'}`;

            // ÊúàÊ¨°‰ΩøÁî®Èáè
            document.getElementById('monthly-usage').textContent = `${usage.monthly}/3,000`;
            const monthlyBar = document.getElementById('monthly-usage-bar');
            monthlyBar.style.width = `${Math.min(usage.monthlyPercentage, 100)}%`;
            monthlyBar.className = `usage-fill ${usage.monthlyPercentage >= 85 ? 'danger' : usage.monthlyPercentage >= 70 ? 'warning' : 'safe'}`;
        }

        // ÁÆ°ÁêÜËÄÖ„É°„Éº„É´„ÅÆ‰øùÂ≠ò
        function saveAdminEmail() {
            const email = document.getElementById('admin-email-input').value;
            const statusDiv = document.getElementById('email-settings-status');

            if (!email) {
                statusDiv.innerHTML = '<div class="status-error">‚ùå „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            if (!email.includes('@') || !email.includes('.')) {
                statusDiv.innerHTML = '<div class="status-error">‚ùå ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò
            localStorage.setItem('adminEmail', email);
            
            // „Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†„Å´„ÇÇË®≠ÂÆö
            if (typeof window.setAdminEmail === 'function') {
                window.setAdminEmail(email);
            }

            statusDiv.innerHTML = '<div class="status-success">‚úÖ ÁÆ°ÁêÜËÄÖ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>';
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Ê©üËÉΩÔºàSupabase„Éô„Éº„ÇπÔºâ
        async function changeSystemPassword() {
            const currentPassword = document.getElementById('current-system-password').value;
            const newPassword = document.getElementById('new-system-password').value;
            const confirmPassword = document.getElementById('confirm-system-password').value;
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordStatus('‚ùå „Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            showPasswordStatus('üîÑ „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥‰∏≠...', 'info');
            
            try {
                // „Åæ„ÅöÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊ§úË®º
                const verifyResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'verify',
                        passwordType: 'system',
                        currentPassword: currentPassword
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('üîç „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®ºÁµêÊûú:', { success: verifyResult.success, match: verifyResult.isValid });
                
                if (!verifyResult.success || !verifyResult.isValid) {
                    showPasswordStatus('‚ùå ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖ•ÂäõÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    return;
                }
                
                // üöÄ Ëá™Âãï„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥
                showPasswordStatus('üîÑ Êñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö‰∏≠...', 'info');
                
                const changeResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'change',
                        passwordType: 'system',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const changeResult = await changeResponse.json();
                console.log('üîÑ „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÁµêÊûú:', changeResult);
                
                if (changeResult.success) {
                    showPasswordStatus('‚úÖ „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÅåËá™Âãï„ÅßÂ§âÊõ¥„Åï„Çå„Åæ„Åó„ÅüÔºÅ', 'success');
                } else {
                    showPasswordStatus(`‚ùå „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Â§±Êïó: ${changeResult.error}`, 'error');
                }
                
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('current-system-password').value = '';
                document.getElementById('new-system-password').value = '';
                document.getElementById('confirm-system-password').value = '';
                
            } catch (error) {
                showPasswordStatus('‚ùå „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                console.error('System password change error:', error);
            }
        }
        
        // ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Ê©üËÉΩÔºàSupabase„Éô„Éº„ÇπÔºâ
        async function changeAdminPassword() {
            const currentPassword = document.getElementById('current-admin-password').value;
            const newPassword = document.getElementById('new-admin-password').value;
            const confirmPassword = document.getElementById('confirm-admin-password').value;
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordStatus('‚ùå „Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordStatus('‚ùå Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            showPasswordStatus('üîÑ ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥‰∏≠...', 'info');
            
            try {
                // „Åæ„ÅöÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊ§úË®º
                const verifyResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'verify',
                        passwordType: 'admin',
                        currentPassword: currentPassword
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('üîç ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®ºÁµêÊûú:', { success: verifyResult.success, match: verifyResult.isValid });
                
                if (!verifyResult.success || !verifyResult.isValid) {
                    showPasswordStatus('‚ùå ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖ•ÂäõÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    return;
                }
                
                // üöÄ Ëá™Âãï„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥
                showPasswordStatus('üîÑ Êñ∞„Åó„ÅÑÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö‰∏≠...', 'info');
                
                const changeResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'change',
                        passwordType: 'admin',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const changeResult = await changeResponse.json();
                console.log('üîÑ ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÁµêÊûú:', changeResult);
                
                if (changeResult.success) {
                    showPasswordStatus('‚úÖ ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåËá™Âãï„ÅßÂ§âÊõ¥„Åï„Çå„Åæ„Åó„ÅüÔºÅ', 'success');
                } else {
                    showPasswordStatus(`‚ùå ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Â§±Êïó: ${changeResult.error}`, 'error');
                }
                
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('current-admin-password').value = '';
                document.getElementById('new-admin-password').value = '';
                document.getElementById('confirm-admin-password').value = '';
                
            } catch (error) {
                showPasswordStatus('‚ùå ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                console.error('Admin password change error:', error);
            }
        }
        
        // ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
        async function checkCurrentSystemPassword() {
            showPasswordStatus('üîç ÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç‰∏≠...', 'info');
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get',
                        passwordType: 'system'
                    })
                });
                
                const result = await response.json();
                console.log('üîç „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å:', result);
                
                const systemInfo = result.passwords?.system;
                const systemStatus = systemInfo?.status || 'Á¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü';
                const systemUpdatedAt = systemInfo?.lastUpdated
                    ? new Date(systemInfo.lastUpdated).toLocaleString('ja-JP')
                    : 'Êú™ÁôªÈå≤';
                showPasswordStatus(`üìã „Ç∑„Çπ„ÉÜ„É†„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å: ${systemStatus}<br>üïí ÊúÄÁµÇÊõ¥Êñ∞: ${systemUpdatedAt}`, 'info');
                
            } catch (error) {
                console.error('„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                showPasswordStatus('‚ùå „Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
        async function checkCurrentAdminPassword() {
            showPasswordStatus('üîç ÁèæÂú®„ÅÆÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç‰∏≠...', 'info');
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get',
                        passwordType: 'admin'
                    })
                });
                
                const result = await response.json();
                console.log('üîç ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å:', result);
                
                const adminInfo = result.passwords?.admin;
                const adminStatus = adminInfo?.status || 'Á¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü';
                const adminUpdatedAt = adminInfo?.lastUpdated
                    ? new Date(adminInfo.lastUpdated).toLocaleString('ja-JP')
                    : 'Êú™ÁôªÈå≤';
                showPasswordStatus(`üìã ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁä∂Ê≥Å: ${adminStatus}<br>üïí ÊúÄÁµÇÊõ¥Êñ∞: ${adminUpdatedAt}`, 'info');
                
            } catch (error) {
                console.error('ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                showPasswordStatus('‚ùå ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        function showPasswordStatus(message, type) {
            const statusDiv = document.getElementById('password-change-status');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ3ÁßíÂæå„Å´Ê∂àÂéª
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        // „Ç¢„É©„Éº„ÉàË®≠ÂÆö„ÅÆ‰øùÂ≠ò
        function saveAlertSettings() {
            const settings = {
                first: parseInt(document.getElementById('first-warning-threshold').value),
                middle: parseInt(document.getElementById('middle-warning-threshold').value),
                final: parseInt(document.getElementById('final-warning-threshold').value)
            };

            // Ë®≠ÂÆöÂÄ§„ÅÆÊ§úË®º
            if (settings.first >= settings.middle || settings.middle >= settings.final) {
                document.getElementById('alert-settings-status').innerHTML = 
                    '<div class="status-error">‚ùå Ë≠¶Âëä„É¨„Éô„É´„ÅØÂàùÂõû < ‰∏≠Èñì < ÊúÄÁµÇ „ÅÆÈ†ÜÂ∫è„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            if (settings.final > 3000) {
                document.getElementById('alert-settings-status').innerHTML = 
                    '<div class="status-error">‚ùå ÊúÄÁµÇË≠¶Âëä„ÅØ3000‰ª∂‰ª•‰∏ã„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            // Ë®≠ÂÆö„Çí‰øùÂ≠ò
            localStorage.setItem('alertThresholds', JSON.stringify(settings));
            
            // „Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†„Å´ÂèçÊò†
            if (window.quotaAlertSystem) {
                window.quotaAlertSystem.WARNING_THRESHOLDS.monthly = settings;
            }

            document.getElementById('alert-settings-status').innerHTML = 
                '<div class="status-success">‚úÖ „Ç¢„É©„Éº„ÉàË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>';
            
            setTimeout(() => {
                document.getElementById('alert-settings-status').innerHTML = '';
            }, 3000);
        }

        // „Ç¢„É©„Éº„Éà„ÉÜ„Çπ„Éà
        async function testAlert(level) {
            if (typeof window.testQuotaAlert === 'function') {
                try {
                    await window.testQuotaAlert(level);
                    const levelNames = {
                        'first': 'ÂàùÂõûË≠¶Âëä (1000‰ª∂)',
                        'middle': '‰∏≠ÈñìË≠¶Âëä (2000‰ª∂)',
                        'final': 'ÊúÄÁµÇË≠¶Âëä (2800‰ª∂)'
                    };
                    document.getElementById('alert-test-status').innerHTML = 
                        `<div class="status-success">‚úÖ ${levelNames[level]} „ÅÆ„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü<br>üìä „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠¶Âëä„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü</div>`;
                    
                    setTimeout(() => {
                        document.getElementById('alert-test-status').innerHTML = '';
                    }, 5000);
                } catch (error) {
                    document.getElementById('alert-test-status').innerHTML = 
                        `<div class="status-error">‚ùå „ÉÜ„Çπ„Éà„Ç®„É©„Éº: ${error.message}</div>`;
                }
            } else {
                alert('„Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        }

        // „É°„Éº„É´ÈÄöÁü•„ÉÜ„Çπ„Éà
        async function testEmailNotification() {
            const email = document.getElementById('admin-email-input').value;
            if (!email) {
                document.getElementById('email-settings-status').innerHTML = 
                    '<div class="status-error">‚ùå „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            try {
                // „ÉÜ„Çπ„ÉàÁî®„ÅÆ„É°„Éº„É´„Éá„Éº„Çø
                const testEmailData = {
                    to: email,
                    subject: 'üß™ „ÉÜ„Çπ„ÉàÈÄÅ‰ø° - Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† „Ç¢„É©„Éº„ÉàÊ©üËÉΩ',
                    body: `
Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† „Ç¢„É©„Éº„ÉàÊ©üËÉΩ „ÉÜ„Çπ„ÉàÈÄÅ‰ø°

„ÄêÈÄÅ‰ø°ÊôÇÂàª„Äë: ${new Date().toLocaleString('ja-JP')}
„ÄêÈÄÅ‰ø°ÂÖÉ„Äë: ÁÆ°ÁêÜËÄÖÁîªÈù¢„ÉÜ„Çπ„ÉàÊ©üËÉΩ

„Åì„ÅÆ„É°„Éº„É´„ÅØ„ÄÅ„Ç¢„É©„Éº„ÉàÊ©üËÉΩ„ÅÆÂãï‰ΩúÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅ„Å´ÈÄÅ‰ø°„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

ÂÆüÈöõ„ÅÆ„Ç¢„É©„Éº„ÉàÁô∫ÁîüÊôÇ„Å´„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Åæ„Åô:
- API‰ΩøÁî®Èáè„ÅÆË©≥Á¥∞
- „Ç¢„É©„Éº„Éà„É¨„Éô„É´
- Êé®Â•®ÂØæÂøú
- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Ë≤∏ÂÄüÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† ÁÆ°ÁêÜËÄÖÁîªÈù¢
„ÉÜ„Çπ„ÉàÈÄÅ‰ø°Ê©üËÉΩ„Çà„Çä
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    `,
                    priority: 'normal'
                };

                // Supabase FunctionÁµåÁî±„Åß„É°„Éº„É´ÈÄÅ‰ø°
                const response = await fetch(`${SUPABASE_CONFIG.url}/functions/v1/send-alert-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify(testEmailData)
                });

                if (response.ok) {
                    document.getElementById('email-settings-status').innerHTML = 
                        '<div class="status-success">‚úÖ „ÉÜ„Çπ„Éà„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü</div>';
                } else {
                    throw new Error(`„É°„Éº„É´ÈÄÅ‰ø°„Ç®„É©„Éº: ${response.status}`);
                }
            } catch (error) {
                console.error('„ÉÜ„Çπ„Éà„É°„Éº„É´ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                document.getElementById('email-settings-status').innerHTML = 
                    '<div class="status-warning">‚ö†Ô∏è „ÉÜ„Çπ„Éà„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàÈñãÁô∫Áí∞Â¢É„Åß„ÅØ„É≠„Ç∞Âá∫Âäõ„ÅÆ„ÅøÔºâ</div>';
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÁ¢∫Ë™ç
        function checkSystemStatus() {
            const status = {
                'ConfigË™≠„ÅøËæº„Åø': typeof window.SUPABASE_CONFIG !== 'undefined',
                'APIÈñ¢Êï∞': typeof window.callSheetsAPI === 'function',
                'ÊúÄÈÅ©Âåñ„Ç∑„Çπ„ÉÜ„É†': typeof window.simpleOptimization !== 'undefined',
                '„Ç¢„É©„Éº„Éà„Ç∑„Çπ„ÉÜ„É†': typeof window.quotaAlertSystem !== 'undefined'
            };

            let html = '<div style="display: grid; gap: 10px;">';
            let allOK = true;

            Object.entries(status).forEach(([name, ok]) => {
                const statusText = ok ? '‚úÖ Ê≠£Â∏∏' : '‚ùå „Ç®„É©„Éº';
                const statusClass = ok ? 'status-success' : 'status-error';
                html += `<div class="${statusClass}" style="padding: 8px; font-size: 14px;">${name}: ${statusText}</div>`;
                
                if (!ok) allOK = false;
            });

            if (allOK) {
                html += '<div class="status-success" style="padding: 8px; font-weight: 600;">üéâ „Åô„Åπ„Å¶„ÅÆ„Ç∑„Çπ„ÉÜ„É†„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô</div>';
            }

            html += '</div>';
            document.getElementById('system-status-display').innerHTML = html;
        }

        // „Ç∑„Çπ„ÉÜ„É†ÊúÄÈÅ©Âåñ„ÅÆÂÆüË°å
        async function runSystemOptimization() {
            try {
                if (typeof window.testSimpleOptimization === 'function') {
                    await window.testSimpleOptimization();
                }
                
                document.getElementById('system-status-display').innerHTML += 
                    '<div class="status-success" style="margin-top: 10px;">‚ö° „Ç∑„Çπ„ÉÜ„É†ÊúÄÈÅ©Âåñ„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü</div>';
            } catch (error) {
                document.getElementById('system-status-display').innerHTML += 
                    '<div class="status-error" style="margin-top: 10px;">‚ùå ÊúÄÈÅ©ÂåñÂÆüË°å„Ç®„É©„Éº: ' + error.message + '</div>';
            }
        }

        // ‰ΩøÁî®ÈáèÁµ±Ë®à„ÅÆ„É™„Çª„ÉÉ„Éà
        function resetUsageStats() {
            if (confirm('‰ΩøÁî®ÈáèÁµ±Ë®à„Çí„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÇÇÂê´„ÇÅ„Å¶„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„ÅôÔºâ')) {
                localStorage.removeItem('dailyAPIStats');
                localStorage.removeItem('monthlyAPIStats');
                localStorage.removeItem('alertHistory');
                localStorage.removeItem('simpleOptimizationStats');
                
                alert('üóëÔ∏è ‰ΩøÁî®ÈáèÁµ±Ë®à„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
                refreshUsageData();
            }
        }

        // „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø
        function loadAlertHistory() {
            const history = JSON.parse(localStorage.getItem('alertHistory') || '[]');
            const historyDiv = document.getElementById('alert-history-display');

            if (history.length === 0) {
                historyDiv.innerHTML = '<div style="color: rgba(31, 42, 61, 0.55); text-align: center;">üì≠ „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            let html = '';
            history.slice(0, 20).forEach(alert => {
                const date = new Date(alert.timestamp).toLocaleString('ja-JP');
                const levelClass = alert.level.includes('first') ? 'first' : 
                                 alert.level.includes('middle') ? 'middle' : 'final';
                const icon = levelClass === 'first' ? 'üìä' : 
                           levelClass === 'middle' ? '‚ö†Ô∏è' : 'üö®';
                
                html += `
                    <div class="alert-item ${levelClass}">
                        <div style="font-weight: 600;">${icon} ${alert.level.replace('_', ' ').toUpperCase()}</div>
                        <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">${date}</div>
                        <div style="margin-top: 5px;">
                            ÊúàÈñì‰ΩøÁî®Èáè: ${alert.usage.monthly}‰ª∂ (${alert.usage.monthlyPercentage}%)
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = html;
        }

        // „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅÆ„ÇØ„É™„Ç¢
        function clearAlertHistory() {
            if (confirm('„Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem('alertHistory');
                document.getElementById('alert-history-display').innerHTML = 
                    '<div style="color: rgba(31, 42, 61, 0.55); text-align: center;">üì≠ „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                alert('üóëÔ∏è „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            }
        }

        // ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç¢„Ç¶„Éà
        function adminLogout() {
            if (confirm('ÁÆ°ÁêÜËÄÖÁîªÈù¢„Åã„Çâ„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                window.adminAuth.logout();
            }
        }

        // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleDebugMode() {
            const currentMode = window._debugMode || false;
            window._debugMode = !currentMode;
            
            const status = window._debugMode ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ';
            const color = window._debugMode ? '#2bb67a' : 'rgba(31, 42, 61, 0.55)';
            
            alert(`üîß „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ${status}\n\nË©≥Á¥∞„Å™APIÂëº„Å≥Âá∫„Åó„É≠„Ç∞„Åå${status}„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ`);
            
            // „Éú„Çø„É≥„ÅÆËâ≤„ÇíÂ§âÊõ¥
            const debugBtn = event.target;
            debugBtn.style.background = color;
            debugBtn.textContent = `üîß „Éá„Éê„ÉÉ„Ç∞${window._debugMode ? 'ON' : 'OFF'}`;
            
            console.log(`üîß „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ${status}`);
        }

        // ‰ΩøÁî®Èáè„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÈñ¢Êï∞„ÅØÁ∞°Á¥†Âåñ„Åï„Çå„Åæ„Åó„Åü

        // „Ç∑„É≥„Éó„É´„Å™API‰ΩøÁî®ÈáèË°®Á§∫ÔºàSupabase„Éô„Éº„Çπ„Éªquota-alert-system„Å®ÂêåÊúüÔºâ
        async function loadSimpleUsageDisplay() {
            try {
                let usage;
                
                // quota-alert-system„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅØ‰ΩøÁî®ÔºàÈùûÂêåÊúüÂØæÂøúÔºâ
                if (window.quotaAlertSystem) {
                    usage = await window.quotaAlertSystem.getCurrentUsage();
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Áõ¥Êé•localStorageË™≠„ÅøËæº„Åø
                    const today = new Date().toDateString();
                    const currentMonth = new Date().toISOString().slice(0, 7);

                    const dailyStats = JSON.parse(localStorage.getItem('dailyAPIStats') || '{}');
                    const monthlyStats = JSON.parse(localStorage.getItem('monthlyAPIStats') || '{}');
                    const totalStats = JSON.parse(localStorage.getItem('totalAPIStats') || '{"total": 0}');

                    usage = {
                        daily: dailyStats[today] || 0,
                        monthly: monthlyStats[currentMonth] || 0,
                        total: totalStats.total || 0
                    };
                }

                const display = document.getElementById('simple-usage-display');
                display.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: rgba(244, 247, 254, 0.9);
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${usage.daily}</div>
                        <div style="font-size: 0.875rem; color: rgba(31, 42, 61, 0.55);">Êú¨Êó•Á¥ØË®à / 300</div>
                    </div>

                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: rgba(244, 247, 254, 0.9);
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${usage.monthly}</div>
                        <div style="font-size: 0.875rem; color: rgba(31, 42, 61, 0.55);">‰ªäÊúàÁ¥ØË®à / 3,000</div>
                    </div>

                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: rgba(244, 247, 254, 0.9);
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${(usage.total || 0).toLocaleString()}</div>
                        <div style="font-size: 0.875rem; color: rgba(31, 42, 61, 0.55);">Á∑èÁ¥ØË®à</div>
                    </div>
                `;
            } catch (error) {
                console.error('‰ΩøÁî®ÈáèË°®Á§∫„Ç®„É©„Éº:', error);
                const display = document.getElementById('simple-usage-display');
                display.innerHTML = '<div style="color: #d64541;">‚ùå ‰ΩøÁî®Èáè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // CSS „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);

        // ‰ΩøÁî®Èáè„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË®≠ÂÆöÁÆ°ÁêÜ
        function saveIndicatorSettings() {
            try {
                const orangeThreshold = parseInt(document.getElementById('orange-threshold').value) || 900;
                const yellowThreshold = parseInt(document.getElementById('yellow-threshold').value) || 1500;
                const redThreshold = parseInt(document.getElementById('red-threshold').value) || 2400;

                // ÂÄ§„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (orangeThreshold >= yellowThreshold || yellowThreshold >= redThreshold) {
                    alert('‚ö†Ô∏è ÈñæÂÄ§„ÅØ Á∑ëËâ≤ < ÈªÑËâ≤ < Ëµ§Ëâ≤ „ÅÆÈ†ÜÂ∫è„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const settings = {
                    orange: orangeThreshold,
                    yellow: yellowThreshold,
                    red: redThreshold,
                    updated: new Date().toISOString()
                };

                localStorage.setItem('indicatorColorSettings', JSON.stringify(settings));
                
                // „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
                updateIndicatorPreview(settings);
                
                alert('‚úÖ ‰ΩøÁî®Èáè„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆËâ≤Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü\\n\\nË®≠ÂÆö„ÅØÂÖ®„Éö„Éº„Ç∏„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„Å´Âç≥Â∫ß„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ');
                
            } catch (error) {
                console.error('Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('‚ùå Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function loadIndicatorSettings() {
            try {
                const saved = localStorage.getItem('indicatorColorSettings');
                let settings;
                
                if (saved) {
                    settings = JSON.parse(saved);
                } else {
                    // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
                    settings = { orange: 900, yellow: 1500, red: 2400 };
                }

                document.getElementById('orange-threshold').value = settings.orange;
                document.getElementById('yellow-threshold').value = settings.yellow;
                document.getElementById('red-threshold').value = settings.red;
                
                updateIndicatorPreview(settings);
                
            } catch (error) {
                console.error('Ë®≠ÂÆöË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                resetIndicatorSettings();
            }
        }

        function resetIndicatorSettings() {
            const defaultSettings = { orange: 900, yellow: 1500, red: 2400 };
            
            document.getElementById('orange-threshold').value = defaultSettings.orange;
            document.getElementById('yellow-threshold').value = defaultSettings.yellow;
            document.getElementById('red-threshold').value = defaultSettings.red;
            
            updateIndicatorPreview(defaultSettings);
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÇÇÂâäÈô§
            localStorage.removeItem('indicatorColorSettings');
            
            alert('üîÑ „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„Å´Êàª„Åó„Åæ„Åó„Åü');
        }

        function updateIndicatorPreview(settings) {
            const preview = document.getElementById('indicator-preview');
            
            preview.innerHTML = `
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(0, 0, 0, 0.8); color: white; font-size: 12px; font-weight: bold;">
                    ‚ö´ Èªí: 0-${settings.orange - 1}Âõû
                </div>
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(40, 167, 69, 0.8); color: white; font-size: 12px; font-weight: bold;">
                    üü¢ Á∑ë: ${settings.orange}-${settings.yellow - 1}Âõû
                </div>
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(255, 193, 7, 0.9); color: white; font-size: 12px; font-weight: bold;">
                    üü° ÈªÑËâ≤: ${settings.yellow}-${settings.red - 1}Âõû
                </div>
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(220, 53, 69, 0.9); color: white; font-size: 12px; font-weight: bold;">
                    üî¥ Ëµ§Ëâ≤: ${settings.red}Âõû‰ª•‰∏ä
                </div>
            `;
        }

        // API‰∏äÈôêÂÄ§Ë®≠ÂÆöÁÆ°ÁêÜ
        function saveAPILimitSettings() {
            try {
                const apiLimit = parseInt(document.getElementById('api-limit').value);
                
                if (!apiLimit || apiLimit < 100 || apiLimit > 10000) {
                    alert('‚ö†Ô∏è ‰∏äÈôêÂÄ§„ÅØ100-10,000Âõû„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const settings = {
                    apiLimit: apiLimit,
                    updated: new Date().toISOString()
                };

                localStorage.setItem('apiLimitSettings', JSON.stringify(settings));
                
                updateLimitStatus(settings);
                
                alert(`‚úÖ API‰ΩøÁî®Èáè‰∏äÈôê„Çí${apiLimit}Âõû„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü\\n\\nË®≠ÂÆö„ÅØÂç≥Â∫ß„Å´„Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ`);
                
            } catch (error) {
                console.error('‰∏äÈôêÂÄ§Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('‚ùå Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function loadAPILimitSettings() {
            try {
                const saved = localStorage.getItem('apiLimitSettings');
                let settings;
                
                if (saved) {
                    settings = JSON.parse(saved);
                } else {
                    // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
                    settings = { apiLimit: 2500 };
                }

                document.getElementById('api-limit').value = settings.apiLimit;
                updateLimitStatus(settings);
                
            } catch (error) {
                console.error('‰∏äÈôêÂÄ§Ë®≠ÂÆöË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                resetAPILimitSettings();
            }
        }

        function resetAPILimitSettings() {
            const defaultSettings = { apiLimit: 2500 };
            
            document.getElementById('api-limit').value = defaultSettings.apiLimit;
            updateLimitStatus(defaultSettings);
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÇÇÂâäÈô§
            localStorage.removeItem('apiLimitSettings');
            
            alert('üîÑ „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆöÔºà2,500ÂõûÔºâ„Å´Êàª„Åó„Åæ„Åó„Åü');
        }

        async function updateLimitStatus(settings) {
            try {
                // ÁèæÂú®„ÅÆ‰ΩøÁî®Èáè„ÇíÂèñÂæó
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get'
                    })
                });

                if (response.ok) {
                    const stats = await response.json();
                    const monthlyUsage = stats.monthly.total;
                    const usagePercentage = Math.round((monthlyUsage / settings.apiLimit) * 100);
                    
                    let statusColor, statusText;
                    if (monthlyUsage >= settings.apiLimit) {
                        statusColor = '#d64541';
                        statusText = 'üö´ ÈÅÆÊñ≠‰∏≠';
                    } else if (usagePercentage >= 90) {
                        statusColor = '#fd7e14';
                        statusText = '‚ö†Ô∏è Âç±Èô∫„É¨„Éô„É´';
                    } else if (usagePercentage >= 70) {
                        statusColor = '#f6b93b';
                        statusText = 'üü° Ë≠¶Âëä„É¨„Éô„É´';
                    } else {
                        statusColor = '#2bb67a';
                        statusText = '‚úÖ Ê≠£Â∏∏';
                    }
                    
                    const statusHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p><strong>Ë®≠ÂÆö‰∏äÈôêÂÄ§:</strong> ${settings.apiLimit.toLocaleString()}Âõû</p>
                                <p><strong>ÁèæÂú®„ÅÆ‰ΩøÁî®Èáè:</strong> ${monthlyUsage.toLocaleString()}Âõû</p>
                                <p><strong>‰ΩøÁî®Áéá:</strong> ${usagePercentage}%</p>
                            </div>
                            <div>
                                <p style="font-size: 18px; font-weight: bold; color: ${statusColor};">
                                    ${statusText}
                                </p>
                                <p><strong>ÊÆã„Çä‰ΩøÁî®ÂèØËÉΩ:</strong> ${Math.max(0, settings.apiLimit - monthlyUsage).toLocaleString()}Âõû</p>
                                <p><small>ÊúÄÁµÇÊõ¥Êñ∞: ${settings.updated ? new Date(settings.updated).toLocaleString() : 'Êú™Ë®≠ÂÆö'}</small></p>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('limit-status-content').innerHTML = statusHtml;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Áä∂Ê≥ÅÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                document.getElementById('limit-status-content').innerHTML = `
                    <p><strong>Ë®≠ÂÆö‰∏äÈôêÂÄ§:</strong> ${settings.apiLimit.toLocaleString()}Âõû</p>
                    <p style="color: #d64541;">‰ΩøÁî®Èáè„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
                `;
            }
        }

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            window.adminAuth = new AdminAuth();
        });
    </script>
</body>
</html>
