<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ç®¡ç†è€…ç”»é¢ - è²¸å€Ÿç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            background: radial-gradient(circle at 30% 20%, rgba(60, 90, 160, 0.3) 0%, rgba(22, 26, 38, 0.92) 70%);
            min-height: 100vh;
            padding: clamp(24px, 5vw, 48px);
            color: #1e293b;
        }

        .app-shell {
            display: grid;
            grid-template-columns: minmax(240px, 280px) 1fr;
            gap: 32px;
            align-items: start;
            transition: grid-template-columns 0.25s ease;
        }

        .app-shell.nav-collapsed {
            grid-template-columns: 0px 1fr;
        }

        .app-shell.nav-collapsed .sidebar {
            transform: translateX(-120%);
            opacity: 0;
            pointer-events: none;
        }

        .sidebar {
            transform: translateX(0);
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .sidebar {
            background: rgba(238, 241, 249, 0.94);
            border-radius: 24px;
            border: 1px solid rgba(28, 36, 52, 0.14);
            padding: 28px 24px;
            box-shadow: 0 28px 50px rgba(14, 20, 36, 0.22);
            position: sticky;
            top: clamp(24px, 5vw, 48px);
            height: fit-content;
            display: grid;
            gap: 28px;
        }

        .sidebar h2 {
            font-size: 1.1rem;
            letter-spacing: 0.12em;
            color: #1f2a3d;
        }

        .sidebar p {
            font-size: 13px;
            color: rgba(31, 42, 61, 0.62);
            line-height: 1.5;
        }

        .nav-section {
            display: grid;
            gap: 12px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid transparent;
            color: rgba(31, 42, 61, 0.75);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            border-color: rgba(60, 110, 232, 0.3);
            background: rgba(60, 110, 232, 0.12);
            color: #3c6ee8;
        }

        .nav-link.subtle {
            font-weight: 500;
            color: rgba(31, 42, 61, 0.55);
        }

        .main-view {
            background: rgba(244, 247, 254, 0.94);
            border-radius: 28px;
            border: 1px solid rgba(28, 36, 52, 0.14);
            box-shadow: 0 32px 60px rgba(14, 20, 36, 0.22);
            padding: clamp(28px, 4vw, 40px);
            display: grid;
            gap: 32px;
        }

        /* èªè¨¼ç”»é¢ */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: radial-gradient(circle at 30% 20%, rgba(60, 90, 160, 0.35) 0%, rgba(22, 26, 38, 0.94) 70%);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
            padding: 24px;
        }

        .auth-card {
            background: rgba(244, 247, 254, 0.95);
            border-radius: 24px;
            padding: clamp(32px, 4vw, 44px);
            box-shadow: 0 30px 60px rgba(14, 20, 36, 0.3);
            max-width: 420px;
            width: min(420px, 100%);
            backdrop-filter: blur(24px);
            text-align: center;
            border: 1px solid rgba(30, 45, 78, 0.14);
        }

        .auth-title {
            font-size: 2rem;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .auth-input {
            width: 100%;
            padding: 14px;
            border: 2px solid rgba(60, 90, 160, 0.2);
            border-radius: 14px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        .auth-input:focus {
            outline: none;
            border-color: rgba(60, 90, 160, 0.55);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(76, 130, 255, 0.18);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 16px 24px rgba(60, 110, 232, 0.25);
        }

        .auth-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 32px rgba(60, 110, 232, 0.3);
        }

        .auth-error {
            background: rgba(214, 69, 65, 0.18);
            color: #d64541;
            padding: 12px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(30, 45, 78, 0.14);
        }

        .admin-title {
            font-size: 2.5rem;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .main-subtitle {
            margin-top: 6px;
            color: rgba(31, 42, 61, 0.62);
            font-size: 14px;
        }

        .main-subtitle {
            margin-top: 6px;
            color: rgba(31, 42, 61, 0.62);
            font-size: 14px;
        }

        .logout-btn {
            background: linear-gradient(120deg, #64748b, #475569);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(71, 85, 105, 0.25);
        }

        .nav-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(60, 90, 160, 0.16);
            color: #3c6ee8;
            border: 1px solid rgba(60, 110, 232, 0.25);
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-toggle:hover {
            background: rgba(60, 90, 160, 0.22);
            box-shadow: 0 12px 20px rgba(60, 110, 232, 0.18);
        }

        .nav-toggle.active {
            background: rgba(60, 110, 232, 0.24);
            color: #fff;
        }

        .dashboard-section {
            display: grid;
            gap: 24px;
        }

        .section-heading {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2a3d;
        }

        .section-description {
            font-size: 14px;
            color: rgba(31, 42, 61, 0.62);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        .dashboard-card {
            background: rgba(235, 239, 247, 0.95);
            border-radius: 18px;
            padding: clamp(22px, 3vw, 28px);
            box-shadow: 0 18px 32px rgba(14, 20, 36, 0.18);
            border: 1px solid rgba(28, 36, 52, 0.12);
            transition: all 0.3s ease;
            scroll-margin-top: 120px;
        }

        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 26px 40px rgba(14, 20, 36, 0.22);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-subtitle {
            font-size: 0.95rem;
            color: rgba(31, 42, 61, 0.6);
            margin: -8px 0 18px 0;
        }

        .access-log-list {
            max-height: 320px;
            overflow-y: auto;
            display: grid;
            gap: 12px;
            padding-right: 6px;
        }

        .access-log-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(28, 36, 52, 0.08);
            padding: 14px 16px;
            display: grid;
            gap: 6px;
        }

        .access-log-item.alert {
            border-color: rgba(214, 69, 65, 0.32);
            box-shadow: 0 6px 20px rgba(214, 69, 65, 0.18);
            background: rgba(255, 247, 244, 0.95);
        }

        .access-log-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: rgba(31, 42, 61, 0.6);
            gap: 12px;
        }

        .access-log-event {
            font-weight: 600;
            color: #3c6ee8;
        }

        .access-log-time {
            font-family: 'SFMono-Regular', 'Consolas', 'Menlo', monospace;
        }

        .access-log-description {
            font-size: 0.95rem;
            color: #1f2a3d;
        }

        .access-log-device {
            font-size: 0.8rem;
            color: rgba(31, 42, 61, 0.55);
        }

        .access-log-stats {
            font-size: 0.8rem;
            color: rgba(31, 42, 61, 0.55);
            display: flex;
            flex-wrap: wrap;
            gap: 6px 12px;
        }

        .access-log-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 600;
            background: rgba(148, 163, 184, 0.15);
            color: rgba(71, 85, 105, 0.9);
        }

        .access-log-status.pending {
            background: rgba(246, 185, 59, 0.18);
            color: #b76100;
        }

        .access-log-status.resolved {
            background: rgba(34, 193, 165, 0.18);
            color: #1f6f5a;
        }

        .access-log-status.normal {
            background: rgba(148, 163, 184, 0.12);
            color: rgba(71, 85, 105, 0.9);
        }

        .access-log-actions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .access-log-action {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background: rgba(60, 110, 232, 0.12);
            color: #3c6ee8;
        }

        .access-log-action:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(60, 110, 232, 0.15);
        }

        .access-log-action.danger {
            background: rgba(214, 69, 65, 0.15);
            color: #a8322f;
        }

        .access-log-action.primary {
            background: rgba(43, 182, 122, 0.18);
            color: #1f6f5a;
        }

        .access-log-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .data-mismatch-warning {
            background: rgba(214, 69, 65, 0.15);
            border: 1px solid rgba(214, 69, 65, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #721c24;
            font-weight: 500;
        }

        .data-mismatch-list {
            display: grid;
            gap: 12px;
            padding-right: 6px;
        }

        .data-mismatch-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(28, 36, 52, 0.08);
            padding: 16px;
            display: grid;
            gap: 12px;
        }

        .data-mismatch-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: rgba(31, 42, 61, 0.7);
            gap: 12px;
        }

        .data-mismatch-id {
            font-weight: 600;
            color: #d64541;
        }

        .data-mismatch-time {
            color: rgba(31, 42, 61, 0.6);
        }

        .data-mismatch-stats {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
            color: rgba(31, 42, 61, 0.7);
            flex-wrap: wrap;
        }

        .data-mismatch-stats span {
            background: rgba(60, 110, 232, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .data-mismatch-environment {
            background: rgba(244, 247, 254, 0.8);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(28, 36, 52, 0.05);
        }

        .data-mismatch-environment h4 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: #3c6ee8;
        }

        .environment-details {
            display: grid;
            gap: 4px;
            font-size: 0.8rem;
            color: rgba(31, 42, 61, 0.7);
        }

        .environment-details p {
            margin: 0;
            display: flex;
            gap: 8px;
        }

        .environment-details strong {
            color: rgba(31, 42, 61, 0.8);
            min-width: 80px;
        }

        .data-mismatch-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .data-mismatch-placeholder {
            text-align: center;
            color: rgba(31, 42, 61, 0.5);
            padding: 24px;
            font-style: italic;
        }

        /* è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« */
        .detail-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .detail-modal-overlay.show {
            opacity: 1;
        }

        .detail-modal {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .detail-modal-overlay.show .detail-modal {
            transform: scale(1);
        }

        .detail-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2a3d;
            margin: 0;
        }

        .detail-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .detail-modal-close:hover {
            background-color: #f3f4f6;
        }

        .detail-modal-content {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3c6ee8;
        }

        .detail-item-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .detail-item-value {
            color: #6b7280;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .detail-json {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .detail-mismatch-item {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .detail-mismatch-field {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 5px;
        }

        .detail-mismatch-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .detail-mismatch-sent,
        .detail-mismatch-registered {
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .detail-mismatch-sent {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
        }

        .detail-mismatch-registered {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
        }

        .system-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(14, 20, 36, 0.55);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            padding: 24px;
        }

        .system-alert-modal {
            background: rgba(244, 247, 254, 0.96);
            border-radius: 18px;
            padding: clamp(28px, 5vw, 36px);
            width: min(480px, 100%);
            box-shadow: 0 24px 48px rgba(14, 20, 36, 0.3);
            border: 1px solid rgba(60, 110, 232, 0.18);
            display: grid;
            gap: 18px;
        }

        .system-alert-modal h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #d64541;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-alert-modal p {
            margin: 0;
            font-size: 0.95rem;
            color: rgba(31, 42, 61, 0.75);
            line-height: 1.6;
        }

        .system-alert-modal button {
            justify-self: end;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 12px 24px rgba(60, 110, 232, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .system-alert-modal button:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(60, 110, 232, 0.28);
        }

        .access-log-placeholder {
            text-align: center;
            color: rgba(31, 42, 61, 0.55);
            padding: 18px 12px;
            border: 1px dashed rgba(60, 110, 232, 0.25);
            border-radius: 12px;
        }

        .access-log-warning {
            background: rgba(214, 69, 65, 0.12);
            border: 1px solid rgba(214, 69, 65, 0.3);
            color: #7c1f1c;
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        .access-log-footer {
            margin-top: 18px;
            display: flex;
            justify-content: flex-end;
        }

        .access-log-footer .btn {
            margin: 0;
        }

        .usage-display {
            font-size: 2rem;
            font-weight: 700;
            margin: 15px 0;
        }

        .usage-bar {
            width: 100%;
            height: 18px;
            background: rgba(60, 90, 160, 0.12);
            border-radius: 999px;
            overflow: hidden;
            margin: 15px 0;
        }

        .usage-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 999px;
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
        }

        .usage-fill.safe { background: linear-gradient(120deg, #2bb67a, #22c1a5); }
        .usage-fill.warning { background: linear-gradient(120deg, #f6b93b, #f08a24); }
        .usage-fill.danger { background: linear-gradient(120deg, #d64541, #ef5f5f); }

        .form-group {
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1f2a3d;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(60, 90, 160, 0.2);
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.92);
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(60, 90, 160, 0.6);
            box-shadow: 0 0 0 3px rgba(60, 110, 232, 0.18);
        }

        .btn {
            background: linear-gradient(120deg, #3c6ee8, #44bbaa);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 12px 24px rgba(60, 110, 232, 0.25);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(60, 110, 232, 0.28);
        }

        .btn.secondary {
            background: linear-gradient(120deg, #94a3b8, #64748b);
            box-shadow: 0 12px 24px rgba(100, 116, 139, 0.2);
        }

        .btn.success {
            background: linear-gradient(120deg, #2bb67a, #22c1a5);
            box-shadow: 0 12px 24px rgba(34, 193, 165, 0.24);
        }

        .btn.warning {
            background: linear-gradient(120deg, #f6b93b, #f08a24);
            box-shadow: 0 12px 24px rgba(240, 138, 36, 0.22);
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: rgba(43, 182, 122, 0.15);
            color: #1f513b;
            border: 1px solid rgba(43, 182, 122, 0.3);
        }

        .status-error {
            background: rgba(214, 69, 65, 0.15);
            color: #7c1f1c;
            border: 1px solid rgba(214, 69, 65, 0.28);
        }

        .status-warning {
            background: rgba(246, 185, 59, 0.16);
            color: #7a5200;
            border: 1px solid rgba(246, 185, 59, 0.28);
        }

        .status-info {
            background: rgba(68, 104, 185, 0.14);
            color: #1f2f5c;
            border: 1px solid rgba(68, 104, 185, 0.28);
        }

        .alert-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(28, 36, 52, 0.14);
            border-radius: 12px;
            padding: 18px;
            background: rgba(244, 247, 254, 0.9);
            box-shadow: inset 0 12px 24px rgba(14, 20, 36, 0.06);
        }

        .alert-item {
            padding: 14px 18px;
            border-left: 4px solid #3c6ee8;
            background: rgba(255, 255, 255, 0.94);
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 10px 22px rgba(14, 20, 36, 0.14);
        }

        .alert-item.first { border-left-color: #44bbaa; }
        .alert-item.middle { border-left-color: #f6b93b; }
        .alert-item.final { border-left-color: #d64541; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1080px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .admin-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- ç®¡ç†è€…èªè¨¼ç”»é¢ -->
    <div class="auth-screen" id="admin-auth-screen">
        <div class="auth-card">
            <h1 class="auth-title">ğŸ”§ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
            <div style="margin-bottom: 30px; color: rgba(30, 41, 59, 0.65);">
                ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…å°‚ç”¨ç”»é¢ã§ã™<br>
                ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
            </div>
            <form id="admin-auth-form">
                <input 
                    type="password" 
                    id="admin-password" 
                    class="auth-input"
                    placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                    required
                />
                <button type="submit" class="auth-btn">
                    ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </form>
            <div class="auth-error" id="auth-error">
                âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“
            </div>
            <div style="margin-top: 30px;">
                <a href="pages/marugo.html" style="color: #3c6ee8; text-decoration: none;">
                    â† ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã«æˆ»ã‚‹
                </a>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div class="app-shell" id="admin-main" style="display: none;">
        <aside class="sidebar">
            <div>
                <h2>MARUGO ç®¡ç†</h2>
                <p>é‹ç”¨çŠ¶æ³ã¨è¨­å®šã‚’ã¾ã¨ã‚ã¦ç®¡ç†ã§ãã¾ã™ã€‚</p>
            </div>
            <nav class="nav-section">
                <a class="nav-link" href="#card-usage">ğŸ“Š ä½¿ç”¨é‡ã‚µãƒãƒª</a>
                <a class="nav-link" href="#card-access">ğŸ›‚ ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´</a>
                <a class="nav-link" href="#card-limit">âš™ï¸ ä¸Šé™è¨­å®š</a>
                <a class="nav-link" href="#card-indicator">ğŸ¨ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼</a>
                <a class="nav-link" href="#card-alerts">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</a>
                <a class="nav-link" href="#card-password">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</a>
                <a class="nav-link" href="#card-chart">ğŸ“ˆ æœˆæ¬¡ã‚°ãƒ©ãƒ•</a>
                <a class="nav-link" href="#card-mismatch">âŒ ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆ</a>
                <a class="nav-link" href="#card-system">ğŸ§­ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</a>
            </nav>
            <div class="nav-section">
                <a class="nav-link subtle" href="pages/marugo.html">â† ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹</a>
            </div>
        </aside>
        <div class="main-view">
        <div class="header">
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="nav-toggle" id="nav-toggle" type="button" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ‡æ›¿" aria-expanded="true">â˜°</button>
                <div>
                    <h1 class="admin-title">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ç”»é¢</h1>
                    <p class="main-subtitle">API ä½¿ç”¨é‡ã¨ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä¸€å…ƒç®¡ç†</p>
                </div>
            </div>
            <button class="logout-btn" onclick="adminLogout()">
                ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>

        <section class="dashboard-section" id="section-overview">
            <h2 class="section-heading">ğŸ“Š ä½¿ç”¨é‡ã‚µãƒãƒª</h2>
            <p class="section-description">æ—¥æ¬¡ãƒ»æœˆæ¬¡ã®åˆ©ç”¨çŠ¶æ³ã¨ç«¯æœ«åˆ¥ã®æ¦‚è¦ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
            <div class="dashboard-grid">
            <!-- APIä½¿ç”¨é‡ç›£è¦– -->
            <div class="dashboard-card" id="card-usage">
                <h3 class="card-title">ğŸ“Š APIä½¿ç”¨é‡ç›£è¦–</h3>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“… ä»Šæ—¥ã®ä½¿ç”¨é‡</div>
                    <div class="usage-display" id="daily-usage">0/300</div>
                    <div class="usage-bar">
                        <div class="usage-fill safe" id="daily-usage-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">ğŸ“† ä»Šæœˆã®ä½¿ç”¨é‡</div>
                    <div class="usage-display" id="monthly-usage">0/3,000</div>
                    <div class="usage-bar">
                        <div class="usage-fill safe" id="monthly-usage-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn secondary" onclick="refreshUsageData()">
                        ğŸ”„ ä½¿ç”¨é‡æ›´æ–°
                    </button>
                    <button class="btn warning" onclick="resetUsageStats()">
                        ğŸ—‘ï¸ çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
                    </button>
                </div>
            </div>

            <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªAPIä½¿ç”¨é‡è¡¨ç¤º -->
            <div class="dashboard-card" id="card-simple">
                <h3 class="card-title">ğŸ“Š ä½¿ç”¨çŠ¶æ³</h3>
                
                <div id="simple-usage-display" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 20px;
                    margin-top: 20px;
                ">
                    <div style="color: rgba(31, 42, 61, 0.55);">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ -->
            <div class="dashboard-card" id="card-access">
                <h3 class="card-title">ğŸ›‚ ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´</h3>
                <p class="card-subtitle">æœ€æ–°50ä»¶ã‚’Supabaseã«ä¿å­˜ã—ã€è‡ªå‹•ã§å¤ã„å±¥æ­´ã‚’æ•´ç†ã—ã¾ã™ã€‚</p>
                <div class="access-log-warning" id="access-log-warning">
                    âš ï¸ çŸ­æ™‚é–“ã«å¤§é‡ã®APIå‘¼ã³å‡ºã—ãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸã€‚ç®¡ç†è€…ã¸é€£çµ¡ã—ã¦çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                </div>
                <div class="access-log-list" id="access-log-list">
                    <div class="access-log-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div class="access-log-footer">
                    <button class="btn secondary" type="button" onclick="loadAccessLogs(true)">ğŸ”„ å±¥æ­´ã‚’æ›´æ–°</button>
                    <button class="btn" type="button" onclick="exportAccessLogsCSV()">â¬‡ï¸ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆ -->
            <div class="dashboard-card" id="card-data-mismatch">
                <h3 class="card-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                <p class="card-subtitle">é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã¨ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã®ä¸ä¸€è‡´ã‚’è©³ç´°ã«è¨˜éŒ²ãƒ»åˆ†æã—ã¾ã™ã€‚</p>
                <div class="data-mismatch-warning" id="data-mismatch-warning" style="display: none;">
                    âš ï¸ ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                </div>
                <div class="data-mismatch-list" id="data-mismatch-list">
                    <div class="data-mismatch-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div class="data-mismatch-footer">
                    <button class="btn secondary" type="button" onclick="loadDataMismatchReports(true)">ğŸ”„ ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°</button>
                    <button class="btn danger" type="button" onclick="deleteAllDataMismatchReports()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼ç®¡ç† -->
            <div class="dashboard-card" id="card-data-retention">
                <h3 class="card-title">ğŸ—‚ï¸ ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼</h3>
                <p class="card-subtitle">ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒæœŸé–“ã‚’ç®¡ç†ã—ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã™ã€‚</p>
                
                <div style="background: rgba(43, 182, 122, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #2bb67a;">ğŸ“Š ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ä¿æŒçŠ¶æ³</h4>
                    <div id="data-retention-status">
                        <div style="color: rgba(31, 42, 61, 0.55);">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                
                <div style="background: rgba(214, 69, 65, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #d64541;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼</h4>
                    <ul style="margin: 0; font-size: 14px; color: rgba(31, 42, 61, 0.7);">
                        <li><strong>ä¿æŒæœŸé–“:</strong> 6ãƒ¶æœˆï¼ˆ180æ—¥ï¼‰</li>
                        <li><strong>è‡ªå‹•å‰Šé™¤:</strong> 6ãƒ¶æœˆå‰ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™</li>
                        <li><strong>å¯¾è±¡ãƒ‡ãƒ¼ã‚¿:</strong> æ—¥æ¬¡çµ±è¨ˆã€æœˆæ¬¡çµ±è¨ˆã€ãƒ‡ãƒã‚¤ã‚¹çµ±è¨ˆ</li>
                        <li><strong>ç·è¨ˆçµ±è¨ˆ:</strong> å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼ˆç´¯ç©ãƒ‡ãƒ¼ã‚¿ï¼‰</li>
                    </ul>
                </div>
                
                <div class="action-buttons">
                    <button class="btn" type="button" onclick="loadDataRetentionStatus()">ğŸ”„ çŠ¶æ³ã‚’æ›´æ–°</button>
                    <button class="btn secondary" type="button" onclick="manualCleanupOldData()">ğŸ—‘ï¸ æ‰‹å‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</button>
                    <button class="btn danger" type="button" onclick="clearAllUsageData()">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                </div>
                
                <div id="cleanup-status" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;">
                    <!-- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—çµæœè¡¨ç¤º -->
                </div>
            </div>


            </div>
        </section>

        <section class="dashboard-section" id="section-settings">
            <h2 class="section-heading">âš™ï¸ ä¸Šé™ã¨ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼</h2>
            <p class="section-description">API ä½¿ç”¨é‡ã®é–¾å€¤ã‚„ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºã‚’èª¿æ•´ã—ã¾ã™ã€‚</p>
            <div class="dashboard-grid">
            <!-- APIä½¿ç”¨é‡ä¸Šé™è¨­å®š -->
            <div class="dashboard-card" id="card-limit">
                <h3 class="card-title">ğŸš« APIä½¿ç”¨é‡ä¸Šé™è¨­å®š</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(246, 185, 59, 0.2); border-radius: 8px; border-left: 4px solid #f6b93b;">
                    <p style="font-size: 14px; color: #856404; margin: 0 0 15px 0;">
                        æœˆé–“APIä½¿ç”¨é‡ã®ä¸Šé™å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã®å€¤ã‚’è¶…ãˆã‚‹ã¨APIã‚¢ã‚¯ã‚»ã‚¹ãŒè‡ªå‹•çš„ã«é®æ–­ã•ã‚Œã¾ã™ã€‚
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“Š æœˆé–“APIä½¿ç”¨é‡ä¸Šé™ï¼ˆå›æ•°ï¼‰</label>
                        <input type="number" id="api-limit" class="form-input" placeholder="2500" min="100" max="10000" step="100">
                        <small style="color: rgba(31, 42, 61, 0.55);">æ¨å¥¨å€¤: 2,500å› (Google Sheets APIç„¡æ–™æ ã®ç´„83%)</small>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="saveAPILimitSettings()" class="btn">ğŸ’¾ ä¸Šé™å€¤ã‚’ä¿å­˜</button>
                        <button onclick="loadAPILimitSettings()" class="btn secondary">ğŸ”„ è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
                        <button onclick="resetAPILimitSettings()" class="btn secondary">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                    </div>
                </div>
                
                <div style="background: rgba(214, 69, 65, 0.15); padding: 15px; border-radius: 10px; border-left: 4px solid #d64541;">
                    <h4 style="margin: 0 0 10px 0; color: #721c24;">âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</h4>
                    <ul style="margin: 0; color: #721c24; font-size: 14px;">
                        <li>ä¸Šé™å€¤ã‚’ä¸‹ã’ã‚‹ã¨ã€ç¾åœ¨ã®ä½¿ç”¨é‡ãŒä¸Šé™ã‚’è¶…ãˆãŸå ´åˆã¯å³åº§ã«é®æ–­ã•ã‚Œã¾ã™</li>
                        <li>Google Sheets APIç„¡æ–™æ ã¯æœˆé–“3,000å›ã§ã™</li>
                        <li>å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ã‚’è€ƒæ…®ã—ã¦2,500å›ç¨‹åº¦ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™</li>
                    </ul>
                </div>
                
                <div id="limit-status" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0;">ğŸ“Š ç¾åœ¨ã®è¨­å®šçŠ¶æ³</h4>
                    <div id="limit-status-content">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ä½¿ç”¨é‡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®š -->
            <div class="dashboard-card" id="card-indicator">
                <h3 class="card-title">ğŸ¨ ä½¿ç”¨é‡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è‰²è¨­å®š</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(244, 247, 254, 0.9); border-radius: 8px;">
                    <p style="font-size: 14px; color: rgba(31, 42, 61, 0.55); margin: 0 0 15px 0;">
                        å…¨ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ä½¿ç”¨é‡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è‰²å¤‰åŒ–ã®é–¾å€¤ã‚’è¨­å®šã§ãã¾ã™ã€‚
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸŸ¢ ç·‘è‰²ã®é–¾å€¤ï¼ˆå›æ•°ï¼‰</label>
                        <input type="number" id="orange-threshold" class="form-input" placeholder="900" min="1" max="3000">
                        <small style="color: rgba(31, 42, 61, 0.55);">ã“ã®å›æ•°ä»¥ä¸Šã§ç·‘è‰²ã«å¤‰åŒ–</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸŸ¡ é»„è‰²ã®é–¾å€¤ï¼ˆå›æ•°ï¼‰</label>
                        <input type="number" id="yellow-threshold" class="form-input" placeholder="1500" min="1" max="3000">
                        <small style="color: rgba(31, 42, 61, 0.55);">ã“ã®å›æ•°ä»¥ä¸Šã§é»„è‰²ã«å¤‰åŒ–</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ”´ èµ¤è‰²ã®é–¾å€¤ï¼ˆå›æ•°ï¼‰</label>
                        <input type="number" id="red-threshold" class="form-input" placeholder="2400" min="1" max="3000">
                        <small style="color: rgba(31, 42, 61, 0.55);">ã“ã®å›æ•°ä»¥ä¸Šã§èµ¤è‰²ã«å¤‰åŒ–</small>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="saveIndicatorSettings()" class="btn">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                        <button onclick="loadIndicatorSettings()" class="btn secondary">ğŸ”„ è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
                        <button onclick="resetIndicatorSettings()" class="btn secondary">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0;">ğŸ“Š ç¾åœ¨ã®è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                    <div id="indicator-preview" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            </div>
        </section>

        <section class="dashboard-section" id="section-alerts">
            <h2 class="section-heading">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</h2>
            <p class="section-description">é€šçŸ¥ã‚„é–¾å€¤ã‚’èª¿æ•´ã—ã€ä¸Šé™åˆ°é”æ™‚ã®å¯¾å¿œã‚’å®šç¾©ã—ã¾ã™ã€‚</p>
            <div class="dashboard-grid">
            <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š -->
            <div class="dashboard-card" id="card-alerts">
                <h3 class="card-title">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</h3>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“Š åˆå›è­¦å‘Š (ä»¶æ•°):</label>
                    <input type="number" id="first-warning-threshold" class="form-input" value="1000" min="1" max="3000">
                </div>

                <div class="form-group">
                    <label class="form-label">âš ï¸ ä¸­é–“è­¦å‘Š (ä»¶æ•°):</label>
                    <input type="number" id="middle-warning-threshold" class="form-input" value="2000" min="1" max="3000">
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸš¨ æœ€çµ‚è­¦å‘Š (ä»¶æ•°):</label>
                    <input type="number" id="final-warning-threshold" class="form-input" value="2800" min="1" max="3000">
                </div>

                <button class="btn" onclick="saveAlertSettings()">
                    ğŸ’¾ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šä¿å­˜
                </button>

                <div id="alert-settings-status"></div>
            </div>

            <!-- è­¦å‘Šã‚·ã‚¹ãƒ†ãƒ èª¬æ˜ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ -->

            </div>
        </section>

        <section class="dashboard-section" id="section-security">
            <h2 class="section-heading">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</h2>
            <p class="section-description">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ç®¡ç†ç”»é¢ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å®‰å…¨ã«æ›´æ–°ã—ã¾ã™ã€‚</p>
            <div class="dashboard-grid">
            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç† -->
            <div class="dashboard-card" id="card-password">
                <h3 class="card-title">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</h3>
                
                <div style="margin-bottom: 30px; padding: 15px; background: rgba(244, 247, 254, 0.9); border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ  ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</h4>
                    <p style="font-size: 14px; color: rgba(31, 42, 61, 0.55); margin: 0 0 15px 0;">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</p>
                    
                    <div class="form-group">
                        <label class="form-label">ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="current-system-password" class="form-input" placeholder="ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="new-system-password" class="form-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                        <input type="password" id="confirm-system-password" class="form-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
                    </div>
                    
                    <button onclick="changeSystemPassword()" class="btn">ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                    <button onclick="checkCurrentSystemPassword()" class="btn secondary" style="margin-left: 10px;">ğŸ” ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</button>
                </div>
                
                <div style="margin-bottom: 30px; padding: 15px; background: #fff5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ”§ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</h4>
                    <p style="font-size: 14px; color: rgba(31, 42, 61, 0.55); margin: 0 0 15px 0;">ã“ã®ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</p>
                    
                    <div class="form-group">
                        <label class="form-label">ç¾åœ¨ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="current-admin-password" class="form-input" placeholder="ç¾åœ¨ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ–°ã—ã„ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="new-admin-password" class="form-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ–°ã—ã„ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                        <input type="password" id="confirm-admin-password" class="form-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
                    </div>
                    
                    <button onclick="changeAdminPassword()" class="btn" style="background: linear-gradient(45deg, #d64541, #c82333);">ğŸ”§ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                    <button onclick="checkCurrentAdminPassword()" class="btn secondary" style="margin-left: 10px;">ğŸ” ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</button>
                </div>
                
                <div id="password-change-status" style="margin-top: 15px;"></div>
            </div>

            </div>
        </section>

        <section class="dashboard-section" id="section-analytics">
            <h2 class="section-heading">ğŸ“ˆ ãƒ­ã‚°ã¨ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
            <p class="section-description">æœˆæ¬¡ã®ä½¿ç”¨é‡æ¨ç§»ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ç¨¼åƒçŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
            <div class="dashboard-grid">
            <!-- æœˆæ¬¡ä½¿ç”¨é‡ã‚°ãƒ©ãƒ• -->
            <div class="dashboard-card" id="card-chart">
                <h3 class="card-title">ğŸ“ˆ æœˆæ¬¡ä½¿ç”¨é‡ã‚°ãƒ©ãƒ•</h3>
                
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <label for="month-selector" style="font-weight: 600;">è¡¨ç¤ºæœˆ:</label>
                    <select id="month-selector" class="form-input" style="width: auto; min-width: 150px;" onchange="loadMonthlyChart()">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                    <button class="btn secondary" onclick="loadMonthlyChart()">
                        ğŸ”„ æ›´æ–°
                    </button>
                </div>

                <div id="chart-container" style="position: relative;">
                    <canvas id="monthly-chart" width="800" height="400" style="max-width: 100%; border: 1px solid rgba(28, 36, 52, 0.16); border-radius: 12px; background: rgba(244, 247, 254, 0.95);"></canvas>
                </div>

                <div id="chart-summary" style="
                    margin-top: 20px;
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                    gap: 15px;
                    padding: 15px;
                    background: rgba(60, 90, 160, 0.12);
                    border-radius: 14px;
                ">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>


            <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ -->
            <div class="dashboard-card" id="card-system">
                <h3 class="card-title">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
                
                <div id="system-status-display">
                    <div style="color: rgba(31, 42, 61, 0.55);">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn secondary" onclick="checkSystemStatus()">
                        ğŸ” çŠ¶æ…‹ç¢ºèª
                    </button>
                    <button class="btn success" onclick="runSystemOptimization()">
                        âš¡ æœ€é©åŒ–å®Ÿè¡Œ
                    </button>
                </div>
            </div>

            </div>
        </section>
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(28, 36, 52, 0.16);">
            <a href="pages/marugo.html" style="
                color: #3c6ee8;
                text-decoration: none;
                font-weight: 600;
                padding: 12px 24px;
                border: 2px solid rgba(60, 110, 232, 0.4);
                border-radius: 10px;
                transition: all 0.3s ease;
                display: inline-flex;
                gap: 8px;
                align-items: center;
            " onmouseover="this.style.boxShadow='0 16px 28px rgba(60,110,232,0.24)';" onmouseout="this.style.boxShadow='none';">ğŸ“Š ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã«æˆ»ã‚‹</a>
        </div>
    </div>
</div>

    <script src="config.js?v=2025011606"></script>
    <script src="js/quota-alert-system.js?v=2025011606"></script>
    <script src="js/simple-optimization.js?v=2025011606"></script>
    
    <script>
        // ç®¡ç†è€…èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
        class AdminAuth {
            constructor() {
                this.SESSION_KEY = 'adminSession';
                this.SESSION_DURATION = 2 * 60 * 60 * 1000; // 2æ™‚é–“
                
                this.init();
            }

            init() {
                if (this.isAuthenticated()) {
                    this.showAdminPanel();
                } else {
                    this.showAuthScreen();
                }

                this.setupEventListeners();
            }

            setupEventListeners() {
                const authForm = document.getElementById('admin-auth-form');
                if (authForm) {
                    authForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        console.log('ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡');
                        this.handleAuth();
                    });
                }

                const passwordInput = document.getElementById('admin-password');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            console.log('ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ Enterã‚­ãƒ¼');
                            this.handleAuth();
                        }
                    });
                }
                
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã‚‚å¯¾å¿œ
                const loginBtn = document.querySelector('.auth-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', (e) => {
                        if (e.target.type !== 'submit') {
                            e.preventDefault();
                            console.log('ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                            this.handleAuth();
                        }
                    });
                }
                
                console.log('ğŸ” ç®¡ç†è€…èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
            }

            async handleAuth() {
                const password = document.getElementById('admin-password').value;
                const errorDiv = document.getElementById('auth-error');
                const loginBtn = document.querySelector('.auth-btn');

                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'ğŸ”„ èªè¨¼ä¸­...';
                }

                try {
                    // Supabaseã§ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
                    const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            action: 'verify',
                            passwordType: 'admin',
                            currentPassword: password
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.isValid) {
                        this.setAuthenticated();

                        const baseline = await fetchTotalApiInteractions();
                        if (typeof baseline === 'number') {
                            setApiBaseline(baseline);
                        }

                        await recordAdminAccess('admin_login', 'ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«æˆåŠŸ', 0);
                        if (errorDiv) {
                            errorDiv.style.display = 'none';
                        }
                        const passwordInputEl = document.getElementById('admin-password');
                        if (passwordInputEl) {
                            passwordInputEl.value = '';
                        }
                        this.showAdminPanel(true);
                        console.log('âœ… ç®¡ç†è€…èªè¨¼æˆåŠŸï¼ˆSupabaseï¼‰');
                    } else {
                        errorDiv.style.display = 'block';
                        errorDiv.style.animation = 'shake 0.5s';
                        document.getElementById('admin-password').value = '';
                        
                        setTimeout(() => {
                            errorDiv.style.animation = '';
                        }, 500);
                    }
                } catch (error) {
                    console.error('ç®¡ç†è€…èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'âŒ èªè¨¼å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                }

                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³';
                }
            }

            isAuthenticated() {
                const session = localStorage.getItem(this.SESSION_KEY);
                if (!session) return false;

                try {
                    const data = JSON.parse(session);
                    const now = Date.now();
                    return (now - data.timestamp) < this.SESSION_DURATION;
                } catch {
                    return false;
                }
            }

            setAuthenticated() {
                const sessionData = {
                    timestamp: Date.now(),
                    authenticated: true
                };
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
            }

            showAuthScreen() {
                document.getElementById('admin-auth-screen').style.display = 'flex';
                document.getElementById('admin-main').style.display = 'none';
                
                setTimeout(() => {
                    document.getElementById('admin-password').focus();
                }, 300);
            }

            showAdminPanel(skipAccessRecord = false) {
                document.getElementById('admin-auth-screen').style.display = 'none';
                document.getElementById('admin-main').style.display = 'grid';

                prepareAccessLogRecord(skipAccessRecord).catch(error => {
                    console.warn('ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´æº–å‚™ã‚¨ãƒ©ãƒ¼:', error);
                });

                // ç®¡ç†ç”»é¢ã®åˆæœŸåŒ–
                setTimeout(() => {
                    initializeAdminPanel();
                }, 100);
            }

            logout() {
                localStorage.removeItem(this.SESSION_KEY);
                if (window._accessLogRefresh) {
                    clearInterval(window._accessLogRefresh);
                    window._accessLogRefresh = null;
                }
                clearApiBaseline();
                this.showAuthScreen();
            }
        }

        const ACCESS_EVENT_LABELS = {
            admin_login: 'ğŸŸ¢ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³',
            admin_session: 'ğŸ“˜ ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹',
            admin_logout: 'ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
        };
        const ACCESS_LOG_BASELINE_KEY = 'adminSessionApiBaseline';

        function loadStoredApiBaseline() {
            if (typeof sessionStorage === 'undefined') return;
            try {
                const stored = sessionStorage.getItem(ACCESS_LOG_BASELINE_KEY);
                if (stored !== null) {
                    const parsed = Number(stored);
                    if (Number.isFinite(parsed)) {
                        window._adminSessionApiBaseline = parsed;
                    }
                }
            } catch (error) {
                console.warn('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°åŸºæº–å€¤ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function setApiBaseline(value) {
            if (typeof value !== 'number' || !Number.isFinite(value)) return;
            const normalized = Math.max(0, Math.round(value));
            window._adminSessionApiBaseline = normalized;
            if (typeof sessionStorage === 'undefined') return;
            try {
                sessionStorage.setItem(ACCESS_LOG_BASELINE_KEY, String(normalized));
            } catch (error) {
                console.warn('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°åŸºæº–å€¤ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function clearApiBaseline() {
            window._adminSessionApiBaseline = null;
            if (typeof sessionStorage === 'undefined') return;
            try {
                sessionStorage.removeItem(ACCESS_LOG_BASELINE_KEY);
            } catch (error) {
                console.warn('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°åŸºæº–å€¤ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        loadStoredApiBaseline();

        async function fetchTotalApiInteractions() {
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({ action: 'get' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const stats = await response.json();
                const total = stats?.total?.total;

                if (typeof total === 'number' && Number.isFinite(total)) {
                    return total;
                }

                if (typeof total === 'string') {
                    const parsed = Number(total);
                    if (Number.isFinite(parsed)) {
                        return parsed;
                    }
                }

                return null;
            } catch (error) {
                console.warn('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ç”¨APIä½¿ç”¨é‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        async function ensureApiBaseline() {
            if (typeof window._adminSessionApiBaseline === 'number' && Number.isFinite(window._adminSessionApiBaseline)) {
                return window._adminSessionApiBaseline;
            }

            loadStoredApiBaseline();

            if (typeof window._adminSessionApiBaseline === 'number' && Number.isFinite(window._adminSessionApiBaseline)) {
                return window._adminSessionApiBaseline;
            }

            const fetched = await fetchTotalApiInteractions();
            if (typeof fetched === 'number') {
                setApiBaseline(fetched);
                return fetched;
            }

            return null;
        }

        async function calculateSessionApiDelta() {
            const baseline = await ensureApiBaseline();
            if (typeof baseline !== 'number') {
                return 0;
            }

            const current = await fetchTotalApiInteractions();
            if (typeof current === 'number') {
                const diff = current - baseline;
                return diff > 0 ? Math.round(diff) : 0;
            }

            return 0;
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            const stringValue = typeof value === 'string' ? value : String(value);
            const replacements = {
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                "\"": "&quot;",
                "'": "&#39;"
            };
            return stringValue.replace(/[&<>"']/g, (char) => replacements[char] || char);
        }

        function formatAccessDeviceInfo(info) {
            if (!info || typeof info !== 'object') {
                return 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ãªã—';
            }
            const segments = [];
            if (info.platform) segments.push(info.platform);
            if (info.timezone) segments.push(info.timezone);
            if (info.screen) segments.push(`ç”»é¢ ${info.screen}`);
            if (info.language) segments.push(info.language);
            return segments.join(' ãƒ» ') || 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ãªã—';
        }

        function getAccessDeviceInfo() {
            try {
                const timezone = Intl?.DateTimeFormat?.().resolvedOptions?.().timeZone;
                const screenInfo = window.screen ? `${window.screen.width}x${window.screen.height}` : undefined;
                return {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    timezone,
                    screen: screenInfo
                };
            } catch (_error) {
                return {};
            }
        }

        function renderAccessLogs(logs) {
            const container = document.getElementById('access-log-list');
            const warningBox = document.getElementById('access-log-warning');
            if (!container) return;

            const logList = Array.isArray(logs) ? logs : [];
            window._accessLogCache = logList.slice();

            if (logList.length === 0) {
                container.innerHTML = '<div class="access-log-placeholder">ğŸ“­ ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
                if (warningBox) warningBox.style.display = 'none';
                updatePendingAlertState([]);
                return;
            }

            let hasHighUsage = false;
            const pendingAlerts = [];

            const rows = logList.map((log) => {
                const apiCount = typeof log.api_call_count === 'number' ? log.api_call_count : Number(log.api_call_count || 0);
                const isAlert = !!log.alert_flag;
                const isAcknowledged = !!log.acknowledged;
                const isActiveAlert = isAlert && !isAcknowledged;
                if (isActiveAlert) {
                    hasHighUsage = true;
                    pendingAlerts.push(log);
                }

                const label = ACCESS_EVENT_LABELS[log.event_type] || log.event_type;
                const timestamp = log.created_at ? new Date(log.created_at).toLocaleString('ja-JP') : 'æ—¥æ™‚ä¸æ˜';
                const description = log.description ? escapeHtml(log.description) : 'è©³ç´°æƒ…å ±ãªã—';
                const actorName = log.actor ? escapeHtml(log.actor) : 'ç®¡ç†è€…';
                const deviceInfo = escapeHtml(formatAccessDeviceInfo(log.device_info));

                const statusClass = isAlert ? (isAcknowledged ? 'resolved' : 'pending') : 'normal';
                const statusIcon = isAlert ? (isAcknowledged ? 'âœ…' : 'âš ï¸') : 'â„¹ï¸';
                let statusText = isAlert ? (isAcknowledged ? 'ç¢ºèªæ¸ˆã¿' : 'æœªç¢ºèª') : 'é€šå¸¸';
                if (isAcknowledged && log.acknowledged_at) {
                    const ackTime = new Date(log.acknowledged_at).toLocaleString('ja-JP');
                    statusText += ` (${ackTime})`;
                }
                if (isAcknowledged && log.acknowledged_by) {
                    statusText += ` / ${escapeHtml(log.acknowledged_by)}`;
                }

                const actions = [];

                if (isAlert) {
                    actions.push(`<button class="access-log-action ${isAcknowledged ? '' : 'primary'}" data-id="${log.id}" data-action="${isAcknowledged ? 'unack' : 'ack'}">${isAcknowledged ? 'æœªç¢ºèªã«æˆ»ã™' : 'ç¢ºèªæ¸ˆã¿ã«ã™ã‚‹'}</button>`);
                }

                const deleteDisabled = isAlert && !isAcknowledged;
                actions.push(`<button class="access-log-action danger" data-id="${log.id}" data-action="delete" ${deleteDisabled ? 'disabled title=\"ç¢ºèªå¾Œã«å‰Šé™¤ã§ãã¾ã™\"' : ''}>ğŸ—‘ï¸ å‰Šé™¤</button>`);

                return `
                    <div class="access-log-item${isActiveAlert ? ' alert' : ''}" data-log-id="${log.id}">
                        <div class="access-log-meta">
                            <span class="access-log-event">${escapeHtml(label)}</span>
                            <span class="access-log-time">${escapeHtml(timestamp)}</span>
                        </div>
                        <div class="access-log-description">${description}</div>
                        <div class="access-log-stats">
                            <span class="access-log-status ${statusClass}">${statusIcon} ${statusText}</span>
                            <span>ğŸ‘¤ ${actorName}</span>
                            <span>ğŸ–¥ï¸ ${deviceInfo}</span>
                            <span>ğŸ” API ${apiCount}å›</span>
                        </div>
                        <div class="access-log-actions">${actions.join('')}</div>
                    </div>
                `;
            });

            container.innerHTML = rows.join('');

            if (warningBox) {
                warningBox.style.display = hasHighUsage ? 'block' : 'none';
            }

            updatePendingAlertState(pendingAlerts);
            setupAccessLogActionHandlers();
        }

        function updatePendingAlertState(pendingAlerts) {
            const pendingIds = pendingAlerts.map(log => log.id).sort((a, b) => a - b).join(',');
            window._pendingAlertSnapshot = pendingIds;
            window._pendingAlertCount = pendingAlerts.length;
            checkAndShowSystemAlert();
        }

        function checkAndShowSystemAlert(force = false) {
            const overlay = document.getElementById('system-alert-overlay');
            const messageEl = document.getElementById('system-alert-message');
            const confirmBtn = document.getElementById('system-alert-confirm');
            if (!overlay || !messageEl || !confirmBtn) return;

            const pendingCount = window._pendingAlertCount || 0;
            if (pendingCount === 0) {
                overlay.style.display = 'none';
                return;
            }

            const snapshot = window._pendingAlertSnapshot || '';
            const storageKey = 'adminPendingAlertsShown';
            let alreadyShown = false;
            try {
                const stored = sessionStorage.getItem(storageKey);
                alreadyShown = stored === snapshot;
            } catch (error) {
                console.warn('ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºçŠ¶æ…‹ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }

            if (!force && alreadyShown) {
                return;
            }

            messageEl.innerHTML = `âš ï¸ å¤§é‡ã®APIå‘¼ã³å‡ºã—ãŒ ${pendingCount} ä»¶ç¢ºèªã•ã‚Œã¾ã—ãŸã€‚<br>ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ã€Œç¢ºèªæ¸ˆã¿ã«ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
            overlay.style.display = 'flex';

            confirmBtn.onclick = () => {
                overlay.style.display = 'none';
                try {
                    sessionStorage.setItem(storageKey, snapshot);
                } catch (error) {
                    console.warn('ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºçŠ¶æ…‹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            };
        }



        function setupAccessLogActionHandlers() {
            const container = document.getElementById('access-log-list');
            if (!container || container.dataset.bound === 'true') return;

            container.addEventListener('click', async (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                const button = target.closest('.access-log-action');
                if (!button || !(button instanceof HTMLButtonElement) || button.disabled) return;

                const logId = Number(button.dataset.id);
                if (!Number.isFinite(logId) || logId <= 0) return;

                const action = button.dataset.action;
                if (action === 'ack') {
                    await updateAccessLogAcknowledgement(logId, true);
                } else if (action === 'unack') {
                    await updateAccessLogAcknowledgement(logId, false);
                } else if (action === 'delete') {
                    await deleteAccessLog(logId);
                }
            });

            container.dataset.bound = 'true';
        }

        async function updateAccessLogAcknowledgement(logId, acknowledged) {
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/access-logs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'acknowledge',
                        logId,
                        acknowledged,
                        updatedBy: 'admin_panel'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                renderAccessLogs(result.logs);

                if (acknowledged) {
                    alert('âš ï¸ å¯¾è±¡ã®å±¥æ­´ã‚’ç¢ºèªæ¸ˆã¿ã«ã—ã¾ã—ãŸã€‚');
                } else {
                    alert('å¯¾è±¡ã®å±¥æ­´ã‚’æœªç¢ºèªã«æˆ»ã—ã¾ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                alert(`âŒ å±¥æ­´ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ
${error.message || ''}`);
            }
        }

        async function deleteAccessLog(logId) {
            if (!confirm('é¸æŠã—ãŸã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/access-logs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        logId,
                        updatedBy: 'admin_panel'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                renderAccessLogs(result.logs);
                alert('ğŸ—‘ï¸ å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert(`âŒ å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ
${error.message || ''}`);
            }
        }


        async function exportAccessLogsCSV() {
            try {
                let logs = Array.isArray(window._accessLogCache) ? window._accessLogCache : [];

                if (!logs.length) {
                    await loadAccessLogs(true);
                    logs = Array.isArray(window._accessLogCache) ? window._accessLogCache : [];
                    if (!logs.length) {
                        alert('CSVã«å‡ºåŠ›ã§ãã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }
                }

                const headers = [
                    'ID',
                    'æ—¥æ™‚',
                    'ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥',
                    'å®Ÿè¡Œè€…',
                    'èª¬æ˜',
                    'APIå›æ•°',
                    'ã‚¢ãƒ©ãƒ¼ãƒˆ',
                    'ç¢ºèªæ¸ˆã¿',
                    'ç¢ºèªæ—¥æ™‚',
                    'ç¢ºèªè€…',
                    'ç«¯æœ«æƒ…å ±'
                ];

                const escapeCsv = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = typeof value === 'string' ? value : String(value);
                    return '"' + str.replace(/"/g, '""') + '"';
                };

                const rows = logs.map((log) => {
                    const deviceInfo = log.device_info ? JSON.stringify(log.device_info) : '';
                    return [
                        log.id,
                        log.created_at ? new Date(log.created_at).toLocaleString('ja-JP') : '',
                        log.event_type || '',
                        log.actor || '',
                        log.description || '',
                        typeof log.api_call_count === 'number' ? log.api_call_count : '',
                        log.alert_flag ? 'TRUE' : 'FALSE',
                        log.acknowledged ? 'TRUE' : 'FALSE',
                        log.acknowledged_at ? new Date(log.acknowledged_at).toLocaleString('ja-JP') : '',
                        log.acknowledged_by || '',
                        deviceInfo
                    ].map(escapeCsv).join(',');
                });

                const csvContent = [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
                const link = document.createElement('a');
                link.href = url;
                link.download = `access-logs-${timestamp}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                alert(`âŒ CSVã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n${error.message || ''}`);
            }
        }

        async function loadAccessLogs(showLoading = false) {
            const container = document.getElementById('access-log-list');
            if (!container) return;

            if (showLoading) {
                container.innerHTML = '<div class="access-log-placeholder">ğŸ”„ å±¥æ­´ã‚’æ›´æ–°ä¸­...</div>';
            }

            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/access-logs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({ action: 'list' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                renderAccessLogs(result.logs);
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<div class="access-log-placeholder">âŒ å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        async function recordAdminAccess(eventType, description, apiCallCount = 0, options = {}) {
            try {
                const normalizedCount = typeof apiCallCount === 'number' && Number.isFinite(apiCallCount)
                    ? Math.max(0, Math.round(apiCallCount))
                    : 0;

                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/access-logs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'record',
                        eventType,
                        actor: 'admin',
                        description,
                        deviceInfo: getAccessDeviceInfo(),
                        apiCallCount: normalizedCount,
                        updatedBy: 'admin_panel'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                renderAccessLogs(result.logs);

                if (options.showWarning && normalizedCount >= 30 && typeof alert === 'function') {
                    alert('âš ï¸ çŸ­æ™‚é–“ã«30å›ä»¥ä¸Šã®APIå‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                return true;
            } catch (error) {
                console.warn('ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        async function prepareAccessLogRecord(skipAccessRecord) {
            await ensureApiBaseline();

            if (!skipAccessRecord) {
                const recorded = await recordAdminAccess('admin_session', 'æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç®¡ç†ç”»é¢ã‚’è¡¨ç¤º', 0);
                if (!recorded) {
                    await loadAccessLogs();
                }
            } else {
                await loadAccessLogs();
            }

            if (typeof checkAndShowSystemAlert === 'function') {
                checkAndShowSystemAlert(true);
            }
        }

        // ç®¡ç†ç”»é¢ã®åˆæœŸåŒ–
        // æœˆæ¬¡ã‚°ãƒ©ãƒ•é–¢é€£ã®é–¢æ•°
        
        // æœˆé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
        function initializeMonthSelector() {
            const selector = document.getElementById('month-selector');
            const currentDate = new Date();
            
            // éå»12ãƒ¶æœˆåˆ†ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                
                // æ™‚é–“å¸¯ã«ä¾å­˜ã—ãªã„æœˆã‚­ãƒ¼ç”Ÿæˆ
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // 0ãƒ™ãƒ¼ã‚¹â†’1ãƒ™ãƒ¼ã‚¹å¤‰æ›
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
                
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName;
                
                if (i === 0) option.selected = true; // ä»Šæœˆã‚’é¸æŠ
                
                selector.appendChild(option);
            }
        }
        
        // æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function getMonthlyChartData(targetMonth) {
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get_monthly_chart',
                        targetMonth: targetMonth
                    })
                });

                if (response.ok) {
                    const chartData = await response.json();
                    return chartData;
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }
        
        // ã‚°ãƒ©ãƒ•ã‚’æç”»
        function drawMonthlyChart(chartData) {
            const canvas = document.getElementById('monthly-chart');
            const ctx = canvas.getContext('2d');
            
            if (!canvas || !ctx) {
                console.error('âŒ ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æç”»è¨­å®š
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const maxValue = Math.max(chartData.summary.maxDailyUsage, 10); // æœ€å°10ã«è¨­å®š
            
            // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
            ctx.strokeStyle = 'rgba(30, 45, 78, 0.14)';
            ctx.lineWidth = 1;
            
            // æ¨ªç·šï¼ˆä½¿ç”¨é‡ï¼‰
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
                
                // Yè»¸ãƒ©ãƒ™ãƒ«
                ctx.fillStyle = 'rgba(31, 42, 61, 0.55)';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(maxValue - (maxValue / 5) * i), padding - 10, y + 4);
            }
            
            // ç¸¦ç·šï¼ˆæ—¥ä»˜ï¼‰
            const dayStep = Math.ceil(chartData.daysInMonth / 10); // æœ€å¤§10æœ¬ã®ç¸¦ç·š
            for (let day = 1; day <= chartData.daysInMonth; day += dayStep) {
                const x = padding + (chartWidth / chartData.daysInMonth) * (day - 1);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + chartHeight);
                ctx.stroke();
                
                // Xè»¸ãƒ©ãƒ™ãƒ«
                ctx.fillStyle = 'rgba(31, 42, 61, 0.55)';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${day}æ—¥`, x, padding + chartHeight + 20);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ç·šã‚’æç”»
            if (chartData.dailyData.length > 0) {
                
                // APIå‘¼ã³å‡ºã—ï¼ˆé’ï¼‰
                ctx.strokeStyle = '#3c6ee8';
                ctx.fillStyle = 'rgba(0, 123, 255, 0.1)';
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                chartData.dailyData.forEach((day, index) => {
                    const x = padding + (chartWidth / chartData.daysInMonth) * index;
                    const y = padding + chartHeight - (day.api_calls / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆç·‘ï¼‰
                ctx.strokeStyle = '#2bb67a';
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                chartData.dailyData.forEach((day, index) => {
                    const x = padding + (chartWidth / chartData.daysInMonth) * index;
                    const y = padding + chartHeight - (day.data_submissions / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // åˆè¨ˆï¼ˆèµ¤ã€å¤ªç·šï¼‰
                ctx.strokeStyle = '#d64541';
                ctx.lineWidth = 3;
                
                ctx.beginPath();
                chartData.dailyData.forEach((day, index) => {
                    const x = padding + (chartWidth / chartData.daysInMonth) * index;
                    const y = padding + chartHeight - (day.total / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’æç”»
                    if (day.total > 0) {
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, 2 * Math.PI);
                        ctx.fillStyle = '#d64541';
                        ctx.fill();
                    }
                });
                ctx.stroke();
            }
            
            // å‡¡ä¾‹
            const legendY = 30;
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            
            // APIå‘¼ã³å‡ºã—
            ctx.strokeStyle = '#3c6ee8';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding, legendY);
            ctx.lineTo(padding + 20, legendY);
            ctx.stroke();
            ctx.fillStyle = '#3c6ee8';
            ctx.fillText('APIå‘¼ã³å‡ºã—', padding + 30, legendY + 5);
            
            // ãƒ‡ãƒ¼ã‚¿é€ä¿¡
            ctx.strokeStyle = '#2bb67a';
            ctx.beginPath();
            ctx.moveTo(padding + 120, legendY);
            ctx.lineTo(padding + 140, legendY);
            ctx.stroke();
            ctx.fillStyle = '#2bb67a';
            ctx.fillText('ãƒ‡ãƒ¼ã‚¿é€ä¿¡', padding + 150, legendY + 5);
            
            // åˆè¨ˆ
            ctx.strokeStyle = '#d64541';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding + 240, legendY);
            ctx.lineTo(padding + 260, legendY);
            ctx.stroke();
            ctx.fillStyle = '#d64541';
            ctx.fillText('åˆè¨ˆ', padding + 270, legendY + 5);
        }
        
        // ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
        function displayChartSummary(chartData) {
            const summaryContainer = document.getElementById('chart-summary');
            
            summaryContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #d64541;">${chartData.summary.monthlyTotal}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">æœˆé–“åˆè¨ˆ</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 20px; font-weight: bold; color: #3c6ee8;">${chartData.summary.maxDailyUsage}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">æœ€å¤§æ—¥ä½¿ç”¨é‡</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #2bb67a;">${chartData.summary.avgDailyUsage}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">å¹³å‡æ—¥ä½¿ç”¨é‡</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #6f42c1;">${chartData.summary.activeDays}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥æ•°</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 16px; font-weight: bold; color: #44bbaa;">${chartData.daysInMonth}</div>
                    <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">ç·æ—¥æ•°</div>
                </div>
            `;
        }
        
        // æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadMonthlyChart() {
            const selector = document.getElementById('month-selector');
            const selectedMonth = selector.value;
            
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                const chartContainer = document.getElementById('chart-container');
                const summaryContainer = document.getElementById('chart-summary');
                
                chartContainer.style.opacity = '0.5';
                summaryContainer.innerHTML = '<div style="color: rgba(31, 42, 61, 0.55); text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</div>';
                
                // ãƒ‡ãƒ¼ã‚¿å–å¾—
                const chartData = await getMonthlyChartData(selectedMonth);
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                console.log('ğŸ“Š æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿:', chartData);
                console.log('ğŸ“ˆ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥æ•°:', chartData.summary.activeDays);
                console.log('ğŸ“… æœˆé–“åˆè¨ˆ:', chartData.summary.monthlyTotal);
                
                // ã‚°ãƒ©ãƒ•æç”»
                drawMonthlyChart(chartData);
                displayChartSummary(chartData);
                
                chartContainer.style.opacity = '1';
                
            } catch (error) {
                console.error('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                const summaryContainer = document.getElementById('chart-summary');
                summaryContainer.innerHTML = `
                    <div style="color: #d64541; text-align: center;">
                        âŒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                        <small>${error.message}</small>
                    </div>
                `;
                
                document.getElementById('chart-container').style.opacity = '1';
            }
        }

        function initializeAdminPanel() {
            const layoutShell = document.getElementById('admin-main');
            const navToggle = document.getElementById('nav-toggle');
            if (!layoutShell) return;
            const updateNavState = () => {
                if (!navToggle) return;
                const collapsed = layoutShell.classList.contains('nav-collapsed');
                navToggle.classList.toggle('active', collapsed);
                navToggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
            };
            if (navToggle && layoutShell && !navToggle.dataset.bound) {
                navToggle.addEventListener('click', () => {
                    layoutShell.classList.toggle('nav-collapsed');
                    updateNavState();
                });
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 1080) {
                        layoutShell.classList.remove('nav-collapsed');
                        updateNavState();
                    }
                });
                navToggle.dataset.bound = 'true';
            }
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 1080) {
                        layoutShell.classList.add('nav-collapsed');
                        updateNavState();
                    }
                });
            });
            if (window.innerWidth <= 1080) {
                layoutShell.classList.add('nav-collapsed');
                updateNavState();
            } else {
                layoutShell.classList.remove('nav-collapsed');
                updateNavState();
            }

            loadCurrentSettings();
            checkSystemStatus();
            
            // æœˆé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
            initializeMonthSelector();
            
            // quota-alert-systemã®åˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰ä½¿ç”¨é‡è¡¨ç¤º
            setTimeout(() => {
                loadSimpleUsageDisplay();
                refreshUsageData(); // APIä½¿ç”¨é‡ç›£è¦–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
                loadMonthlyChart(); // æœˆæ¬¡ã‚°ãƒ©ãƒ•ã‚‚åˆæœŸèª­ã¿è¾¼ã¿
                loadIndicatorSettings().catch(error => {
                    console.warn('ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }); // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šèª­ã¿è¾¼ã¿
                loadAPILimitSettings(); // APIä¸Šé™å€¤è¨­å®šèª­ã¿è¾¼ã¿
                loadAccessLogs(); // ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®åˆæœŸèª­ã¿è¾¼ã¿
                // ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã¯æ–°ã—ã„å®Ÿè£…ã‚’ä½¿ç”¨
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰
                setInterval(() => {
                    loadSimpleUsageDisplay();
                    refreshUsageData(); // APIä½¿ç”¨é‡ç›£è¦–ã‚‚å®šæœŸæ›´æ–°
                }, 30000);

                if (!window._accessLogRefresh) {
                    window._accessLogRefresh = setInterval(() => {
                        loadAccessLogs();
                    }, 60000);
                }
            }, 2000); // 2ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        }

        // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadCurrentSettings() {
            // ãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ

            // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ã‚’èª­ã¿è¾¼ã¿
            const savedThresholds = localStorage.getItem('alertThresholds');
            if (savedThresholds) {
                const thresholds = JSON.parse(savedThresholds);
                document.getElementById('first-warning-threshold').value = thresholds.first || 1000;
                document.getElementById('middle-warning-threshold').value = thresholds.middle || 2000;
                document.getElementById('final-warning-threshold').value = thresholds.final || 2800;
            }
        }

        // ä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆSupabaseãƒ™ãƒ¼ã‚¹ï¼‰
        async function refreshUsageData() {
            try {
                console.log('ğŸ”„ APIä½¿ç”¨é‡ç›£è¦–ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°é–‹å§‹...');
                
                let usage;
                
                // quota-alert-systemãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ä½¿ç”¨
                if (window.quotaAlertSystem && typeof window.quotaAlertSystem.getCurrentUsage === 'function') {
                    usage = await window.quotaAlertSystem.getCurrentUsage();
                } else {
                    
                    // ç›´æ¥Supabaseã‹ã‚‰å–å¾—
                    const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            action: 'get'
                        })
                    });

                    if (response.ok) {
                        const usageData = await response.json();
                        usage = {
                            daily: usageData.daily.total,
                            monthly: usageData.monthly.total,
                            total: usageData.total.total,
                            dailyPercentage: Math.round((usageData.daily.total / 300) * 100),
                            monthlyPercentage: Math.round((usageData.monthly.total / 3000) * 100)
                        };
                    } else {
                        throw new Error(`Supabaseå–å¾—ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                }
                
                // ç”»é¢æ›´æ–°
                if (usage && typeof usage.daily !== 'undefined' && typeof usage.monthly !== 'undefined') {
                    updateUsageDisplay(usage);
                } else {
                    throw new Error('ä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™');
                }
                
            } catch (error) {
                console.error('âŒ APIä½¿ç”¨é‡ç›£è¦–æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                document.getElementById('daily-usage').textContent = 'ã‚¨ãƒ©ãƒ¼/300';
                document.getElementById('monthly-usage').textContent = 'ã‚¨ãƒ©ãƒ¼/3,000';
            }
        }

        // ä½¿ç”¨é‡è¡¨ç¤ºã®æ›´æ–°
        function updateUsageDisplay(usage) {
            // æ—¥æ¬¡ä½¿ç”¨é‡
            document.getElementById('daily-usage').textContent = `${usage.daily}/300`;
            const dailyBar = document.getElementById('daily-usage-bar');
            dailyBar.style.width = `${Math.min(usage.dailyPercentage, 100)}%`;
            dailyBar.className = `usage-fill ${usage.dailyPercentage >= 85 ? 'danger' : usage.dailyPercentage >= 70 ? 'warning' : 'safe'}`;

            // æœˆæ¬¡ä½¿ç”¨é‡
            document.getElementById('monthly-usage').textContent = `${usage.monthly}/3,000`;
            const monthlyBar = document.getElementById('monthly-usage-bar');
            monthlyBar.style.width = `${Math.min(usage.monthlyPercentage, 100)}%`;
            monthlyBar.className = `usage-fill ${usage.monthlyPercentage >= 85 ? 'danger' : usage.monthlyPercentage >= 70 ? 'warning' : 'safe'}`;
        }

        // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã®ä¿å­˜
        function saveAdminEmail() {
            const email = document.getElementById('admin-email-input').value;
            const statusDiv = document.getElementById('email-settings-status');

            if (!email) {
                statusDiv.innerHTML = '<div class="status-error">âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                return;
            }

            if (!email.includes('@') || !email.includes('.')) {
                statusDiv.innerHTML = '<div class="status-error">âŒ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                return;
            }

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜
            localStorage.setItem('adminEmail', email);
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã«ã‚‚è¨­å®š
            if (typeof window.setAdminEmail === 'function') {
                window.setAdminEmail(email);
            }

            statusDiv.innerHTML = '<div class="status-success">âœ… ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>';
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ©Ÿèƒ½ï¼ˆSupabaseãƒ™ãƒ¼ã‚¹ï¼‰
        async function changeSystemPassword() {
            const currentPassword = document.getElementById('current-system-password').value;
            const newPassword = document.getElementById('new-system-password').value;
            const confirmPassword = document.getElementById('confirm-system-password').value;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordStatus('âŒ ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordStatus('âŒ æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordStatus('âŒ æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            showPasswordStatus('ğŸ”„ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­...', 'info');
            
            try {
                // ã¾ãšç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œè¨¼
                const verifyResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'verify',
                        passwordType: 'system',
                        currentPassword: currentPassword
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼çµæœ:', { success: verifyResult.success, match: verifyResult.isValid });
                
                if (!verifyResult.success || !verifyResult.isValid) {
                    showPasswordStatus('âŒ ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                // ğŸš€ è‡ªå‹•ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                showPasswordStatus('ğŸ”„ æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šä¸­...', 'info');
                
                const changeResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'change',
                        passwordType: 'system',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const changeResult = await changeResponse.json();
                console.log('ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´çµæœ:', changeResult);
                
                if (changeResult.success) {
                    showPasswordStatus('âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè‡ªå‹•ã§å¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼', 'success');
                } else {
                    showPasswordStatus(`âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¤±æ•—: ${changeResult.error}`, 'error');
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('current-system-password').value = '';
                document.getElementById('new-system-password').value = '';
                document.getElementById('confirm-system-password').value = '';
                
            } catch (error) {
                showPasswordStatus('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                console.error('System password change error:', error);
            }
        }
        
        // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ©Ÿèƒ½ï¼ˆSupabaseãƒ™ãƒ¼ã‚¹ï¼‰
        async function changeAdminPassword() {
            const currentPassword = document.getElementById('current-admin-password').value;
            const newPassword = document.getElementById('new-admin-password').value;
            const confirmPassword = document.getElementById('confirm-admin-password').value;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordStatus('âŒ ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordStatus('âŒ æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordStatus('âŒ æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            showPasswordStatus('ğŸ”„ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­...', 'info');
            
            try {
                // ã¾ãšç¾åœ¨ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œè¨¼
                const verifyResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'verify',
                        passwordType: 'admin',
                        currentPassword: currentPassword
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('ğŸ” ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼çµæœ:', { success: verifyResult.success, match: verifyResult.isValid });
                
                if (!verifyResult.success || !verifyResult.isValid) {
                    showPasswordStatus('âŒ ç¾åœ¨ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                // ğŸš€ è‡ªå‹•ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                showPasswordStatus('ğŸ”„ æ–°ã—ã„ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šä¸­...', 'info');
                
                const changeResponse = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'change',
                        passwordType: 'admin',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const changeResult = await changeResponse.json();
                console.log('ğŸ”„ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´çµæœ:', changeResult);
                
                if (changeResult.success) {
                    showPasswordStatus('âœ… ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè‡ªå‹•ã§å¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼', 'success');
                } else {
                    showPasswordStatus(`âŒ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¤±æ•—: ${changeResult.error}`, 'error');
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('current-admin-password').value = '';
                document.getElementById('new-admin-password').value = '';
                document.getElementById('confirm-admin-password').value = '';
                
            } catch (error) {
                showPasswordStatus('âŒ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                console.error('Admin password change error:', error);
            }
        }
        
        // ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
        async function checkCurrentSystemPassword() {
            showPasswordStatus('ğŸ” ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­...', 'info');
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get',
                        passwordType: 'system'
                    })
                });
                
                const result = await response.json();
                console.log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŠ¶æ³:', result);
                
                const systemInfo = result.passwords?.system;
                const systemStatus = systemInfo?.status || 'ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ';
                const systemUpdatedAt = systemInfo?.lastUpdated
                    ? new Date(systemInfo.lastUpdated).toLocaleString('ja-JP')
                    : 'æœªç™»éŒ²';
                showPasswordStatus(`ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŠ¶æ³: ${systemStatus}<br>ğŸ•’ æœ€çµ‚æ›´æ–°: ${systemUpdatedAt}`, 'info');
                
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                showPasswordStatus('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ç¾åœ¨ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
        async function checkCurrentAdminPassword() {
            showPasswordStatus('ğŸ” ç¾åœ¨ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­...', 'info');
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/password-manager`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get',
                        passwordType: 'admin'
                    })
                });
                
                const result = await response.json();
                console.log('ğŸ” ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŠ¶æ³:', result);
                
                const adminInfo = result.passwords?.admin;
                const adminStatus = adminInfo?.status || 'ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ';
                const adminUpdatedAt = adminInfo?.lastUpdated
                    ? new Date(adminInfo.lastUpdated).toLocaleString('ja-JP')
                    : 'æœªç™»éŒ²';
                showPasswordStatus(`ğŸ“‹ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŠ¶æ³: ${adminStatus}<br>ğŸ•’ æœ€çµ‚æ›´æ–°: ${adminUpdatedAt}`, 'info');
                
            } catch (error) {
                console.error('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                showPasswordStatus('âŒ ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showPasswordStatus(message, type) {
            const statusDiv = document.getElementById('password-change-status');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯3ç§’å¾Œã«æ¶ˆå»
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã®ä¿å­˜
        function saveAlertSettings() {
            const settings = {
                first: parseInt(document.getElementById('first-warning-threshold').value),
                middle: parseInt(document.getElementById('middle-warning-threshold').value),
                final: parseInt(document.getElementById('final-warning-threshold').value)
            };

            // è¨­å®šå€¤ã®æ¤œè¨¼
            if (settings.first >= settings.middle || settings.middle >= settings.final) {
                document.getElementById('alert-settings-status').innerHTML = 
                    '<div class="status-error">âŒ è­¦å‘Šãƒ¬ãƒ™ãƒ«ã¯åˆå› < ä¸­é–“ < æœ€çµ‚ ã®é †åºã§è¨­å®šã—ã¦ãã ã•ã„</div>';
                return;
            }

            if (settings.final > 3000) {
                document.getElementById('alert-settings-status').innerHTML = 
                    '<div class="status-error">âŒ æœ€çµ‚è­¦å‘Šã¯3000ä»¶ä»¥ä¸‹ã§è¨­å®šã—ã¦ãã ã•ã„</div>';
                return;
            }

            // è¨­å®šã‚’ä¿å­˜
            localStorage.setItem('alertThresholds', JSON.stringify(settings));
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã«åæ˜ 
            if (window.quotaAlertSystem) {
                window.quotaAlertSystem.WARNING_THRESHOLDS.monthly = settings;
            }

            document.getElementById('alert-settings-status').innerHTML = 
                '<div class="status-success">âœ… ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>';
            
            setTimeout(() => {
                document.getElementById('alert-settings-status').innerHTML = '';
            }, 3000);
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        async function testAlert(level) {
            if (typeof window.testQuotaAlert === 'function') {
                try {
                    await window.testQuotaAlert(level);
                    const levelNames = {
                        'first': 'åˆå›è­¦å‘Š (1000ä»¶)',
                        'middle': 'ä¸­é–“è­¦å‘Š (2000ä»¶)',
                        'final': 'æœ€çµ‚è­¦å‘Š (2800ä»¶)'
                    };
                    document.getElementById('alert-test-status').innerHTML = 
                        `<div class="status-success">âœ… ${levelNames[level]} ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸ<br>ğŸ“Š ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ</div>`;
                    
                    setTimeout(() => {
                        document.getElementById('alert-test-status').innerHTML = '';
                    }, 5000);
                } catch (error) {
                    document.getElementById('alert-test-status').innerHTML = 
                        `<div class="status-error">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
            } else {
                alert('ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        }

        // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãƒ†ã‚¹ãƒˆ
        async function testEmailNotification() {
            const email = document.getElementById('admin-email-input').value;
            if (!email) {
                document.getElementById('email-settings-status').innerHTML = 
                    '<div class="status-error">âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                return;
            }

            try {
                // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿
                const testEmailData = {
                    to: email,
                    subject: 'ğŸ§ª ãƒ†ã‚¹ãƒˆé€ä¿¡ - è²¸å€Ÿç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½',
                    body: `
è²¸å€Ÿç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ ãƒ†ã‚¹ãƒˆé€ä¿¡

ã€é€ä¿¡æ™‚åˆ»ã€‘: ${new Date().toLocaleString('ja-JP')}
ã€é€ä¿¡å…ƒã€‘: ç®¡ç†è€…ç”»é¢ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½

ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã®å‹•ä½œç¢ºèªã®ãŸã‚ã«é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã®ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿæ™‚ã«ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¾ã™:
- APIä½¿ç”¨é‡ã®è©³ç´°
- ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«
- æ¨å¥¨å¯¾å¿œ
- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è²¸å€Ÿç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ç®¡ç†è€…ç”»é¢
ãƒ†ã‚¹ãƒˆé€ä¿¡æ©Ÿèƒ½ã‚ˆã‚Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    `,
                    priority: 'normal'
                };

                // Supabase FunctionçµŒç”±ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                const response = await fetch(`${SUPABASE_CONFIG.url}/functions/v1/send-alert-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify(testEmailData)
                });

                if (response.ok) {
                    document.getElementById('email-settings-status').innerHTML = 
                        '<div class="status-success">âœ… ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ</div>';
                } else {
                    throw new Error(`ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
            } catch (error) {
                console.error('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('email-settings-status').innerHTML = 
                    '<div class="status-warning">âš ï¸ ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé–‹ç™ºç’°å¢ƒã§ã¯ãƒ­ã‚°å‡ºåŠ›ã®ã¿ï¼‰</div>';
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
        function checkSystemStatus() {
            const status = {
                'Configèª­ã¿è¾¼ã¿': typeof window.SUPABASE_CONFIG !== 'undefined',
                'APIé–¢æ•°': typeof window.callSheetsAPI === 'function',
                'æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ ': typeof window.simpleOptimization !== 'undefined',
                'ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ': typeof window.quotaAlertSystem !== 'undefined'
            };

            let html = '<div style="display: grid; gap: 10px;">';
            let allOK = true;

            Object.entries(status).forEach(([name, ok]) => {
                const statusText = ok ? 'âœ… æ­£å¸¸' : 'âŒ ã‚¨ãƒ©ãƒ¼';
                const statusClass = ok ? 'status-success' : 'status-error';
                html += `<div class="${statusClass}" style="padding: 8px; font-size: 14px;">${name}: ${statusText}</div>`;
                
                if (!ok) allOK = false;
            });

            if (allOK) {
                html += '<div class="status-success" style="padding: 8px; font-weight: 600;">ğŸ‰ ã™ã¹ã¦ã®ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™</div>';
            }

            html += '</div>';
            document.getElementById('system-status-display').innerHTML = html;
        }

        // ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–ã®å®Ÿè¡Œ
        async function runSystemOptimization() {
            try {
                if (typeof window.testSimpleOptimization === 'function') {
                    await window.testSimpleOptimization();
                }
                
                document.getElementById('system-status-display').innerHTML += 
                    '<div class="status-success" style="margin-top: 10px;">âš¡ ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ</div>';
            } catch (error) {
                document.getElementById('system-status-display').innerHTML += 
                    '<div class="status-error" style="margin-top: 10px;">âŒ æœ€é©åŒ–å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
            }
        }

        // ä½¿ç”¨é‡çµ±è¨ˆã®ãƒªã‚»ãƒƒãƒˆ
        async function resetUsageStats() {
            if (confirm('ä½¿ç”¨é‡çµ±è¨ˆã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã‚‚å«ã‚ã¦ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                try {
                    // Supabaseã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            action: 'reset',
                            resetType: 'all'
                        })
                    });

                    if (response.ok) {
                        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚ãƒªã‚»ãƒƒãƒˆ
                        localStorage.removeItem('dailyAPIStats');
                        localStorage.removeItem('monthlyAPIStats');
                        localStorage.removeItem('alertHistory');
                        localStorage.removeItem('simpleOptimizationStats');
                        
                        alert('ğŸ—‘ï¸ ä½¿ç”¨é‡çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ + ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰');
                        refreshUsageData();
                        loadMonthlyChart(); // æœˆæ¬¡ã‚°ãƒ©ãƒ•ã‚‚æ›´æ–°
                    } else {
                        throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('çµ±è¨ˆãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ çµ±è¨ˆãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿
        function loadAlertHistory() {
            const history = JSON.parse(localStorage.getItem('alertHistory') || '[]');
            const historyDiv = document.getElementById('alert-history-display');

            if (history.length === 0) {
                historyDiv.innerHTML = '<div style="color: rgba(31, 42, 61, 0.55); text-align: center;">ğŸ“­ ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            let html = '';
            history.slice(0, 20).forEach(alert => {
                const date = new Date(alert.timestamp).toLocaleString('ja-JP');
                const levelClass = alert.level.includes('first') ? 'first' : 
                                 alert.level.includes('middle') ? 'middle' : 'final';
                const icon = levelClass === 'first' ? 'ğŸ“Š' : 
                           levelClass === 'middle' ? 'âš ï¸' : 'ğŸš¨';
                
                html += `
                    <div class="alert-item ${levelClass}">
                        <div style="font-weight: 600;">${icon} ${alert.level.replace('_', ' ').toUpperCase()}</div>
                        <div style="font-size: 14px; color: rgba(31, 42, 61, 0.55);">${date}</div>
                        <div style="margin-top: 5px;">
                            æœˆé–“ä½¿ç”¨é‡: ${alert.usage.monthly}ä»¶ (${alert.usage.monthlyPercentage}%)
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = html;
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®ã‚¯ãƒªã‚¢
        function clearAlertHistory() {
            if (confirm('ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('alertHistory');
                document.getElementById('alert-history-display').innerHTML = 
                    '<div style="color: rgba(31, 42, 61, 0.55); text-align: center;">ğŸ“­ ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                alert('ğŸ—‘ï¸ ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        


        // ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function adminLogout() {
            if (confirm('ç®¡ç†è€…ç”»é¢ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                const apiDelta = await calculateSessionApiDelta();
                const description = apiDelta >= 30
                    ? 'âš ï¸ çŸ­æ™‚é–“ã«30å›ä»¥ä¸Šã®APIå‘¼ã³å‡ºã—ãŒã‚ã‚Šã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚'
                    : 'ç®¡ç†ç”»é¢ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
                const recorded = await recordAdminAccess('admin_logout', description, apiDelta, { showWarning: apiDelta >= 30 });
                if (!recorded) {
                    await loadAccessLogs();
                }
                window.adminAuth.logout();
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleDebugMode() {
            const currentMode = window._debugMode || false;
            window._debugMode = !currentMode;
            
            const status = window._debugMode ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
            const color = window._debugMode ? '#2bb67a' : 'rgba(31, 42, 61, 0.55)';
            
            alert(`ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${status}\n\nè©³ç´°ãªAPIå‘¼ã³å‡ºã—ãƒ­ã‚°ãŒ${status}ã«ãªã‚Šã¾ã—ãŸã€‚`);
            
            // ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰æ›´
            const debugBtn = event.target;
            debugBtn.style.background = color;
            debugBtn.textContent = `ğŸ”§ ãƒ‡ãƒãƒƒã‚°${window._debugMode ? 'ON' : 'OFF'}`;
            
            console.log(`ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${status}`);
        }

        // ä½¿ç”¨é‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é–¢æ•°ã¯ç°¡ç´ åŒ–ã•ã‚Œã¾ã—ãŸ

        // ã‚·ãƒ³ãƒ—ãƒ«ãªAPIä½¿ç”¨é‡è¡¨ç¤ºï¼ˆSupabaseãƒ™ãƒ¼ã‚¹ãƒ»quota-alert-systemã¨åŒæœŸï¼‰
        async function loadSimpleUsageDisplay() {
            try {
                let usage;
                
                // quota-alert-systemãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ä½¿ç”¨ï¼ˆéåŒæœŸå¯¾å¿œï¼‰
                if (window.quotaAlertSystem) {
                    usage = await window.quotaAlertSystem.getCurrentUsage();
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥localStorageèª­ã¿è¾¼ã¿
                    const today = new Date().toDateString();
                    const currentMonth = new Date().toISOString().slice(0, 7);

                    const dailyStats = JSON.parse(localStorage.getItem('dailyAPIStats') || '{}');
                    const monthlyStats = JSON.parse(localStorage.getItem('monthlyAPIStats') || '{}');
                    const totalStats = JSON.parse(localStorage.getItem('totalAPIStats') || '{"total": 0}');

                    usage = {
                        daily: dailyStats[today] || 0,
                        monthly: monthlyStats[currentMonth] || 0,
                        total: totalStats.total || 0
                    };
                }

                const display = document.getElementById('simple-usage-display');
                display.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: rgba(244, 247, 254, 0.9);
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${usage.daily}</div>
                        <div style="font-size: 0.875rem; color: rgba(31, 42, 61, 0.55);">æœ¬æ—¥ç´¯è¨ˆ / 300</div>
                    </div>

                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: rgba(244, 247, 254, 0.9);
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${usage.monthly}</div>
                        <div style="font-size: 0.875rem; color: rgba(31, 42, 61, 0.55);">ä»Šæœˆç´¯è¨ˆ / 3,000</div>
                    </div>

                    <div style="
                        text-align: center;
                        padding: 20px;
                        background: rgba(244, 247, 254, 0.9);
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 2rem; font-weight: 600; color: #495057; margin-bottom: 8px;">${(usage.total || 0).toLocaleString()}</div>
                        <div style="font-size: 0.875rem; color: rgba(31, 42, 61, 0.55);">ç·ç´¯è¨ˆ</div>
                    </div>
                `;
            } catch (error) {
                console.error('ä½¿ç”¨é‡è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                const display = document.getElementById('simple-usage-display');
                display.innerHTML = '<div style="color: #d64541;">âŒ ä½¿ç”¨é‡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);

        window._accessLogCache = [];

        // ä½¿ç”¨é‡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šç®¡ç†
        const DEFAULT_INDICATOR_SETTINGS = { orange: 900, yellow: 1500, red: 2400 };

        function persistIndicatorSettings(settings) {
            try {
                localStorage.setItem('indicatorColorSettings', JSON.stringify({
                    ...settings,
                    updated: new Date().toISOString()
                }));
            } catch (error) {
                console.warn('ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function applyIndicatorSettingsToUI(settings) {
            document.getElementById('orange-threshold').value = settings.orange;
            document.getElementById('yellow-threshold').value = settings.yellow;
            document.getElementById('red-threshold').value = settings.red;
            updateIndicatorPreview(settings);

            if (window.usageIndicator && typeof window.usageIndicator.applyColorSettings === 'function') {
                window.usageIndicator.applyColorSettings(settings, true);
                if (typeof window.usageIndicator.latestMonthlyValue === 'number') {
                    const indicatorEl = document.getElementById('usage-indicator');
                    if (indicatorEl) {
                        window.usageIndicator.updateIndicatorColor(indicatorEl, window.usageIndicator.latestMonthlyValue, settings);
                    }
                }
            }
        }

        function getStoredIndicatorSettings() {
            try {
                const saved = localStorage.getItem('indicatorColorSettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed && typeof parsed.orange === 'number' && typeof parsed.yellow === 'number' && typeof parsed.red === 'number') {
                        return {
                            orange: parsed.orange,
                            yellow: parsed.yellow,
                            red: parsed.red
                        };
                    }
                }
            } catch (error) {
                console.warn('ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
            return { ...DEFAULT_INDICATOR_SETTINGS };
        }

        async function saveIndicatorSettings() {
            try {
                const orangeThreshold = parseInt(document.getElementById('orange-threshold').value, 10) || DEFAULT_INDICATOR_SETTINGS.orange;
                const yellowThreshold = parseInt(document.getElementById('yellow-threshold').value, 10) || DEFAULT_INDICATOR_SETTINGS.yellow;
                const redThreshold = parseInt(document.getElementById('red-threshold').value, 10) || DEFAULT_INDICATOR_SETTINGS.red;

                if (orangeThreshold >= yellowThreshold || yellowThreshold >= redThreshold) {
                    alert('âš ï¸ é–¾å€¤ã¯ ç·‘è‰² < é»„è‰² < èµ¤è‰² ã®é †åºã§è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }

                const settings = {
                    orange: orangeThreshold,
                    yellow: yellowThreshold,
                    red: redThreshold
                };

                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/indicator-settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'save',
                        settings,
                        updatedBy: 'admin_panel'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const savedSettings = result.settings || settings;
                persistIndicatorSettings(savedSettings);
                applyIndicatorSettingsToUI(savedSettings);

                alert('âœ… ä½¿ç”¨é‡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è‰²è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\n\nè¨­å®šã¯å…¨ãƒšãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã«å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚');

            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert(`âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ\n${error.message || ''}`);
            }
        }

        async function loadIndicatorSettings(showAlertOnFailure = false) {
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/indicator-settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({ action: 'get' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const settings = result.settings || { ...DEFAULT_INDICATOR_SETTINGS };
                persistIndicatorSettings(settings);
                applyIndicatorSettingsToUI(settings);

            } catch (error) {
                console.warn('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                if (showAlertOnFailure) {
                    alert('âš ï¸ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                }

                const fallbackSettings = getStoredIndicatorSettings();
                persistIndicatorSettings(fallbackSettings);
                applyIndicatorSettingsToUI(fallbackSettings);
            }
        }

        async function resetIndicatorSettings() {
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/indicator-settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'reset',
                        updatedBy: 'admin_panel'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨­å®šã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const settings = result.settings || { ...DEFAULT_INDICATOR_SETTINGS };
                localStorage.removeItem('indicatorColorSettings');
                persistIndicatorSettings(settings);
                applyIndicatorSettingsToUI(settings);

                alert('ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã—ãŸ');

            } catch (error) {
                console.error('è¨­å®šãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                localStorage.removeItem('indicatorColorSettings');
                const fallbackSettings = { ...DEFAULT_INDICATOR_SETTINGS };
                persistIndicatorSettings(fallbackSettings);
                applyIndicatorSettingsToUI(fallbackSettings);
                alert('âš ï¸ Supabaseã¸ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã—ã¾ã—ãŸã€‚');
            }
        }

        function updateIndicatorPreview(settings) {
            const preview = document.getElementById('indicator-preview');
            
            preview.innerHTML = `
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(0, 0, 0, 0.8); color: white; font-size: 12px; font-weight: bold;">
                    âš« é»’: 0-${settings.orange - 1}å›
                </div>
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(40, 167, 69, 0.8); color: white; font-size: 12px; font-weight: bold;">
                    ğŸŸ¢ ç·‘: ${settings.orange}-${settings.yellow - 1}å›
                </div>
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(255, 193, 7, 0.9); color: white; font-size: 12px; font-weight: bold;">
                    ğŸŸ¡ é»„è‰²: ${settings.yellow}-${settings.red - 1}å›
                </div>
                <div style="padding: 8px 15px; border-radius: 20px; background: rgba(220, 53, 69, 0.9); color: white; font-size: 12px; font-weight: bold;">
                    ğŸ”´ èµ¤è‰²: ${settings.red}å›ä»¥ä¸Š
                </div>
            `;
        }

        // APIä¸Šé™å€¤è¨­å®šç®¡ç†
        function saveAPILimitSettings() {
            try {
                const apiLimit = parseInt(document.getElementById('api-limit').value);
                
                if (!apiLimit || apiLimit < 100 || apiLimit > 10000) {
                    alert('âš ï¸ ä¸Šé™å€¤ã¯100-10,000å›ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const settings = {
                    apiLimit: apiLimit,
                    updated: new Date().toISOString()
                };

                localStorage.setItem('apiLimitSettings', JSON.stringify(settings));
                
                updateLimitStatus(settings);
                
                alert(`âœ… APIä½¿ç”¨é‡ä¸Šé™ã‚’${apiLimit}å›ã«è¨­å®šã—ã¾ã—ãŸ\\n\\nè¨­å®šã¯å³åº§ã«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«åæ˜ ã•ã‚Œã¾ã™ã€‚`);
                
            } catch (error) {
                console.error('ä¸Šé™å€¤è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function loadAPILimitSettings() {
            try {
                const saved = localStorage.getItem('apiLimitSettings');
                let settings;
                
                if (saved) {
                    settings = JSON.parse(saved);
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                    settings = { apiLimit: 2500 };
                }

                document.getElementById('api-limit').value = settings.apiLimit;
                updateLimitStatus(settings);
                
            } catch (error) {
                console.error('ä¸Šé™å€¤è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                resetAPILimitSettings();
            }
        }

        function resetAPILimitSettings() {
            const defaultSettings = { apiLimit: 2500 };
            
            document.getElementById('api-limit').value = defaultSettings.apiLimit;
            updateLimitStatus(defaultSettings);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚å‰Šé™¤
            localStorage.removeItem('apiLimitSettings');
            
            alert('ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆ2,500å›ï¼‰ã«æˆ»ã—ã¾ã—ãŸ');
        }

        async function updateLimitStatus(settings) {
            try {
                // ç¾åœ¨ã®ä½¿ç”¨é‡ã‚’å–å¾—
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get'
                    })
                });

                if (response.ok) {
                    const stats = await response.json();
                    const monthlyUsage = stats.monthly.total;
                    const usagePercentage = Math.round((monthlyUsage / settings.apiLimit) * 100);
                    
                    let statusColor, statusText;
                    if (monthlyUsage >= settings.apiLimit) {
                        statusColor = '#d64541';
                        statusText = 'ğŸš« é®æ–­ä¸­';
                    } else if (usagePercentage >= 90) {
                        statusColor = '#fd7e14';
                        statusText = 'âš ï¸ å±é™ºãƒ¬ãƒ™ãƒ«';
                    } else if (usagePercentage >= 70) {
                        statusColor = '#f6b93b';
                        statusText = 'ğŸŸ¡ è­¦å‘Šãƒ¬ãƒ™ãƒ«';
                    } else {
                        statusColor = '#2bb67a';
                        statusText = 'âœ… æ­£å¸¸';
                    }
                    
                    const statusHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p><strong>è¨­å®šä¸Šé™å€¤:</strong> ${settings.apiLimit.toLocaleString()}å›</p>
                                <p><strong>ç¾åœ¨ã®ä½¿ç”¨é‡:</strong> ${monthlyUsage.toLocaleString()}å›</p>
                                <p><strong>ä½¿ç”¨ç‡:</strong> ${usagePercentage}%</p>
                            </div>
                            <div>
                                <p style="font-size: 18px; font-weight: bold; color: ${statusColor};">
                                    ${statusText}
                                </p>
                                <p><strong>æ®‹ã‚Šä½¿ç”¨å¯èƒ½:</strong> ${Math.max(0, settings.apiLimit - monthlyUsage).toLocaleString()}å›</p>
                                <p><small>æœ€çµ‚æ›´æ–°: ${settings.updated ? new Date(settings.updated).toLocaleString() : 'æœªè¨­å®š'}</small></p>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('limit-status-content').innerHTML = statusHtml;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('çŠ¶æ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('limit-status-content').innerHTML = `
                    <p><strong>è¨­å®šä¸Šé™å€¤:</strong> ${settings.apiLimit.toLocaleString()}å›</p>
                    <p style="color: #d64541;">ä½¿ç”¨é‡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                `;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆé–¢é€£ã®é–¢æ•°
        async function loadDataMismatchReports(forceRefresh = false) {
            const container = document.getElementById('data-mismatch-list');
            const warningBox = document.getElementById('data-mismatch-warning');
            if (!container) return;

            try {
                container.innerHTML = '<div class="data-mismatch-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div>';
                
                // Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/data-mismatch-reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get_all'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const reports = result.reports || [];
                    renderDataMismatchReports(reports);
                    
                    // è­¦å‘Šè¡¨ç¤ºã®åˆ¶å¾¡
                    if (warningBox) {
                        warningBox.style.display = reports.length > 0 ? 'block' : 'none';
                    }
                } else {
                    const errorText = await response.text();
                    console.error('ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—:', error);
                
                // CORSã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch') || error.message.includes('origin')) {
                    container.innerHTML = `
                        <div class="data-mismatch-placeholder" style="color: #f59e0b; background: rgba(245, 158, 11, 0.1); padding: 20px; border-radius: 8px;">
                            âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™<br>
                            <small style="font-size: 12px; color: rgba(31, 42, 61, 0.6);">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ã„ã‚‹ãŸã‚ã€CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚<br>
                                <strong>http://localhost:3000</strong> ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
                            </small>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="data-mismatch-placeholder">âŒ ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
                }
            }
        }

        function renderDataMismatchReports(reports) {
            const container = document.getElementById('data-mismatch-list');
            if (!container) return;

            if (reports.length === 0) {
                container.innerHTML = '<div class="data-mismatch-placeholder">ğŸ“­ ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const reportItems = reports.map((report, index) => {
                const createdDate = new Date(report.created_at).toLocaleString('ja-JP');
                const environmentInfo = report.environment_info || {};
                const browserInfo = environmentInfo.browser || {};
                const screenInfo = environmentInfo.screen || {};
                
                return `
                    <div class="data-mismatch-item" data-report-id="${report.id}">
                        <div class="data-mismatch-meta">
                            <span class="data-mismatch-id">${report.environment_info?.reportType === 'problem_report' ? 'å•é¡Œå ±å‘Š' : 'ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´'} #${index + 1}</span>
                            <span class="data-mismatch-time">${createdDate}</span>
                        </div>
                        <div class="data-mismatch-stats">
                            ${report.environment_info?.reportType === 'problem_report' ? 
                                `<span>å ±å‘Šã‚¿ã‚¤ãƒ—: å•é¡Œå ±å‘Š</span>` : 
                                `<span>ä¸ä¸€è‡´é …ç›®æ•°: ${report.mismatch_count}ä»¶</span>`
                            }
                            <span>é€ä¿¡ãƒ‡ãƒ¼ã‚¿æ•°: ${report.sent_data_count}ä»¶</span>
                            <span>ç™»éŒ²ãƒ‡ãƒ¼ã‚¿æ•°: ${report.registered_data_count}ä»¶</span>
                        </div>
                        <div class="data-mismatch-environment">
                            <h4>ğŸŒ ç’°å¢ƒæƒ…å ±</h4>
                            <div class="environment-details">
                                <p><strong>ãƒ–ãƒ©ã‚¦ã‚¶:</strong> ${browserInfo.name || 'Unknown'} ${browserInfo.version || ''}</p>
                                <p><strong>ç”»é¢è§£åƒåº¦:</strong> ${screenInfo.width || 'Unknown'}x${screenInfo.height || 'Unknown'}</p>
                                <p><strong>ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³:</strong> ${environmentInfo.timezone?.timezone || 'Unknown'}</p>
                                <p><strong>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :</strong> ${environmentInfo.platform?.platform || 'Unknown'}</p>
                                <p><strong>è¨€èª:</strong> ${browserInfo.language || 'Unknown'}</p>
                            </div>
                        </div>
                        <div class="data-mismatch-actions">
                            <button class="btn secondary" onclick="viewReportDetails(${report.id})">ğŸ‘ï¸ è©³ç´°è¡¨ç¤º</button>
                            <button class="btn danger" onclick="deleteReport(${report.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = reportItems.join('');
        }

        async function deleteAllDataMismatchReports() {
            if (!confirm('âš ï¸ å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/data-mismatch-reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'delete_all'
                    })
                });

                if (response.ok) {
                    alert('âœ… å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    // å¼·åˆ¶çš„ã«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    setTimeout(() => {
                        loadDataMismatchReports(true);
                    }, 500);
                } else {
                    const errorText = await response.text();
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('ãƒ¬ãƒãƒ¼ãƒˆå‰Šé™¤ã«å¤±æ•—:', error);
                alert(`âŒ ãƒ¬ãƒãƒ¼ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }


        async function viewReportDetails(reportId) {
            try {
                // ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/data-mismatch-reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get_all'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                const reports = result.reports || [];
                const report = reports.find(r => r.id === reportId);
                
                if (!report) {
                    alert('âŒ ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                showReportDetailModal(report);
            } catch (error) {
                console.error('ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°ã®å–å¾—ã«å¤±æ•—:', error);
                alert(`âŒ ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        function showReportDetailModal(report) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’ä½œæˆ
            const overlay = document.createElement('div');
            overlay.className = 'detail-modal-overlay';
            overlay.id = 'detail-modal-overlay';
            
            const environmentInfo = report.environment_info || {};
            const browserInfo = environmentInfo.browser || {};
            const screenInfo = environmentInfo.screen || {};
            const windowInfo = environmentInfo.window || {};
            const timezoneInfo = environmentInfo.timezone || {};
            const platformInfo = environmentInfo.platform || {};
            const connectionInfo = environmentInfo.connection || {};

            overlay.innerHTML = `
                <div class="detail-modal">
                    <div class="detail-modal-header">
                        <h2 class="detail-modal-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°</h2>
                        <button class="detail-modal-close" onclick="closeDetailModal()">&times;</button>
                    </div>
                    <div class="detail-modal-content">
                        <!-- åŸºæœ¬æƒ…å ± -->
                        <div class="detail-section">
                            <h3 class="detail-section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-item-label">ãƒ¬ãƒãƒ¼ãƒˆID</div>
                                    <div class="detail-item-value">${report.report_id || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ä½œæˆæ—¥æ™‚</div>
                                    <div class="detail-item-value">${new Date(report.created_at).toLocaleString('ja-JP')}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ä¸ä¸€è‡´é …ç›®æ•°</div>
                                    <div class="detail-item-value">${report.mismatch_count || 0}ä»¶</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">é€ä¿¡ãƒ‡ãƒ¼ã‚¿æ•°</div>
                                    <div class="detail-item-value">${report.sent_data_count || 0}ä»¶</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ç™»éŒ²ãƒ‡ãƒ¼ã‚¿æ•°</div>
                                    <div class="detail-item-value">${report.registered_data_count || 0}ä»¶</div>
                                </div>
                            </div>
                        </div>

                        <!-- ä¸ä¸€è‡´è©³ç´° -->
                        ${report.mismatch_details && report.mismatch_details.length > 0 ? `
                        <div class="detail-section">
                            <h3 class="detail-section-title">âŒ ä¸ä¸€è‡´è©³ç´°</h3>
                            ${report.mismatch_details.map((mismatch, index) => `
                                <div class="detail-mismatch-item">
                                    <div class="detail-mismatch-field">é …ç›®: ${mismatch.field || 'Unknown'}</div>
                                    <div class="detail-mismatch-values">
                                        <div class="detail-mismatch-sent">
                                            <strong>é€ä¿¡å€¤:</strong><br>
                                            ${JSON.stringify(mismatch.sent, null, 2)}
                                        </div>
                                        <div class="detail-mismatch-registered">
                                            <strong>ç™»éŒ²å€¤:</strong><br>
                                            ${JSON.stringify(mismatch.registered, null, 2)}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}

                        <!-- ç’°å¢ƒæƒ…å ± -->
                        <div class="detail-section">
                            <h3 class="detail-section-title">ğŸŒ ç’°å¢ƒæƒ…å ±</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-item-label">ãƒ–ãƒ©ã‚¦ã‚¶</div>
                                    <div class="detail-item-value">${browserInfo.name || 'Unknown'} ${browserInfo.version || ''}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ç”»é¢è§£åƒåº¦</div>
                                    <div class="detail-item-value">${screenInfo.width || 'Unknown'}x${screenInfo.height || 'Unknown'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚º</div>
                                    <div class="detail-item-value">${windowInfo.innerWidth || 'Unknown'}x${windowInfo.innerHeight || 'Unknown'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</div>
                                    <div class="detail-item-value">${timezoneInfo.timezone || 'Unknown'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </div>
                                    <div class="detail-item-value">${platformInfo.platform || 'Unknown'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">è¨€èª</div>
                                    <div class="detail-item-value">${browserInfo.language || 'Unknown'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">æ¥ç¶šã‚¿ã‚¤ãƒ—</div>
                                    <div class="detail-item-value">${connectionInfo.effectiveType || 'Unknown'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">ãƒ‡ãƒã‚¤ã‚¹ãƒ”ã‚¯ã‚»ãƒ«æ¯”</div>
                                    <div class="detail-item-value">${windowInfo.devicePixelRatio || 'Unknown'}</div>
                                </div>
                            </div>
                        </div>

                        <!-- é€ä¿¡ãƒ‡ãƒ¼ã‚¿ -->
                        ${report.sent_data ? `
                        <div class="detail-section">
                            <h3 class="detail-section-title">ğŸ“¤ é€ä¿¡ãƒ‡ãƒ¼ã‚¿</h3>
                            <div class="detail-json">${JSON.stringify(report.sent_data, null, 2)}</div>
                        </div>
                        ` : ''}

                        <!-- ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ -->
                        ${report.registered_data ? `
                        <div class="detail-section">
                            <h3 class="detail-section-title">ğŸ“¥ ç™»éŒ²ãƒ‡ãƒ¼ã‚¿</h3>
                            <div class="detail-json">${JSON.stringify(report.registered_data, null, 2)}</div>
                        </div>
                        ` : ''}

                        <!-- å®Œå…¨ãªç’°å¢ƒæƒ…å ± -->
                        <div class="detail-section">
                            <h3 class="detail-section-title">ğŸ” å®Œå…¨ãªç’°å¢ƒæƒ…å ±</h3>
                            <div class="detail-json">${JSON.stringify(environmentInfo, null, 2)}</div>
                        </div>
                    </div>
                </div>
            `;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.body.appendChild(overlay);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            requestAnimationFrame(() => {
                overlay.classList.add('show');
            });

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDetailModal();
                }
            });
        }

        function closeDetailModal() {
            const overlay = document.getElementById('detail-modal-overlay');
            if (overlay) {
                overlay.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                }, 300);
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            // å€‹åˆ¥å‰Šé™¤ã®å®Ÿè£…ï¼ˆä»Šå¾Œè¿½åŠ äºˆå®šï¼‰
            alert('å€‹åˆ¥å‰Šé™¤æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
        }


        async function clearAllUsageData() {
            if (!confirm('âš ï¸ å…¨ã¦ã®ä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'reset_all'
                    })
                });
                
                if (response.ok) {
                    alert('âœ… å…¨ã¦ã®ä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                    loadMonthlyChart();
                    refreshUsageData();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼ç®¡ç†æ©Ÿèƒ½
        async function loadDataRetentionStatus(retryCount = 0) {
            const statusDiv = document.getElementById('data-retention-status');
            if (!statusDiv) return;
            
            try {
                statusDiv.innerHTML = '<div style="color: rgba(31, 42, 61, 0.55);">èª­ã¿è¾¼ã¿ä¸­...</div>';
                
                // ãƒ‡ãƒ¼ã‚¿ä¿æŒçŠ¶æ³ã‚’å–å¾—
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'get_retention_status'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayDataRetentionStatus(result);
                } else if (response.status === 500 && retryCount < 2) {
                    // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
                    console.log(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã€${retryCount + 1}å›ç›®ã®ãƒªãƒˆãƒ©ã‚¤...`);
                    setTimeout(() => {
                        loadDataRetentionStatus(retryCount + 1);
                    }, 2000 * (retryCount + 1)); // 2ç§’ã€4ç§’ã€6ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤
                    return;
                } else if (response.status === 404 || response.status === 500) {
                    // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¾ãŸã¯æœ€çµ‚çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
                    statusDiv.innerHTML = `
                        <div style="color: rgba(31, 42, 61, 0.6); text-align: center; padding: 20px;">
                            ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br>
                            <small style="font-size: 12px; color: rgba(31, 42, 61, 0.5);">
                                ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>
                                <em>ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ï¼‰</em>
                            </small>
                        </div>
                    `;
                    return;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ä¿æŒçŠ¶æ³ã®å–å¾—ã«å¤±æ•—:', error);
                
                // CORSã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch') || error.message.includes('origin')) {
                    statusDiv.innerHTML = `
                        <div style="color: #f59e0b; text-align: center; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                            âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™<br>
                            <small style="font-size: 12px; color: rgba(31, 42, 61, 0.6);">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ã„ã‚‹ãŸã‚ã€CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚<br>
                                <strong>http://localhost:3000</strong> ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
                            </small>
                        </div>
                    `;
                } else if (error.message.includes('404') || error.message.includes('not found')) {
                    statusDiv.innerHTML = `
                        <div style="color: rgba(31, 42, 61, 0.6); text-align: center; padding: 20px;">
                            ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br>
                            <small style="font-size: 12px; color: rgba(31, 42, 61, 0.5);">
                                ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã¦ã„ã¾ã›ã‚“
                            </small>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = '<div style="color: #d64541;">âŒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            }
        }
        
        function displayDataRetentionStatus(data) {
            const statusDiv = document.getElementById('data-retention-status');
            if (!statusDiv) return;
            
            // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã®è¡¨ç¤º
            const hasDailyData = data.daily?.record_count > 0;
            const hasMonthlyData = data.monthly?.record_count > 0;
            
            if (!hasDailyData && !hasMonthlyData) {
                statusDiv.innerHTML = `
                    <div style="color: rgba(31, 42, 61, 0.6); text-align: center; padding: 20px;">
                        ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br>
                        <small style="font-size: 12px; color: rgba(31, 42, 61, 0.5);">
                            ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã¦ã„ã¾ã›ã‚“
                        </small>
                    </div>
                `;
                return;
            }
            
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - 6);
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <h5 style="margin: 0 0 8px 0; color: #3c6ee8;">ğŸ“Š æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿</h5>
                        <p style="margin: 0; font-size: 14px;">
                            <strong>ä»¶æ•°:</strong> ${data.daily?.record_count || 0}ä»¶<br>
                            <strong>æœ€å¤:</strong> ${data.daily?.oldest_date || 'N/A'}<br>
                            <strong>æœ€æ–°:</strong> ${data.daily?.newest_date || 'N/A'}
                        </p>
                    </div>
                    <div>
                        <h5 style="margin: 0 0 8px 0; color: #2bb67a;">ğŸ“ˆ æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿</h5>
                        <p style="margin: 0; font-size: 14px;">
                            <strong>ä»¶æ•°:</strong> ${data.monthly?.record_count || 0}ä»¶<br>
                            <strong>æœ€å¤:</strong> ${data.monthly?.oldest_date || 'N/A'}<br>
                            <strong>æœ€æ–°:</strong> ${data.monthly?.newest_date || 'N/A'}
                        </p>
                    </div>
                </div>
                <div style="background: rgba(60, 110, 232, 0.1); padding: 10px; border-radius: 6px;">
                    <h5 style="margin: 0 0 8px 0; color: #3c6ee8;">ğŸ—‚ï¸ ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼</h5>
                    <p style="margin: 0; font-size: 14px;">
                        <strong>ä¿æŒæœŸé–“:</strong> 6ãƒ¶æœˆï¼ˆ180æ—¥ï¼‰<br>
                        <strong>å‰Šé™¤å¯¾è±¡:</strong> ${cutoffDate.toISOString().split('T')[0]} ã‚ˆã‚Šå¤ã„ãƒ‡ãƒ¼ã‚¿<br>
                        <strong>ç·è¨ˆçµ±è¨ˆ:</strong> å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼ˆç´¯ç©ãƒ‡ãƒ¼ã‚¿ï¼‰
                    </p>
                </div>
            `;
            
            statusDiv.innerHTML = html;
        }
        
        async function manualCleanupOldData() {
            if (!confirm('âš ï¸ 6ãƒ¶æœˆå‰ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            const statusDiv = document.getElementById('cleanup-status');
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                button.disabled = true;
                button.textContent = 'ğŸ”„ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...';
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(60, 110, 232, 0.1)';
                statusDiv.style.color = '#3c6ee8';
                statusDiv.innerHTML = 'ğŸ—‘ï¸ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...';
                
                const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/api-usage-tracker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
                    },
                    body: JSON.stringify({
                        action: 'manual_cleanup'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.style.background = 'rgba(43, 182, 122, 0.1)';
                    statusDiv.style.color = '#2bb67a';
                    statusDiv.innerHTML = `
                        âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼<br>
                        ğŸ“Š å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:<br>
                        â€¢ æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿: ${result.deleted_daily_count || 0}ä»¶<br>
                        â€¢ æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿: ${result.deleted_monthly_count || 0}ä»¶<br>
                        â€¢ ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿: ${result.deleted_device_count || 0}ä»¶<br>
                        â€¢ å‰Šé™¤å¯¾è±¡æ—¥: ${result.cutoff_date || 'N/A'}
                    `;
                    
                    // ãƒ‡ãƒ¼ã‚¿ä¿æŒçŠ¶æ³ã‚’æ›´æ–°
                    setTimeout(() => {
                        loadDataRetentionStatus();
                    }, 1000);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                statusDiv.style.background = 'rgba(214, 69, 65, 0.1)';
                statusDiv.style.color = '#d64541';
                statusDiv.innerHTML = `âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }


        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            window.adminAuth = new AdminAuth();
            // ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
            loadDataMismatchReports();
            // ãƒ‡ãƒ¼ã‚¿ä¿æŒçŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
            loadDataRetentionStatus();
        });
    </script>
    <div class="system-alert-overlay" id="system-alert-overlay">
        <div class="system-alert-modal">
            <h3>âš ï¸ ã‚·ã‚¹ãƒ†ãƒ è­¦å‘Š</h3>
            <p id="system-alert-message">å¤§é‡ã®APIå‘¼ã³å‡ºã—ãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            <button id="system-alert-confirm">äº†è§£</button>
        </div>
    </div>

</body>
</html>
