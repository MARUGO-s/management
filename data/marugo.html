<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>店舗別貸借分析システム</title>
<link href="styles.css" rel="stylesheet"/>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script defer src="obfuscated.js"></script>

<style>
  /* 単価の列を右寄せにし、フォントを調整（太字にはしない） */
  #results-table td.unit-price {
    text-align: right;
    font-family: 'Courier New', monospace;
    font-weight: normal; /* 太字を解除 */
  }

  /* トグルボタンの装飾 */
  .toggle-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
  }
  .toggle-label {
    font-size: 14px;
    color: #333;
  }
  .switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
  }
  .switch input { display: none; }
  .slider {
    position: absolute; cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: .2s; border-radius: 24px;
  }
  .slider:before {
    position: absolute; content: "";
    height: 20px; width: 20px; left: 2px; bottom: 2px;
    background-color: white; transition: .2s; border-radius: 50%;
  }
  input:checked + .slider { background-color: #4caf50; }
  input:checked + .slider:before { transform: translateX(24px); }

</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>店舗別貸借分析</h1>
    </div>

    <section class="search-section">
      <form id="filter-form" class="search-form">
        <div class="form-group">
          <label for="start-date">開始日</label>
          <input type="date" id="start-date">
        </div>
        <div class="form-group">
          <label for="end-date">終了日</label>
          <input type="date" id="end-date">
        </div>
        <div class="form-group">
          <label for="store-name">店舗名</label>
          <select id="store-name">
            <option value="">店舗を選択（任意）</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="csv-file">ファイル読み込み</label>
          <input type="file" id="csv-file" accept=".csv" />
          <button type="button" id="load-gsheet-btn" class="all-data-btn" style="width:100%; margin-top: 8px;">スプレッドシートから読込</button>
        </div>

        <div class="button-group">
          <button type="submit" class="search-btn" id="analyze-btn">分析する</button>
          <button type="button" class="all-data-btn" id="reset-btn">リセット</button>
        </div>

        <div class="form-group" style="grid-column: 1 / -1;">
          <div class="toggle-wrapper">
            <span class="toggle-label">金額の降順で表示</span>
            <label class="switch">
              <input type="checkbox" id="sort-desc">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-wrapper">
            <span class="toggle-label">同一借主内でカテゴリー別集計</span>
            <label class="switch">
              <input type="checkbox" id="group-by-category">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </form>
    </section>

    <section class="results-section" style="display: block;">
      <div class="details-section">
        <div class="details-header">
          <h3>分析結果</h3>
          <div class="actions">
            <button id="export-btn" class="export-btn" style="padding: 8px 16px; font-size: 14px;">CSVエクスポート</button>
            <button id="clear-results-btn" class="retry-btn" style="padding: 8px 16px; font-size: 14px;">結果クリア</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="results-table">
            <thead>
              <tr>
                <th>日付</th>
                <th>入力者</th>
                <th>貸主</th>
                <th>借主</th>
                <th>カテゴリー</th>
                <th>品目</th>
                <th>個/本/kg</th>
                <th class="unit-price">単価</th>
                <th class="amount">金額</th>
                <th>入力日時</th>
                <th>修正</th>
              </tr>
            </thead>
            <tbody id="results-body">
              </tbody>
          </table>
        </div>
      </div>
    </section>

    <div id="correction-modal" class="modal-overlay" aria-hidden="true" role="dialog">
      <div class="modal-content" role="document">
        <h3 class="modal-title">逆取引として修正</h3>
        <div id="correction-message"></div>
        <div class="modal-actions">
          <button id="confirm-correction-btn" class="modal-btn confirm">この内容で修正ページへ</button>
          <button id="cancel-correction-btn" class="modal-btn cancel">キャンセル</button>
        </div>
      </div>
    </div>

  </div>

<script>
class MarugoAnalyzer {
  constructor() {
    this.searchResults = [];
    this.bindEvents();
  }

  bindEvents() {
    document.getElementById('filter-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.analyze();
    });
    document.getElementById('reset-btn').addEventListener('click', () => this.resetFilters());
    document.getElementById('export-btn').addEventListener('click', () => this.exportResults());
    document.getElementById('clear-results-btn').addEventListener('click', () => this.clearResults());
    document.getElementById('cancel-correction-btn').addEventListener('click', () => this.closeCorrectionModal());
    document.getElementById('confirm-correction-btn').addEventListener('click', () => this.goCorrection());
  }

  analyze() {
    if (typeof window.__marugoAnalyze === 'function') {
      window.__marugoAnalyze();
    } else {
      alert('分析モジュールが読み込まれていません。');
    }
  }

  resetFilters() {
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    document.getElementById('store-name').selectedIndex = 0;
    document.getElementById('sort-desc').checked = false;
    document.getElementById('group-by-category').checked = false;
  }

  exportResults() {
    if (this.searchResults.length === 0) { alert('エクスポートするデータがありません'); return; }

    const csv = Papa.unparse(this.searchResults);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "analysis_results.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  clearResults() {
    const tbody = document.getElementById('results-body');
    tbody.innerHTML = '';
    this.searchResults = [];
  }

  openCorrectionModal(rowData) {
    this._pendingCorrectionData = rowData;
    const modal = document.getElementById('correction-modal');
    const msgContainer = document.getElementById('correction-message');

    const data = rowData || {};
    msgContainer.innerHTML = `
        <p style="text-align: center; color: #6b7280; margin: 6px 0 14px; font-size: 14px;">以下のデータを逆取引として修正しますか？</p>
        <div class="correction-details-grid">
            <div class="grid-item-label">日付:</div><div class="grid-item-value">${data.date}</div>
            <div class="grid-item-label">入力者:</div><div class="grid-item-value">${data.name}</div>
            <div class="grid-item-label">貸主:</div><div class="grid-item-value">${data.lender}</div>
            <div class="grid-item-label">借主:</div><div class="grid-item-value">${data.borrower}</div>
            <div class="grid-item-label">品目:</div><div class="grid-item-value">${data.item}</div>
            <div class="grid-item-label">カテゴリー:</div><div class="grid-item-value">${data.category}</div>
            <div class="grid-item-label">個/本/kg:</div><div class="grid-item-value">${data.quantity}</div>
            <div class="grid-item-label">単価:</div><div class="grid-item-value">¥${(data.unitPrice || 0).toLocaleString()}</div>
            <div class="grid-item-label">金額:</div><div class="grid-item-value">¥${(data.amount || 0).toLocaleString()}</div>
            <div class="grid-item-label">入力日時:</div><div class="grid-item-value">${data.inputDate}</div>
            <div class="grid-item-label">既存の修正:</div><div class="grid-item-value">${data.correction || 'なし'}</div>
        </div>
    `;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
  }

  closeCorrectionModal() {
    const modal = document.getElementById('correction-modal');
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  }

  goCorrection() {
    const data = this._pendingCorrectionData;
    if (!data) { this.closeCorrectionModal(); return; }
    this.redirectToCorrectionPage(data);
  }

  redirectToCorrectionPage(data) {
    try {
      const enriched = { ...data, rowIndex: data.originalRowIndex };
      sessionStorage.setItem('correctionData', JSON.stringify(enriched));
      const encoded = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(enriched)))));
      const to = (location.pathname.includes('/data/')) ? '../correction.html?d=' + encoded : 'correction.html?d=' + encoded;
      window.location.href = to;
    } catch (e) {
      console.error('redirectToCorrectionPage error:', e);
      alert('遷移時にエラーが発生しました。もう一度お試しください。');
    }
  }
}
window.addEventListener('DOMContentLoaded', () => {
  const analyzer = new MarugoAnalyzer();
  // モーダルの外側クリックで閉じるイベント
  const modal = document.getElementById('correction-modal');
  modal.addEventListener('click', (event) => {
    if (event.target === modal) {
      analyzer.closeCorrectionModal();
    }
  });
});
</script>

</body>
</html>
