<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>店舗別貸借分析システム</title>
<link href="styles.css" rel="stylesheet"/>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script defer src="obfuscated.js"></script>
</head>
<body>

<div class="container">
  <div id="password-screen">
    <div class="password-card">
      <h1 class="password-title">🔒 認証が必要です</h1>
      <form id="password-form" class="password-form">
        <input type="password" id="password-input" class="password-input" placeholder="パスワードを入力" required>
        <button type="submit" id="password-btn" class="password-btn">🚪 ログイン</button>
        <p id="password-error" class="password-error">パスワードが違います。</p>
      </form>
    </div>
  </div>

  <div id="auto-login-screen" style="display: none;">
    <div class="auto-login-card">
      <h1 class="auto-login-title">自動ログイン</h1>
      <div class="auto-login-spinner"></div>
      <p class="auto-login-status">認証情報を確認しています...</p>
    </div>
  </div>
  
  <main id="main-app" style="display: none;">
    <header class="header">
      <h1>📊 店舗別貸借分析システム</h1>
      <a href="../index.html" class="home-btn">🏠 入力フォームへ</a>
    </header>

    <section class="status-section" id="status-section">
      <div id="status-info">システムは準備中です...</div>
    </section>

    <section class="search-section" id="search-section" style="display: none;">
      <form id="search-form" class="search-form">
        <div class="form-group">
          <label for="start-date">開始日</label>
          <input type="date" id="start-date">
        </div>
        <div class="form-group">
          <label for="end-date">終了日</label>
          <input type="date" id="end-date">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label for="store-name">店舗名</label>
          <select id="store-name">
            <option value="">店舗を選択（任意）</option>
          </select>
        </div>
        <div class="button-group">
          <button type="submit" class="search-btn">🔍 検索</button>
          <button type="button" id="all-data-btn" class="all-data-btn">📂 全データ表示</button>
          <button type="button" id="correction-search-btn" class="correction-search-btn">✏️ 修正のみ検索</button>
        </div>
      </form>
    </section>

    <section class="results-section" id="results-section" style="display: none;">
      <div class="details-section">
        <div class="details-header">
          <h3 id="details-title">取引詳細</h3>
        </div>
        <div class="table-wrapper">
          <table id="results-table">
            <thead>
              <tr>
                <th>日付</th>
                <th>タイプ</th>
                <th>相手先</th>
                <th>品目</th>
                <th>個/本</th>
                <th>カテゴリー</th>
                <th>金額</th>
                <th>入力者</th>
                <th>修正</th>
              </tr>
            </thead>
            <tbody id="details-table">
              </tbody>
          </table>
        </div>
      </div>
       <div class="export-section">
          <button id="export-btn" class="export-btn">💾 CSVエクスポート</button>
       </div>
    </section>
  </main>
</div>

<div id="confirm-modal-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 class="modal-title">✏️ 修正内容の確認</h3>
        <div id="confirm-modal-message"></div>
        <div class="modal-actions">
            <button id="modal-cancel-btn" class="modal-btn cancel">キャンセル</button>
            <button id="modal-confirm-btn" class="modal-btn confirm">はい、修正します</button>
        </div>
    </div>
</div>

<script>
// ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
//
//              店舗別貸借分析システム - JavaScript
//
// ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

// パスワード認証の有効期限（時間）
const PASSWORD_EXPIRY_HOURS = 8; 

// ソート機能用の変数
let sortDirection = {};

// パスワード認証管理クラス
class PasswordAuth {
    constructor() { this.setupPasswordAuth(); }
    setupPasswordAuth() {
        if (this.isPasswordAuthenticated()) { this.showAutoLoginScreen(); } 
        else { this.showPasswordScreen(); }
        const form = document.getElementById('password-form');
        if (form) { form.addEventListener('submit', (e) => { e.preventDefault(); this.handlePasswordSubmit(); }); }
    }
    isPasswordAuthenticated() {
        const authData = sessionStorage.getItem('passwordAuth');
        if (!authData) return false;
        try {
            const auth = JSON.parse(authData);
            const hoursElapsed = (new Date().getTime() - new Date(auth.timestamp).getTime()) / 3600000;
            return auth.authenticated && hoursElapsed < PASSWORD_EXPIRY_HOURS;
        } catch (e) { return false; }
    }
    handlePasswordSubmit() {
        const input = document.getElementById('password-input');
        const btn = document.getElementById('password-btn');
        const error = document.getElementById('password-error');
        btn.disabled = true;
        btn.textContent = '🔄 認証中...';
        setTimeout(() => {
            if (typeof verifyPassword === 'function' && verifyPassword(input.value)) {
                this.setPasswordAuthentication();
                error.style.display = 'none';
                this.showAutoLoginScreen();
            } else {
                error.style.display = 'block';
                input.value = '';
                input.focus();
                btn.disabled = false;
                btn.textContent = '🚪 ログイン';
                error.style.animation = 'shake 0.5s';
                setTimeout(() => { error.style.animation = ''; }, 500);
            }
        }, 500);
    }
    setPasswordAuthentication() { sessionStorage.setItem('passwordAuth', JSON.stringify({ authenticated: true, timestamp: new Date().toISOString() })); }
    showPasswordScreen() { document.getElementById('password-screen').style.display = 'block'; document.getElementById('auto-login-screen').style.display = 'none'; document.getElementById('main-app').style.display = 'none'; }
    showAutoLoginScreen() { document.getElementById('password-screen').style.display = 'none'; document.getElementById('auto-login-screen').style.display = 'block'; document.getElementById('main-app').style.display = 'none'; if (typeof GoogleSheetsAPIAnalyzer !== 'undefined') new GoogleSheetsAPIAnalyzer(); }
}

// ソート機能
function sortTable(columnIndex) {
    const tbody = document.getElementById("details-table");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    if (rows.length === 0) return;
    
    const direction = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
    sortDirection = { [columnIndex]: direction };

    document.querySelectorAll("#results-table th").forEach((h, i) => {
        h.classList.remove('sort-asc', 'sort-desc');
        if (i === columnIndex) h.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
    });

    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        let comparison = 0;
        // 日付(0), 個/本(4), 金額(6) は数値・日付としてソート
        if (columnIndex === 0) {
            comparison = new Date(aText) - new Date(bText);
        } else if (columnIndex === 4 || columnIndex === 6) {
            const numA = parseFloat(aText.replace(/[¥,]/g, '')) || 0;
            const numB = parseFloat(bText.replace(/[¥,]/g, '')) || 0;
            comparison = numA - numB;
        } else {
            comparison = aText.localeCompare(bText, 'ja');
        }
        return direction === 'asc' ? comparison : -comparison;
    });
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

class GoogleSheetsAPIAnalyzer {
    constructor() {
        this.data = []; this.searchResults = []; this.statusDiv = document.getElementById('status-info'); this.stores = new Set();
        this.apiKey = 'AIzaSyAcy7hXztCjngG2poP-Sn_g6ED0TESnNTE';
        this.spreadsheetId = '1Z1i7p1s5GeXdfhMoSrcu-JzJL_yima7FNHCoJ7Fz4iY';
        this.sheetName = '貸借表';
        this.init();
    }

    async init() {
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('auto-login-screen').style.display = 'none';
        this.log('システム初期化中...', 'loading');
        this.setupEventListeners();
        this.setDefaultDates();
        await this.connectToGoogleSheets();
    }

    log(message, type = 'info') {
        const logEntry = `[${new Date().toLocaleTimeString()}] ${message}`;
        this.statusDiv.className = `status-${type}`;
        this.statusDiv.textContent = logEntry;
    }

    async connectToGoogleSheets() {
        this.log('Google Sheets API に接続中...', 'loading');
        try {
            const range = `${this.sheetName}!A:J`; 
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${range}?key=${this.apiKey}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API接続エラー: ${response.status}`);
            const result = await response.json();
            if (!result.values || result.values.length < 2) throw new Error('スプレッドシートにデータがありません。');
            
            this.processSheetData(result.values);
            this.populateStoreDropdown();
            this.log(`データ読み込み完了！ ${this.data.length}件のレコード`, 'success');
            document.getElementById('search-section').style.display = 'block';
            
        } catch (error) { this.log(`エラー: ${error.message}`, 'error'); }
    }

    processSheetData(values) {
        this.log('データ解析中...', 'loading');
        this.data = values.slice(1).map((row, index) => {
            const lender = (row[2] || '').trim();
            const borrower = (row[3] || '').trim();
            if (lender) this.stores.add(lender);
            if (borrower) this.stores.add(borrower);

            return {
                date: (row[0] || '').split(' ')[0], // A列: 日付
                name: row[1] || '',                 // B列: 名前
                lender: lender,                     // C列: 貸主
                borrower: borrower,                 // D列: 借主
                category: row[4] || '',             // E列: カテゴリー
                item: row[5] || '',                 // F列: 品目
                quantity: parseFloat(String(row[6] || '1').replace(/,/g, '')), // G列: 個/本
                amount: parseFloat(String(row[7] || '0').replace(/,/g, '')),   // H列: 金額
                inputDate: row[8] || '',            // I列: 入力日時
                correction: row[9] || '',           // J列: 修正
                originalRowIndex: index + 2
            };
        }).filter(row => row.date && (row.lender || row.borrower));
    }
    
    populateStoreDropdown() { const select = document.getElementById('store-name'); select.innerHTML = '<option value="">店舗を選択（任意）</option>'; Array.from(this.stores).sort().forEach(s => select.add(new Option(s, s))); }
    setupEventListeners() { document.getElementById('search-form').addEventListener('submit', e => { e.preventDefault(); this.performSearch(); }); document.getElementById('all-data-btn').addEventListener('click', () => this.showAllData()); document.getElementById('correction-search-btn').addEventListener('click', () => this.searchCorrections()); document.getElementById('export-btn').addEventListener('click', () => this.exportResults()); }
    setDefaultDates() { const today = new Date(); const monthAgo = new Date(new Date().setMonth(today.getMonth() - 1)); document.getElementById('start-date').valueAsDate = monthAgo; document.getElementById('end-date').valueAsDate = today; }

    performSearch() {
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        const store = document.getElementById('store-name').value;
        if (!start || !end) { this.log('開始日と終了日を入力してください', 'error'); return; }
        this.searchResults = this.data.filter(r => r.date >= start && r.date <= end && (!store || r.lender === store || r.borrower === store));
        this.displayResults(store || "全店舗");
    }

    showAllData() { this.searchResults = [...this.data]; this.displayResults("全店舗"); }
    searchCorrections() { const store = document.getElementById('store-name').value; this.searchResults = this.data.filter(r => r.correction && (!store || r.lender === store || r.borrower === store)); this.displayResults(`${store || '全店舗'}の修正データ`); }
    
    displayResults(title) {
        document.getElementById('results-section').style.display = 'block';
        document.getElementById('details-title').textContent = `${title}の取引詳細`;
        this.updateDetailsTable();
    }

    updateDetailsTable() {
        const tbody = document.getElementById('details-table');
        const store = document.getElementById('store-name').value;
        
        if (this.searchResults.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="no-results">該当データがありません</td></tr>';
            return;
        }

        tbody.innerHTML = this.searchResults.map(row => {
            const isLender = row.lender === store;
            const type = !store ? '貸借' : (isLender ? '貸出' : '借入');
            const counterpart = !store ? `${row.lender} → ${row.borrower}` : (isLender ? row.borrower : row.lender);
            const amountClass = !store ? '' : (isLender ? 'positive' : 'negative');
            
            return `<tr class="data-row" data-row-index="${row.originalRowIndex}" title="クリックして修正">
                <td>${row.date}</td>
                <td><span class="type-tag type-${type}">${type}</span></td>
                <td>${counterpart}</td>
                <td>${row.item}</td>
                <td>${row.quantity || ''}</td>
                <td>${row.category}</td>
                <td class="amount ${amountClass}">¥${row.amount.toLocaleString()}</td>
                <td>${row.name}</td>
                <td>${row.correction}</td>
            </tr>`;
        }).join('');
        this.addRowClickEvents();
    }

    addRowClickEvents() {
        // tbody 全体に1回だけイベント委譲（再描画・ソート後も有効）
        const tbody = document.getElementById('details-table');
        if (!tbody || tbody.__rowClickBound) return;
        tbody.__rowClickBound = true;
        tbody.addEventListener('click', (ev) => {
            const row = ev.target.closest('.data-row');
            if (!row) return;
            const index = Number(row.dataset.rowIndex || row.getAttribute('data-row-index'));
            if (Number.isNaN(index)) return;
            const selected = this.data && this.data.find(d => d.originalRowIndex === index);
            if (selected) this.showCorrectionConfirm(selected);
        });
    }

    showCorrectionConfirm(data) {
        const modal = document.getElementById('confirm-modal-overlay');
        
        // 先にポップアップを表示する
        modal.classList.remove('hidden');
        modal.classList.add('show');

        // その他の要素を取得
        const msgContainer = document.getElementById('confirm-modal-message');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        // ポップアップの内容を生成
        msgContainer.innerHTML = `
            <p>以下のデータを逆取引として修正しますか？</p>
            <div class="correction-details-grid">
                <div class="grid-item-label">日付:</div><div class="grid-item-value">${data.date}</div>
                <div class="grid-item-label">入力者:</div><div class="grid-item-value">${data.name}</div>
                <div class="grid-item-label">貸主:</div><div class="grid-item-value">${data.lender}</div>
                <div class="grid-item-label">借主:</div><div class="grid-item-value">${data.borrower}</div>
                <div class="grid-item-label">カテゴリー:</div><div class="grid-item-value">${data.category}</div>
                <div class="grid-item-label">品目:</div><div class="grid-item-value">${data.item}</div>
                <div class="grid-item-label">個/本:</div><div class="grid-item-value">${data.quantity}</div>
                <div class="grid-item-label">金額:</div><div class="grid-item-value">¥${data.amount.toLocaleString()}</div>
                <div class="grid-item-label">入力日時:</div><div class="grid-item-value">${data.inputDate}</div>
                <div class="grid-item-label">既存の修正:</div><div class="grid-item-value">${data.correction || 'なし'}</div>
            </div>
        `;
        
        // ボタンの動作を設定
        confirmBtn.onclick = () => {
            modal.classList.remove('show');
            modal.classList.add('hidden');
            this.redirectToCorrectionPage(data);
        };

        cancelBtn.onclick = () => {
            modal.classList.remove('show');
            modal.classList.add('hidden');
        };
    }
    
    redirectToCorrectionPage(data) {
        try {
            // セッション（同一タブ）
            sessionStorage.setItem('correctionData', JSON.stringify(data));
            // URLクエリにも埋め込む（新規タブ/リロード対策）
            const encoded = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(data)))));
            const to = (location.pathname.includes('/data/')) ? '../correction.html?d=' + encoded : 'correction.html?d=' + encoded;
            window.location.href = to;
        } catch (e) {
            console.error('redirectToCorrectionPage error:', e);
            alert('遷移時にエラーが発生しました。もう一度お試しください。');
        }
    }
    
    exportResults() {
        if (this.searchResults.length === 0) { alert('エクスポートするデータがありません'); return; }
        const csv = Papa.unparse(this.searchResults.map(r => ({'日付': r.date,'名前': r.name,'貸主': r.lender,'借主': r.borrower,'カテゴリー': r.category,'品目': r.item,'個/本': r.quantity,'金額': r.amount,'入力日時': r.inputDate,'修正': r.correction})));
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `検索結果_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }
}

document.addEventListener('DOMContentLoaded', () => { new PasswordAuth(); });
</script>
</body>
</html>
